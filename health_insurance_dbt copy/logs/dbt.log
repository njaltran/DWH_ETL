[0m13:04:22.517600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10792ae40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ea3890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ea3b10>]}


============================== 13:04:22.520802 | 6261db71-753e-44c7-9aa5-b754f101e810 ==============================
[0m13:04:22.520802 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:04:22.521145 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'use_colors': 'True', 'partial_parse': 'True', 'warn_error': 'None', 'fail_fast': 'False', 'log_format': 'default', 'write_json': 'True', 'introspect': 'True', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'debug': 'False', 'profiles_dir': '/Users/nikolasjackaltran/.dbt', 'quiet': 'False', 'target_path': 'None', 'invocation_command': 'dbt debug', 'cache_selected_only': 'False', 'version_check': 'True', 'empty': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_cache_events': 'False', 'static_parser': 'True', 'printer_width': '80', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs'}
[0m13:04:22.531968 [info ] [MainThread]: dbt version: 1.11.2
[0m13:04:22.532270 [info ] [MainThread]: python version: 3.13.5
[0m13:04:22.532436 [info ] [MainThread]: python path: /opt/anaconda3/bin/python3.13
[0m13:04:22.532572 [info ] [MainThread]: os info: macOS-26.0.1-arm64-arm-64bit-Mach-O
[0m13:04:22.532713 [info ] [MainThread]: Using profiles dir at /Users/nikolasjackaltran/.dbt
[0m13:04:22.532830 [info ] [MainThread]: Using profiles.yml file at /Users/nikolasjackaltran/.dbt/profiles.yml
[0m13:04:22.532942 [info ] [MainThread]: Using dbt_project.yml file at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/dbt_project.yml
[0m13:04:22.598740 [info ] [MainThread]: Configuration:
[0m13:04:22.599058 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m13:04:22.599207 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m13:04:22.599333 [info ] [MainThread]: Required dependencies:
[0m13:04:22.599547 [debug] [MainThread]: Executing "git --help"
[0m13:04:22.630456 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--no-lazy-fetch]\n           [--no-optional-locks] [--no-advice] [--bare] [--git-dir=<path>]\n           [--work-tree=<path>] [--namespace=<name>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m13:04:22.630982 [debug] [MainThread]: STDERR: "b''"
[0m13:04:22.631177 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m13:04:22.631328 [info ] [MainThread]: Connection test skipped since no profile was found
[0m13:04:22.631472 [info ] [MainThread]: [31m1 check failed:[0m
[0m13:04:22.631628 [info ] [MainThread]: dbt looked for a profiles.yml file in /Users/nikolasjackaltran/.dbt/profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m13:04:22.634212 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 0.1689797, "process_in_blocks": "0", "process_kernel_time": 0.199127, "process_mem_max_rss": "124321792", "process_out_blocks": "0", "process_user_time": 0.830159}
[0m13:04:22.634578 [debug] [MainThread]: Command `dbt debug` failed at 13:04:22.634518 after 0.17 seconds
[0m13:04:22.634841 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1081fe8b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10906bd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109089e10>]}
[0m13:04:22.635051 [debug] [MainThread]: Flushing usage events
[0m13:04:23.936557 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:06:47.235186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085d2e40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b4b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b4bb10>]}


============================== 13:06:47.238615 | 14515c07-aabf-410c-b344-791b92e09074 ==============================
[0m13:06:47.238615 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:06:47.238951 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True', 'target_path': 'None', 'printer_width': '80', 'cache_selected_only': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'fail_fast': 'False', 'empty': 'None', 'use_colors': 'True', 'introspect': 'True', 'write_json': 'True', 'invocation_command': 'dbt debug', 'static_parser': 'True', 'quiet': 'False', 'use_experimental_parser': 'False', 'no_print': 'None', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml', 'log_format': 'default', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'log_cache_events': 'False', 'debug': 'False', 'indirect_selection': 'eager'}
[0m13:06:47.249724 [info ] [MainThread]: dbt version: 1.11.2
[0m13:06:47.249963 [info ] [MainThread]: python version: 3.13.5
[0m13:06:47.250105 [info ] [MainThread]: python path: /opt/anaconda3/bin/python3.13
[0m13:06:47.250239 [info ] [MainThread]: os info: macOS-26.0.1-arm64-arm-64bit-Mach-O
[0m13:06:47.250378 [info ] [MainThread]: Using profiles dir at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml
[0m13:06:47.250499 [info ] [MainThread]: Using profiles.yml file at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml/profiles.yml
[0m13:06:47.250622 [info ] [MainThread]: Using dbt_project.yml file at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/dbt_project.yml
[0m13:06:47.316060 [info ] [MainThread]: Configuration:
[0m13:06:47.316327 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m13:06:47.316469 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m13:06:47.316592 [info ] [MainThread]: Required dependencies:
[0m13:06:47.316773 [debug] [MainThread]: Executing "git --help"
[0m13:06:47.334309 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--no-lazy-fetch]\n           [--no-optional-locks] [--no-advice] [--bare] [--git-dir=<path>]\n           [--work-tree=<path>] [--namespace=<name>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m13:06:47.334823 [debug] [MainThread]: STDERR: "b''"
[0m13:06:47.335001 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m13:06:47.335157 [info ] [MainThread]: Connection test skipped since no profile was found
[0m13:06:47.335301 [info ] [MainThread]: [31m1 check failed:[0m
[0m13:06:47.335426 [info ] [MainThread]: dbt looked for a profiles.yml file in /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml/profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m13:06:47.337830 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 0.1508007, "process_in_blocks": "0", "process_kernel_time": 0.192225, "process_mem_max_rss": "125042688", "process_out_blocks": "0", "process_user_time": 0.824851}
[0m13:06:47.338221 [debug] [MainThread]: Command `dbt debug` failed at 13:06:47.338164 after 0.15 seconds
[0m13:06:47.338519 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ea4050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d13d10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d31e10>]}
[0m13:06:47.338857 [debug] [MainThread]: Flushing usage events
[0m13:06:47.848785 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:06:55.262317 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1082aee40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109827890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109827b10>]}


============================== 13:06:55.269392 | 6ac7f2ac-77be-43c7-bd06-2710053cc48e ==============================
[0m13:06:55.269392 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:06:55.270108 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'quiet': 'False', 'printer_width': '80', 'write_json': 'True', 'warn_error': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'empty': 'None', 'use_colors': 'True', 'partial_parse': 'True', 'debug': 'False', 'cache_selected_only': 'False', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml', 'log_format': 'default', 'no_print': 'None', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'fail_fast': 'False', 'version_check': 'True', 'invocation_command': 'dbt debug', 'target_path': 'None'}
[0m13:06:55.281212 [info ] [MainThread]: dbt version: 1.11.2
[0m13:06:55.281479 [info ] [MainThread]: python version: 3.13.5
[0m13:06:55.281629 [info ] [MainThread]: python path: /opt/anaconda3/bin/python3.13
[0m13:06:55.281759 [info ] [MainThread]: os info: macOS-26.0.1-arm64-arm-64bit-Mach-O
[0m13:06:55.281900 [info ] [MainThread]: Using profiles dir at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml
[0m13:06:55.282023 [info ] [MainThread]: Using profiles.yml file at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml/profiles.yml
[0m13:06:55.282138 [info ] [MainThread]: Using dbt_project.yml file at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/dbt_project.yml
[0m13:06:55.349465 [info ] [MainThread]: Configuration:
[0m13:06:55.349741 [info ] [MainThread]:   profiles.yml file [[31mERROR not found[0m]
[0m13:06:55.349921 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m13:06:55.350105 [info ] [MainThread]: Required dependencies:
[0m13:06:55.350312 [debug] [MainThread]: Executing "git --help"
[0m13:06:55.359621 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--no-lazy-fetch]\n           [--no-optional-locks] [--no-advice] [--bare] [--git-dir=<path>]\n           [--work-tree=<path>] [--namespace=<name>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m13:06:55.360175 [debug] [MainThread]: STDERR: "b''"
[0m13:06:55.360360 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m13:06:55.360509 [info ] [MainThread]: Connection test skipped since no profile was found
[0m13:06:55.360646 [info ] [MainThread]: [31m1 check failed:[0m
[0m13:06:55.360768 [info ] [MainThread]: dbt looked for a profiles.yml file in /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml/profiles.yml, but did
not find one. For more information on configuring your profile, consult the
documentation:

https://docs.getdbt.com/docs/configure-your-profile


[0m13:06:55.362667 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": false, "command_wall_clock_time": 0.14369084, "process_in_blocks": "0", "process_kernel_time": 0.152566, "process_mem_max_rss": "125468672", "process_out_blocks": "0", "process_user_time": 0.847909}
[0m13:06:55.363048 [debug] [MainThread]: Command `dbt debug` failed at 13:06:55.362981 after 0.14 seconds
[0m13:06:55.363430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b80050>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099efd10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a0de10>]}
[0m13:06:55.363743 [debug] [MainThread]: Flushing usage events
[0m13:06:55.839771 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:07:08.493466 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106412e40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10798b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10798bb10>]}


============================== 13:07:08.496638 | 4e10a03f-1d40-4ff4-ad33-258474259dcf ==============================
[0m13:07:08.496638 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:07:08.496963 [debug] [MainThread]: running dbt with arguments {'empty': 'None', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'write_json': 'True', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'invocation_command': 'dbt debug', 'static_parser': 'True', 'no_print': 'None', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'warn_error': 'None', 'introspect': 'True', 'indirect_selection': 'eager', 'fail_fast': 'False', 'target_path': 'None', 'cache_selected_only': 'False', 'use_colors': 'True', 'printer_width': '80', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'quiet': 'False', 'partial_parse': 'True', 'version_check': 'True', 'log_format': 'default'}
[0m13:07:08.509358 [info ] [MainThread]: dbt version: 1.11.2
[0m13:07:08.509634 [info ] [MainThread]: python version: 3.13.5
[0m13:07:08.509957 [info ] [MainThread]: python path: /opt/anaconda3/bin/python3.13
[0m13:07:08.510318 [info ] [MainThread]: os info: macOS-26.0.1-arm64-arm-64bit-Mach-O
[0m13:07:21.146963 [info ] [MainThread]: Using profiles dir at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt
[0m13:07:21.147464 [info ] [MainThread]: Using profiles.yml file at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/profiles.yml
[0m13:07:21.147651 [info ] [MainThread]: Using dbt_project.yml file at /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/dbt_project.yml
[0m13:07:21.147800 [info ] [MainThread]: adapter type: bigquery
[0m13:07:21.147938 [info ] [MainThread]: adapter version: 1.11.0
[0m13:07:21.220670 [info ] [MainThread]: Configuration:
[0m13:07:21.220961 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m13:07:21.221112 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m13:07:21.221242 [info ] [MainThread]: Required dependencies:
[0m13:07:21.221476 [debug] [MainThread]: Executing "git --help"
[0m13:07:21.253945 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--no-lazy-fetch]\n           [--no-optional-locks] [--no-advice] [--bare] [--git-dir=<path>]\n           [--work-tree=<path>] [--namespace=<name>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m13:07:21.254579 [debug] [MainThread]: STDERR: "b''"
[0m13:07:21.254779 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m13:07:21.254962 [info ] [MainThread]: Connection:
[0m13:07:21.255247 [info ] [MainThread]:   method: oauth
[0m13:07:21.255445 [info ] [MainThread]:   database: dw-health-insurance-bipm
[0m13:07:21.255591 [info ] [MainThread]:   execution_project: dw-health-insurance-bipm
[0m13:07:21.255718 [info ] [MainThread]:   schema: health_insurance_dev
[0m13:07:21.255936 [info ] [MainThread]:   location: EU
[0m13:07:21.256121 [info ] [MainThread]:   priority: interactive
[0m13:07:21.256257 [info ] [MainThread]:   maximum_bytes_billed: None
[0m13:07:21.256385 [info ] [MainThread]:   impersonate_service_account: None
[0m13:07:21.256511 [info ] [MainThread]:   job_retry_deadline_seconds: None
[0m13:07:21.256623 [info ] [MainThread]:   job_retries: 1
[0m13:07:21.256739 [info ] [MainThread]:   job_creation_timeout_seconds: None
[0m13:07:21.256851 [info ] [MainThread]:   job_execution_timeout_seconds: 300
[0m13:07:21.256959 [info ] [MainThread]:   timeout_seconds: 300
[0m13:07:21.257070 [info ] [MainThread]:   client_id: None
[0m13:07:21.257179 [info ] [MainThread]:   token_uri: None
[0m13:07:21.257288 [info ] [MainThread]:   compute_region: None
[0m13:07:21.257392 [info ] [MainThread]:   dataproc_cluster_name: None
[0m13:07:21.257498 [info ] [MainThread]:   gcs_bucket: None
[0m13:07:21.257605 [info ] [MainThread]:   dataproc_batch: None
[0m13:07:21.257991 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m13:07:21.396512 [debug] [MainThread]: Acquiring new bigquery connection 'debug'
[0m13:07:21.396941 [debug] [MainThread]: On debug: select 1 as id
[0m13:07:21.397143 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:07:25.308602 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:766e137e-4c0b-418b-9d96-ac9dfd433a06&page=queryresults
[0m13:07:26.018623 [debug] [MainThread]: SQL status: OK in 0.708 seconds
[0m13:07:26.598288 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m13:07:26.603671 [info ] [MainThread]: [32mAll checks passed![0m
[0m13:07:26.605676 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 18.15727, "process_in_blocks": "0", "process_kernel_time": 4.927232, "process_mem_max_rss": "445218816", "process_out_blocks": "0", "process_user_time": 9.189399}
[0m13:07:26.606919 [debug] [MainThread]: Command `dbt debug` succeeded at 13:07:26.606625 after 18.16 seconds
[0m13:07:26.608057 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m13:07:26.608977 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12b14fe10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12b2c2210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12b0b5bf0>]}
[0m13:07:26.611017 [debug] [MainThread]: Flushing usage events
[0m13:07:30.122975 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:07:34.810621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b8eae40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db93890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10db93b10>]}


============================== 13:07:34.814012 | 0a2ffd92-d455-438e-9966-fb659a026aa9 ==============================
[0m13:07:34.814012 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:07:34.814357 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'static_parser': 'True', 'quiet': 'False', 'log_format': 'default', 'fail_fast': 'False', 'no_print': 'None', 'write_json': 'True', 'empty': 'None', 'invocation_command': 'dbt parse', 'introspect': 'True', 'printer_width': '80', 'indirect_selection': 'eager', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'warn_error': 'None', 'partial_parse': 'True', 'version_check': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'debug': 'False'}
[0m13:07:48.200431 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a2ffd92-d455-438e-9966-fb659a026aa9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bbee8b0>]}
[0m13:07:48.239073 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a2ffd92-d455-438e-9966-fb659a026aa9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a741370>]}
[0m13:07:48.239417 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m13:07:48.367066 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m13:07:48.367577 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m13:07:48.367778 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '0a2ffd92-d455-438e-9966-fb659a026aa9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168ce9250>]}
[0m13:07:49.033733 [warn ] [MainThread]: [[33mWARNING[0m][MissingArgumentsPropertyInGenericTestDeprecation]: Deprecated
functionality
Found top-level arguments to test `accepted_values` defined on 'dim_person' in
package 'health_insurance_dbt' (models/core/schema.yml). Arguments to generic
tests should be nested under the `arguments` property.
[0m13:07:49.034048 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '0a2ffd92-d455-438e-9966-fb659a026aa9', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16d8ac230>]}
[0m13:07:49.159154 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a2ffd92-d455-438e-9966-fb659a026aa9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16d89c130>]}
[0m13:07:49.161135 [info ] [MainThread]: Performance info: /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/perf_info.json
[0m13:07:49.207810 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m13:07:49.208992 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m13:07:49.209304 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- MissingArgumentsPropertyInGenericTestDeprecation: 13 occurrences
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m13:07:49.209614 [debug] [MainThread]: Resource report: {"command_name": "parse", "command_success": true, "command_wall_clock_time": 14.447809, "process_in_blocks": "0", "process_kernel_time": 5.578758, "process_mem_max_rss": "442548224", "process_out_blocks": "0", "process_user_time": 10.142734}
[0m13:07:49.209863 [debug] [MainThread]: Command `dbt parse` succeeded at 13:07:49.209806 after 14.45 seconds
[0m13:07:49.210051 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16b2e5cc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dbd5550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16bbaf290>]}
[0m13:07:49.210222 [debug] [MainThread]: Flushing usage events
[0m13:07:49.671015 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:08:09.435699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a6ee40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fe7890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108fe7b10>]}


============================== 13:08:09.439914 | dafd85da-bb57-4033-bb97-255a0afedd27 ==============================
[0m13:08:09.439914 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:08:09.440273 [debug] [MainThread]: running dbt with arguments {'use_experimental_parser': 'False', 'write_json': 'True', 'fail_fast': 'False', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'log_format': 'default', 'use_colors': 'True', 'empty': 'False', 'warn_error': 'None', 'invocation_command': 'dbt compile', 'printer_width': '80', 'no_print': 'None', 'partial_parse': 'True', 'log_cache_events': 'False', 'target_path': 'None', 'version_check': 'True', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'quiet': 'False'}
[0m13:08:22.558933 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'dafd85da-bb57-4033-bb97-255a0afedd27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083428b0>]}
[0m13:08:22.598930 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'dafd85da-bb57-4033-bb97-255a0afedd27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078c5370>]}
[0m13:08:22.599364 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m13:08:22.722552 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m13:08:22.825955 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:08:22.826217 [debug] [MainThread]: Nothing changed, skipping partial parsing.
[0m13:08:22.826354 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:08:22.850266 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'dafd85da-bb57-4033-bb97-255a0afedd27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15805d250>]}
[0m13:08:22.896995 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m13:08:22.898306 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m13:08:22.913289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'dafd85da-bb57-4033-bb97-255a0afedd27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15956a3f0>]}
[0m13:08:22.913603 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m13:08:22.913789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dafd85da-bb57-4033-bb97-255a0afedd27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1596e6dd0>]}
[0m13:08:22.915255 [info ] [MainThread]: 
[0m13:08:22.915444 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m13:08:22.915578 [info ] [MainThread]: 
[0m13:08:22.915819 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:08:22.917902 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm_health_insurance_dev_staging'
[0m13:08:22.918141 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:08:22.918367 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm_health_insurance_dev'
[0m13:08:22.918668 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm_health_insurance_dev_marts'
[0m13:08:22.918910 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm_health_insurance_dev_core'
[0m13:08:22.919073 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:08:22.919268 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:08:22.919426 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:08:25.511148 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'dafd85da-bb57-4033-bb97-255a0afedd27', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x159720ef0>]}
[0m13:08:25.512956 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:08:25.519608 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m13:08:25.520146 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:08:25.520680 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_person_dim_raw)
[0m13:08:25.521095 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m13:08:25.521472 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m13:08:25.521791 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:08:25.533990 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m13:08:25.538022 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m13:08:25.540011 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:08:25.540507 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m13:08:25.540951 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.541303 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.542152 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:08:25.542811 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m13:08:25.543442 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_year.fed93bffd2
[0m13:08:25.543896 [debug] [Thread-3 (]: Began running node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_person_id.97df01f49d
[0m13:08:25.544303 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now test.health_insurance_dbt.not_null_stg_insurance_facts_raw_year.fed93bffd2)
[0m13:08:25.544654 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m13:08:25.544953 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m13:08:25.545295 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now test.health_insurance_dbt.not_null_stg_insurance_facts_raw_person_id.97df01f49d)
[0m13:08:25.545639 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_year.fed93bffd2
[0m13:08:25.545982 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.int_person_cleaned)
[0m13:08:25.546312 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_person_dim_raw, now model.health_insurance_dbt.int_person_deduped)
[0m13:08:25.546625 [debug] [Thread-3 (]: Began compiling node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_person_id.97df01f49d
[0m13:08:25.558344 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_stg_insurance_facts_raw_year.fed93bffd2"
[0m13:08:25.558766 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m13:08:25.559067 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m13:08:25.562065 [debug] [Thread-3 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_stg_insurance_facts_raw_person_id.97df01f49d"
[0m13:08:25.565128 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m13:08:25.568319 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m13:08:25.568855 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_year.fed93bffd2
[0m13:08:25.569134 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.569902 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_year.fed93bffd2
[0m13:08:25.570235 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.not_null_stg_person_dim_raw_person_id.10f204c2cd
[0m13:08:25.570567 [debug] [Thread-3 (]: Began executing node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_person_id.97df01f49d
[0m13:08:25.570818 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_stg_insurance_facts_raw_year.fed93bffd2, now test.health_insurance_dbt.not_null_stg_person_dim_raw_person_id.10f204c2cd)
[0m13:08:25.571104 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.571345 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.571545 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.571743 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.not_null_stg_person_dim_raw_person_id.10f204c2cd
[0m13:08:25.572207 [debug] [Thread-3 (]: Finished running node test.health_insurance_dbt.not_null_stg_insurance_facts_raw_person_id.97df01f49d
[0m13:08:25.572626 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m13:08:25.573018 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m13:08:25.575479 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_stg_person_dim_raw_person_id.10f204c2cd"
[0m13:08:25.576032 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.dim_person
[0m13:08:25.576262 [debug] [Thread-1 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_cleaned_gender_std__male__female__unknown.9e4b1d4dde
[0m13:08:25.576487 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_cleaned_family_status_std__single__married__divorced__widowed__unknown.c93d245c77
[0m13:08:25.576714 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_stg_insurance_facts_raw_person_id.97df01f49d, now model.health_insurance_dbt.dim_person)
[0m13:08:25.576956 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_cleaned, now test.health_insurance_dbt.accepted_values_int_person_cleaned_gender_std__male__female__unknown.9e4b1d4dde)
[0m13:08:25.577187 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_deduped, now test.health_insurance_dbt.accepted_values_int_person_cleaned_family_status_std__single__married__divorced__widowed__unknown.c93d245c77)
[0m13:08:25.577400 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.not_null_stg_person_dim_raw_person_id.10f204c2cd
[0m13:08:25.577593 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m13:08:25.577797 [debug] [Thread-1 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_cleaned_gender_std__male__female__unknown.9e4b1d4dde
[0m13:08:25.577996 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_cleaned_family_status_std__single__married__divorced__widowed__unknown.c93d245c77
[0m13:08:25.578205 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.584642 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m13:08:25.596340 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.not_null_stg_person_dim_raw_person_id.10f204c2cd
[0m13:08:25.596831 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_cleaned_family_status_std__single__married__divorced__widowed__unknown.c93d245c77"
[0m13:08:25.599811 [debug] [Thread-1 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_cleaned_gender_std__male__female__unknown.9e4b1d4dde"
[0m13:08:25.600096 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_cleaned_insurance_status_std__active__inactive__pending__unknown.ebf8056693
[0m13:08:25.600442 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_stg_person_dim_raw_person_id.10f204c2cd, now test.health_insurance_dbt.accepted_values_int_person_cleaned_insurance_status_std__active__inactive__pending__unknown.ebf8056693)
[0m13:08:25.600661 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_cleaned_insurance_status_std__active__inactive__pending__unknown.ebf8056693
[0m13:08:25.605006 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_cleaned_insurance_status_std__active__inactive__pending__unknown.ebf8056693"
[0m13:08:25.605522 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.dim_person
[0m13:08:25.605705 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_cleaned_family_status_std__single__married__divorced__widowed__unknown.c93d245c77
[0m13:08:25.605886 [debug] [Thread-1 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_cleaned_gender_std__male__female__unknown.9e4b1d4dde
[0m13:08:25.606063 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.606310 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.606487 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.606876 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.dim_person
[0m13:08:25.607033 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_cleaned_insurance_status_std__active__inactive__pending__unknown.ebf8056693
[0m13:08:25.607344 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_cleaned_family_status_std__single__married__divorced__widowed__unknown.c93d245c77
[0m13:08:25.607648 [debug] [Thread-1 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_cleaned_gender_std__male__female__unknown.9e4b1d4dde
[0m13:08:25.607829 [debug] [Thread-3 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_cleaned_wealth_bracket_std__low__medium__upper_middle__high__unknown.db07393a60
[0m13:08:25.608028 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.608234 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_deduped_family_status_std__single__married__divorced__widowed__unknown.c6ce8a7436
[0m13:08:25.608408 [debug] [Thread-1 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_deduped_gender_std__male__female__unknown.30faa972a8
[0m13:08:25.608583 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.dim_person, now test.health_insurance_dbt.accepted_values_int_person_cleaned_wealth_bracket_std__low__medium__upper_middle__high__unknown.db07393a60)
[0m13:08:25.608925 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_cleaned_insurance_status_std__active__inactive__pending__unknown.ebf8056693
[0m13:08:25.609090 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_cleaned_family_status_std__single__married__divorced__widowed__unknown.c93d245c77, now test.health_insurance_dbt.accepted_values_int_person_deduped_family_status_std__single__married__divorced__widowed__unknown.c6ce8a7436)
[0m13:08:25.609268 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_cleaned_gender_std__male__female__unknown.9e4b1d4dde, now test.health_insurance_dbt.accepted_values_int_person_deduped_gender_std__male__female__unknown.30faa972a8)
[0m13:08:25.609440 [debug] [Thread-3 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_cleaned_wealth_bracket_std__low__medium__upper_middle__high__unknown.db07393a60
[0m13:08:25.609606 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_deduped_insurance_status_std__active__inactive__pending__unknown.12630ab68b
[0m13:08:25.609766 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_deduped_family_status_std__single__married__divorced__widowed__unknown.c6ce8a7436
[0m13:08:25.609912 [debug] [Thread-1 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_deduped_gender_std__male__female__unknown.30faa972a8
[0m13:08:25.614627 [debug] [Thread-3 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_cleaned_wealth_bracket_std__low__medium__upper_middle__high__unknown.db07393a60"
[0m13:08:25.614830 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_cleaned_insurance_status_std__active__inactive__pending__unknown.ebf8056693, now test.health_insurance_dbt.accepted_values_int_person_deduped_insurance_status_std__active__inactive__pending__unknown.12630ab68b)
[0m13:08:25.617830 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_deduped_family_status_std__single__married__divorced__widowed__unknown.c6ce8a7436"
[0m13:08:25.620978 [debug] [Thread-1 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_deduped_gender_std__male__female__unknown.30faa972a8"
[0m13:08:25.621200 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_deduped_insurance_status_std__active__inactive__pending__unknown.12630ab68b
[0m13:08:25.624229 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_deduped_insurance_status_std__active__inactive__pending__unknown.12630ab68b"
[0m13:08:25.624773 [debug] [Thread-3 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_cleaned_wealth_bracket_std__low__medium__upper_middle__high__unknown.db07393a60
[0m13:08:25.624967 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.625331 [debug] [Thread-3 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_cleaned_wealth_bracket_std__low__medium__upper_middle__high__unknown.db07393a60
[0m13:08:25.625507 [debug] [Thread-3 (]: Began running node test.health_insurance_dbt.accepted_values_int_person_deduped_wealth_bracket_std__low__medium__upper_middle__high__unknown.cb5006107a
[0m13:08:25.625670 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_cleaned_wealth_bracket_std__low__medium__upper_middle__high__unknown.db07393a60, now test.health_insurance_dbt.accepted_values_int_person_deduped_wealth_bracket_std__low__medium__upper_middle__high__unknown.cb5006107a)
[0m13:08:25.625830 [debug] [Thread-3 (]: Began compiling node test.health_insurance_dbt.accepted_values_int_person_deduped_wealth_bracket_std__low__medium__upper_middle__high__unknown.cb5006107a
[0m13:08:25.629133 [debug] [Thread-3 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_int_person_deduped_wealth_bracket_std__low__medium__upper_middle__high__unknown.cb5006107a"
[0m13:08:25.629362 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_deduped_family_status_std__single__married__divorced__widowed__unknown.c6ce8a7436
[0m13:08:25.629527 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_deduped_insurance_status_std__active__inactive__pending__unknown.12630ab68b
[0m13:08:25.629689 [debug] [Thread-1 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_deduped_gender_std__male__female__unknown.30faa972a8
[0m13:08:25.629847 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.630088 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.630240 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.630387 [debug] [Thread-3 (]: Began executing node test.health_insurance_dbt.accepted_values_int_person_deduped_wealth_bracket_std__low__medium__upper_middle__high__unknown.cb5006107a
[0m13:08:25.630717 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_deduped_family_status_std__single__married__divorced__widowed__unknown.c6ce8a7436
[0m13:08:25.631029 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_deduped_insurance_status_std__active__inactive__pending__unknown.12630ab68b
[0m13:08:25.631335 [debug] [Thread-1 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_deduped_gender_std__male__female__unknown.30faa972a8
[0m13:08:25.631501 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.631665 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.not_null_int_person_cleaned_person_id.ed1b7eb614
[0m13:08:25.631834 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.not_null_int_person_deduped_person_id.8b921af1e9
[0m13:08:25.631987 [debug] [Thread-1 (]: Began running node test.health_insurance_dbt.unique_int_person_deduped_person_id.48e5648e9c
[0m13:08:25.632284 [debug] [Thread-3 (]: Finished running node test.health_insurance_dbt.accepted_values_int_person_deduped_wealth_bracket_std__low__medium__upper_middle__high__unknown.cb5006107a
[0m13:08:25.632441 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_deduped_family_status_std__single__married__divorced__widowed__unknown.c6ce8a7436, now test.health_insurance_dbt.not_null_int_person_cleaned_person_id.ed1b7eb614)
[0m13:08:25.632611 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_deduped_insurance_status_std__active__inactive__pending__unknown.12630ab68b, now test.health_insurance_dbt.not_null_int_person_deduped_person_id.8b921af1e9)
[0m13:08:25.632776 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_deduped_gender_std__male__female__unknown.30faa972a8, now test.health_insurance_dbt.unique_int_person_deduped_person_id.48e5648e9c)
[0m13:08:25.632946 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m13:08:25.633107 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.not_null_int_person_cleaned_person_id.ed1b7eb614
[0m13:08:25.633275 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.not_null_int_person_deduped_person_id.8b921af1e9
[0m13:08:25.633450 [debug] [Thread-1 (]: Began compiling node test.health_insurance_dbt.unique_int_person_deduped_person_id.48e5648e9c
[0m13:08:25.633654 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_int_person_deduped_wealth_bracket_std__low__medium__upper_middle__high__unknown.cb5006107a, now model.health_insurance_dbt.fact_insurance_yearly)
[0m13:08:25.636177 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_int_person_cleaned_person_id.ed1b7eb614"
[0m13:08:25.638212 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_int_person_deduped_person_id.8b921af1e9"
[0m13:08:25.642262 [debug] [Thread-1 (]: Writing injected SQL for node "test.health_insurance_dbt.unique_int_person_deduped_person_id.48e5648e9c"
[0m13:08:25.642452 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.fact_insurance_yearly
[0m13:08:25.646110 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m13:08:25.646810 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.not_null_int_person_deduped_person_id.8b921af1e9
[0m13:08:25.646972 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.647315 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.not_null_int_person_deduped_person_id.8b921af1e9
[0m13:08:25.647476 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.accepted_values_dim_person_family_status__single__married__divorced__widowed__unknown.6312b97778
[0m13:08:25.647625 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_int_person_deduped_person_id.8b921af1e9, now test.health_insurance_dbt.accepted_values_dim_person_family_status__single__married__divorced__widowed__unknown.6312b97778)
[0m13:08:25.647769 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.accepted_values_dim_person_family_status__single__married__divorced__widowed__unknown.6312b97778
[0m13:08:25.649567 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_dim_person_family_status__single__married__divorced__widowed__unknown.6312b97778"
[0m13:08:25.649759 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.not_null_int_person_cleaned_person_id.ed1b7eb614
[0m13:08:25.649958 [debug] [Thread-1 (]: Began executing node test.health_insurance_dbt.unique_int_person_deduped_person_id.48e5648e9c
[0m13:08:25.650112 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.fact_insurance_yearly
[0m13:08:25.650260 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.650417 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.650579 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.650928 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.not_null_int_person_cleaned_person_id.ed1b7eb614
[0m13:08:25.651525 [debug] [Thread-1 (]: Finished running node test.health_insurance_dbt.unique_int_person_deduped_person_id.48e5648e9c
[0m13:08:25.651685 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.accepted_values_dim_person_family_status__single__married__divorced__widowed__unknown.6312b97778
[0m13:08:25.652008 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m13:08:25.652172 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.accepted_values_dim_person_gender__male__female__unknown.5a6d1e68c1
[0m13:08:25.652352 [debug] [Thread-1 (]: Began running node test.health_insurance_dbt.accepted_values_dim_person_insurance_status__active__inactive__pending__unknown.310f18fc88
[0m13:08:25.652528 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.652697 [debug] [Thread-3 (]: Began running node test.health_insurance_dbt.accepted_values_dim_person_wealth_bracket__low__medium__upper_middle__high__unknown.1a97466e66
[0m13:08:25.652880 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_int_person_cleaned_person_id.ed1b7eb614, now test.health_insurance_dbt.accepted_values_dim_person_gender__male__female__unknown.5a6d1e68c1)
[0m13:08:25.653117 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.unique_int_person_deduped_person_id.48e5648e9c, now test.health_insurance_dbt.accepted_values_dim_person_insurance_status__active__inactive__pending__unknown.310f18fc88)
[0m13:08:25.653477 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.accepted_values_dim_person_family_status__single__married__divorced__widowed__unknown.6312b97778
[0m13:08:25.653647 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.fact_insurance_yearly, now test.health_insurance_dbt.accepted_values_dim_person_wealth_bracket__low__medium__upper_middle__high__unknown.1a97466e66)
[0m13:08:25.653805 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.accepted_values_dim_person_gender__male__female__unknown.5a6d1e68c1
[0m13:08:25.653960 [debug] [Thread-1 (]: Began compiling node test.health_insurance_dbt.accepted_values_dim_person_insurance_status__active__inactive__pending__unknown.310f18fc88
[0m13:08:25.654117 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.not_null_dim_person_person_id.28c5a93a94
[0m13:08:25.654266 [debug] [Thread-3 (]: Began compiling node test.health_insurance_dbt.accepted_values_dim_person_wealth_bracket__low__medium__upper_middle__high__unknown.1a97466e66
[0m13:08:25.655927 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_dim_person_gender__male__female__unknown.5a6d1e68c1"
[0m13:08:25.657608 [debug] [Thread-1 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_dim_person_insurance_status__active__inactive__pending__unknown.310f18fc88"
[0m13:08:25.657790 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_dim_person_family_status__single__married__divorced__widowed__unknown.6312b97778, now test.health_insurance_dbt.not_null_dim_person_person_id.28c5a93a94)
[0m13:08:25.659882 [debug] [Thread-3 (]: Writing injected SQL for node "test.health_insurance_dbt.accepted_values_dim_person_wealth_bracket__low__medium__upper_middle__high__unknown.1a97466e66"
[0m13:08:25.660321 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.not_null_dim_person_person_id.28c5a93a94
[0m13:08:25.662132 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_dim_person_person_id.28c5a93a94"
[0m13:08:25.662360 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.accepted_values_dim_person_gender__male__female__unknown.5a6d1e68c1
[0m13:08:25.662561 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.662719 [debug] [Thread-1 (]: Began executing node test.health_insurance_dbt.accepted_values_dim_person_insurance_status__active__inactive__pending__unknown.310f18fc88
[0m13:08:25.662886 [debug] [Thread-3 (]: Began executing node test.health_insurance_dbt.accepted_values_dim_person_wealth_bracket__low__medium__upper_middle__high__unknown.1a97466e66
[0m13:08:25.663240 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.accepted_values_dim_person_gender__male__female__unknown.5a6d1e68c1
[0m13:08:25.663436 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.663585 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.not_null_dim_person_person_id.28c5a93a94
[0m13:08:25.663730 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.663891 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.unique_dim_person_person_id.e5b246bf7d
[0m13:08:25.664216 [debug] [Thread-1 (]: Finished running node test.health_insurance_dbt.accepted_values_dim_person_insurance_status__active__inactive__pending__unknown.310f18fc88
[0m13:08:25.664367 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.664692 [debug] [Thread-3 (]: Finished running node test.health_insurance_dbt.accepted_values_dim_person_wealth_bracket__low__medium__upper_middle__high__unknown.1a97466e66
[0m13:08:25.664859 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_dim_person_gender__male__female__unknown.5a6d1e68c1, now test.health_insurance_dbt.unique_dim_person_person_id.e5b246bf7d)
[0m13:08:25.665038 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m13:08:25.665344 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.not_null_dim_person_person_id.28c5a93a94
[0m13:08:25.665503 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m13:08:25.665659 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.unique_dim_person_person_id.e5b246bf7d
[0m13:08:25.665818 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_dim_person_insurance_status__active__inactive__pending__unknown.310f18fc88, now model.health_insurance_dbt.mart_city_year_kpis)
[0m13:08:25.666227 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m13:08:25.666396 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.accepted_values_dim_person_wealth_bracket__low__medium__upper_middle__high__unknown.1a97466e66, now model.health_insurance_dbt.mart_person_kpis)
[0m13:08:25.668105 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.unique_dim_person_person_id.e5b246bf7d"
[0m13:08:25.668629 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.mart_city_year_kpis
[0m13:08:25.668790 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_dim_person_person_id.28c5a93a94, now model.health_insurance_dbt.mart_yearly_kpis)
[0m13:08:25.668957 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.mart_person_kpis
[0m13:08:25.670858 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m13:08:25.671039 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.mart_yearly_kpis
[0m13:08:25.672736 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_person_kpis"
[0m13:08:25.672931 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.unique_dim_person_person_id.e5b246bf7d
[0m13:08:25.674368 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m13:08:25.674585 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.675070 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.unique_dim_person_person_id.e5b246bf7d
[0m13:08:25.675251 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.negative_costs
[0m13:08:25.675407 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.mart_city_year_kpis
[0m13:08:25.675596 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.unique_dim_person_person_id.e5b246bf7d, now model.health_insurance_dbt.negative_costs)
[0m13:08:25.675759 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.mart_person_kpis
[0m13:08:25.675923 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.676075 [debug] [Thread-4 (]: Began executing node model.health_insurance_dbt.mart_yearly_kpis
[0m13:08:25.676210 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.negative_costs
[0m13:08:25.676359 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.676696 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m13:08:25.676849 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.678192 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.negative_costs"
[0m13:08:25.678552 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m13:08:25.678727 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m13:08:25.679064 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m13:08:25.679290 [debug] [Thread-3 (]: Began running node test.health_insurance_dbt.not_null_fact_insurance_yearly_person_id.43f04e2ffc
[0m13:08:25.679494 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.mart_city_year_kpis, now model.health_insurance_dbt.visits_reasonable)
[0m13:08:25.679705 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.not_null_fact_insurance_yearly_year.ef6a078a3c
[0m13:08:25.679931 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.mart_person_kpis, now test.health_insurance_dbt.not_null_fact_insurance_yearly_person_id.43f04e2ffc)
[0m13:08:25.680107 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.visits_reasonable
[0m13:08:25.680262 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.negative_costs
[0m13:08:25.680416 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.mart_yearly_kpis, now test.health_insurance_dbt.not_null_fact_insurance_yearly_year.ef6a078a3c)
[0m13:08:25.680578 [debug] [Thread-3 (]: Began compiling node test.health_insurance_dbt.not_null_fact_insurance_yearly_person_id.43f04e2ffc
[0m13:08:25.681977 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.visits_reasonable"
[0m13:08:25.682156 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.682317 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.not_null_fact_insurance_yearly_year.ef6a078a3c
[0m13:08:25.684289 [debug] [Thread-3 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_fact_insurance_yearly_person_id.43f04e2ffc"
[0m13:08:25.684872 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m13:08:25.686502 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_fact_insurance_yearly_year.ef6a078a3c"
[0m13:08:25.686756 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.relationships_fact_insurance_yearly_person_id__person_id__ref_dim_person_.759a8de8e7
[0m13:08:25.686967 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.visits_reasonable
[0m13:08:25.687161 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.negative_costs, now test.health_insurance_dbt.relationships_fact_insurance_yearly_person_id__person_id__ref_dim_person_.759a8de8e7)
[0m13:08:25.687332 [debug] [Thread-3 (]: Began executing node test.health_insurance_dbt.not_null_fact_insurance_yearly_person_id.43f04e2ffc
[0m13:08:25.687502 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.687647 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.not_null_fact_insurance_yearly_year.ef6a078a3c
[0m13:08:25.687802 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.relationships_fact_insurance_yearly_person_id__person_id__ref_dim_person_.759a8de8e7
[0m13:08:25.687962 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.688278 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m13:08:25.688432 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.693359 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.relationships_fact_insurance_yearly_person_id__person_id__ref_dim_person_.759a8de8e7"
[0m13:08:25.693740 [debug] [Thread-3 (]: Finished running node test.health_insurance_dbt.not_null_fact_insurance_yearly_person_id.43f04e2ffc
[0m13:08:25.693911 [debug] [Thread-1 (]: Began running node test.health_insurance_dbt.not_null_mart_city_year_kpis_city.673ebc9511
[0m13:08:25.694236 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.not_null_fact_insurance_yearly_year.ef6a078a3c
[0m13:08:25.694422 [debug] [Thread-3 (]: Began running node test.health_insurance_dbt.not_null_mart_city_year_kpis_persons_in_city.d72b53311d
[0m13:08:25.694595 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.visits_reasonable, now test.health_insurance_dbt.not_null_mart_city_year_kpis_city.673ebc9511)
[0m13:08:25.694777 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.not_null_mart_city_year_kpis_year.c44388c611
[0m13:08:25.694940 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_fact_insurance_yearly_person_id.43f04e2ffc, now test.health_insurance_dbt.not_null_mart_city_year_kpis_persons_in_city.d72b53311d)
[0m13:08:25.695115 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.relationships_fact_insurance_yearly_person_id__person_id__ref_dim_person_.759a8de8e7
[0m13:08:25.695245 [debug] [Thread-1 (]: Began compiling node test.health_insurance_dbt.not_null_mart_city_year_kpis_city.673ebc9511
[0m13:08:25.695391 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_fact_insurance_yearly_year.ef6a078a3c, now test.health_insurance_dbt.not_null_mart_city_year_kpis_year.c44388c611)
[0m13:08:25.695537 [debug] [Thread-3 (]: Began compiling node test.health_insurance_dbt.not_null_mart_city_year_kpis_persons_in_city.d72b53311d
[0m13:08:25.695687 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.697317 [debug] [Thread-1 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_mart_city_year_kpis_city.673ebc9511"
[0m13:08:25.697488 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.not_null_mart_city_year_kpis_year.c44388c611
[0m13:08:25.699129 [debug] [Thread-3 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_mart_city_year_kpis_persons_in_city.d72b53311d"
[0m13:08:25.699788 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.relationships_fact_insurance_yearly_person_id__person_id__ref_dim_person_.759a8de8e7
[0m13:08:25.701405 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_mart_city_year_kpis_year.c44388c611"
[0m13:08:25.701644 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.not_null_mart_person_kpis_person_id.cbbb30dfe0
[0m13:08:25.701888 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.relationships_fact_insurance_yearly_person_id__person_id__ref_dim_person_.759a8de8e7, now test.health_insurance_dbt.not_null_mart_person_kpis_person_id.cbbb30dfe0)
[0m13:08:25.702097 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.not_null_mart_person_kpis_person_id.cbbb30dfe0
[0m13:08:25.703834 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_mart_person_kpis_person_id.cbbb30dfe0"
[0m13:08:25.704049 [debug] [Thread-1 (]: Began executing node test.health_insurance_dbt.not_null_mart_city_year_kpis_city.673ebc9511
[0m13:08:25.704203 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.not_null_mart_city_year_kpis_year.c44388c611
[0m13:08:25.704357 [debug] [Thread-3 (]: Began executing node test.health_insurance_dbt.not_null_mart_city_year_kpis_persons_in_city.d72b53311d
[0m13:08:25.704513 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.704697 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.704853 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.704989 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.not_null_mart_person_kpis_person_id.cbbb30dfe0
[0m13:08:25.705341 [debug] [Thread-1 (]: Finished running node test.health_insurance_dbt.not_null_mart_city_year_kpis_city.673ebc9511
[0m13:08:25.705654 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.not_null_mart_city_year_kpis_year.c44388c611
[0m13:08:25.706278 [debug] [Thread-3 (]: Finished running node test.health_insurance_dbt.not_null_mart_city_year_kpis_persons_in_city.d72b53311d
[0m13:08:25.706449 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.706620 [debug] [Thread-1 (]: Began running node test.health_insurance_dbt.not_null_mart_person_kpis_years_with_data.8344b79270
[0m13:08:25.706790 [debug] [Thread-4 (]: Began running node test.health_insurance_dbt.unique_mart_person_kpis_person_id.901c938529
[0m13:08:25.706956 [debug] [Thread-3 (]: Began running node test.health_insurance_dbt.not_null_mart_yearly_kpis_total_persons.c2112c4742
[0m13:08:25.707271 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.not_null_mart_person_kpis_person_id.cbbb30dfe0
[0m13:08:25.707424 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_mart_city_year_kpis_city.673ebc9511, now test.health_insurance_dbt.not_null_mart_person_kpis_years_with_data.8344b79270)
[0m13:08:25.707593 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_mart_city_year_kpis_year.c44388c611, now test.health_insurance_dbt.unique_mart_person_kpis_person_id.901c938529)
[0m13:08:25.707747 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_mart_city_year_kpis_persons_in_city.d72b53311d, now test.health_insurance_dbt.not_null_mart_yearly_kpis_total_persons.c2112c4742)
[0m13:08:25.707923 [debug] [Thread-2 (]: Began running node test.health_insurance_dbt.not_null_mart_yearly_kpis_year.3ca5077a19
[0m13:08:25.708097 [debug] [Thread-1 (]: Began compiling node test.health_insurance_dbt.not_null_mart_person_kpis_years_with_data.8344b79270
[0m13:08:25.708242 [debug] [Thread-4 (]: Began compiling node test.health_insurance_dbt.unique_mart_person_kpis_person_id.901c938529
[0m13:08:25.708378 [debug] [Thread-3 (]: Began compiling node test.health_insurance_dbt.not_null_mart_yearly_kpis_total_persons.c2112c4742
[0m13:08:25.708523 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_mart_person_kpis_person_id.cbbb30dfe0, now test.health_insurance_dbt.not_null_mart_yearly_kpis_year.3ca5077a19)
[0m13:08:25.710185 [debug] [Thread-1 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_mart_person_kpis_years_with_data.8344b79270"
[0m13:08:25.711852 [debug] [Thread-4 (]: Writing injected SQL for node "test.health_insurance_dbt.unique_mart_person_kpis_person_id.901c938529"
[0m13:08:25.713813 [debug] [Thread-3 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_mart_yearly_kpis_total_persons.c2112c4742"
[0m13:08:25.713993 [debug] [Thread-2 (]: Began compiling node test.health_insurance_dbt.not_null_mart_yearly_kpis_year.3ca5077a19
[0m13:08:25.715760 [debug] [Thread-2 (]: Writing injected SQL for node "test.health_insurance_dbt.not_null_mart_yearly_kpis_year.3ca5077a19"
[0m13:08:25.716087 [debug] [Thread-1 (]: Began executing node test.health_insurance_dbt.not_null_mart_person_kpis_years_with_data.8344b79270
[0m13:08:25.716244 [debug] [Thread-3 (]: Began executing node test.health_insurance_dbt.not_null_mart_yearly_kpis_total_persons.c2112c4742
[0m13:08:25.716394 [debug] [Thread-4 (]: Began executing node test.health_insurance_dbt.unique_mart_person_kpis_person_id.901c938529
[0m13:08:25.716551 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.716702 [debug] [Thread-2 (]: Began executing node test.health_insurance_dbt.not_null_mart_yearly_kpis_year.3ca5077a19
[0m13:08:25.716863 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m13:08:25.717018 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m13:08:25.717383 [debug] [Thread-1 (]: Finished running node test.health_insurance_dbt.not_null_mart_person_kpis_years_with_data.8344b79270
[0m13:08:25.718044 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:08:25.718381 [debug] [Thread-3 (]: Finished running node test.health_insurance_dbt.not_null_mart_yearly_kpis_total_persons.c2112c4742
[0m13:08:25.718694 [debug] [Thread-4 (]: Finished running node test.health_insurance_dbt.unique_mart_person_kpis_person_id.901c938529
[0m13:08:25.719226 [debug] [Thread-1 (]: Began running node test.health_insurance_dbt.unique_mart_yearly_kpis_year.121a244db4
[0m13:08:25.719553 [debug] [Thread-2 (]: Finished running node test.health_insurance_dbt.not_null_mart_yearly_kpis_year.3ca5077a19
[0m13:08:25.719766 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.health_insurance_dbt.not_null_mart_person_kpis_years_with_data.8344b79270, now test.health_insurance_dbt.unique_mart_yearly_kpis_year.121a244db4)
[0m13:08:25.719969 [debug] [Thread-1 (]: Began compiling node test.health_insurance_dbt.unique_mart_yearly_kpis_year.121a244db4
[0m13:08:25.721895 [debug] [Thread-1 (]: Writing injected SQL for node "test.health_insurance_dbt.unique_mart_yearly_kpis_year.121a244db4"
[0m13:08:25.722394 [debug] [Thread-1 (]: Began executing node test.health_insurance_dbt.unique_mart_yearly_kpis_year.121a244db4
[0m13:08:25.722555 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:08:25.722865 [debug] [Thread-1 (]: Finished running node test.health_insurance_dbt.unique_mart_yearly_kpis_year.121a244db4
[0m13:08:25.723647 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:08:25.723787 [debug] [MainThread]: Connection 'test.health_insurance_dbt.unique_mart_yearly_kpis_year.121a244db4' was properly closed.
[0m13:08:25.723904 [debug] [MainThread]: Connection 'test.health_insurance_dbt.not_null_mart_yearly_kpis_year.3ca5077a19' was properly closed.
[0m13:08:25.724009 [debug] [MainThread]: Connection 'test.health_insurance_dbt.not_null_mart_yearly_kpis_total_persons.c2112c4742' was properly closed.
[0m13:08:25.724112 [debug] [MainThread]: Connection 'test.health_insurance_dbt.unique_mart_person_kpis_person_id.901c938529' was properly closed.
[0m13:08:25.726280 [debug] [MainThread]: Command end result
[0m13:08:25.743838 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m13:08:25.745035 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m13:08:25.749667 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m13:08:25.750052 [debug] [MainThread]: Resource report: {"command_name": "compile", "command_success": true, "command_wall_clock_time": 16.361975, "process_in_blocks": "0", "process_kernel_time": 5.636686, "process_mem_max_rss": "430751744", "process_out_blocks": "0", "process_user_time": 9.800176}
[0m13:08:25.750298 [debug] [MainThread]: Command `dbt compile` succeeded at 13:08:25.750253 after 16.36 seconds
[0m13:08:25.750497 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109035550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15972fd80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15972e360>]}
[0m13:08:25.750659 [debug] [MainThread]: Flushing usage events
[0m13:08:26.271173 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:09:14.618368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1039aee40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f27890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f27b10>]}


============================== 13:09:14.621702 | 956361b4-0934-4f57-ba8c-59b68343e8c3 ==============================
[0m13:09:14.621702 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:09:14.622038 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'use_colors': 'True', 'fail_fast': 'False', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'indirect_selection': 'eager', 'no_print': 'None', 'quiet': 'False', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'warn_error': 'None', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run --full-refresh', 'log_cache_events': 'False', 'empty': 'False', 'cache_selected_only': 'False', 'debug': 'False', 'printer_width': '80', 'static_parser': 'True', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'write_json': 'True'}
[0m13:09:27.707122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1042828b0>]}
[0m13:09:27.745589 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103805370>]}
[0m13:09:27.745947 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m13:09:27.875584 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m13:09:27.982981 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:09:27.983221 [debug] [MainThread]: Nothing changed, skipping partial parsing.
[0m13:09:27.983361 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:09:28.006274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128cacc50>]}
[0m13:09:28.050547 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m13:09:28.051661 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m13:09:28.066125 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12872de50>]}
[0m13:09:28.066382 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m13:09:28.066552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128b5f150>]}
[0m13:09:28.067739 [info ] [MainThread]: 
[0m13:09:28.067906 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m13:09:28.068042 [info ] [MainThread]: 
[0m13:09:28.068288 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:09:28.070353 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:09:28.070605 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:28.070852 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:09:28.071164 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:09:28.071376 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:28.071549 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:09:28.071722 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:28.071931 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:09:29.403515 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now create_dw-health-insurance-bipm_health_insurance_dev)
[0m13:09:29.405121 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now create_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m13:09:29.405642 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now create_dw-health-insurance-bipm_health_insurance_dev_core)
[0m13:09:29.406443 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now create_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m13:09:29.407645 [debug] [ThreadPool]: Creating schema "database: "dw-health-insurance-bipm"
schema: "health_insurance_dev"
"
[0m13:09:29.408321 [debug] [ThreadPool]: Creating schema "database: "dw-health-insurance-bipm"
schema: "health_insurance_dev_marts"
"
[0m13:09:29.408833 [debug] [ThreadPool]: Creating schema "database: "dw-health-insurance-bipm"
schema: "health_insurance_dev_core"
"
[0m13:09:29.409313 [debug] [ThreadPool]: Creating schema "database: "dw-health-insurance-bipm"
schema: "health_insurance_dev_staging"
"
[0m13:09:29.433445 [debug] [ThreadPool]: On create_dw-health-insurance-bipm_health_insurance_dev: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "connection_name": "create_dw-health-insurance-bipm_health_insurance_dev"} */
create schema if not exists `dw-health-insurance-bipm`.`health_insurance_dev`
  
[0m13:09:29.436312 [debug] [ThreadPool]: On create_dw-health-insurance-bipm_health_insurance_dev_marts: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "connection_name": "create_dw-health-insurance-bipm_health_insurance_dev_marts"} */
create schema if not exists `dw-health-insurance-bipm`.`health_insurance_dev_marts`
  
[0m13:09:29.438101 [debug] [ThreadPool]: On create_dw-health-insurance-bipm_health_insurance_dev_core: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "connection_name": "create_dw-health-insurance-bipm_health_insurance_dev_core"} */
create schema if not exists `dw-health-insurance-bipm`.`health_insurance_dev_core`
  
[0m13:09:29.439735 [debug] [ThreadPool]: On create_dw-health-insurance-bipm_health_insurance_dev_staging: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "connection_name": "create_dw-health-insurance-bipm_health_insurance_dev_staging"} */
create schema if not exists `dw-health-insurance-bipm`.`health_insurance_dev_staging`
  
[0m13:09:29.440168 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:29.440423 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:29.440689 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:29.440894 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:29.995922 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:4acf36e3-b925-449c-9b4e-1994b32a9388&page=queryresults
[0m13:09:30.094003 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:ea3db3a9-7f63-4d15-b468-923e01bd48f3&page=queryresults
[0m13:09:30.104477 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:b1cd63d9-710d-428a-816b-4ae16a181105&page=queryresults
[0m13:09:30.137306 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:23234e73-43ad-41ea-9c2a-7c82edb7383c&page=queryresults
[0m13:09:31.480766 [debug] [ThreadPool]: SQL status: OK in 1.484 seconds
[0m13:09:31.573350 [debug] [ThreadPool]: SQL status: OK in 1.435 seconds
[0m13:09:31.747705 [debug] [ThreadPool]: SQL status: OK in 1.642 seconds
[0m13:09:31.981738 [debug] [ThreadPool]: SQL status: OK in 1.887 seconds
[0m13:09:31.987835 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_dw-health-insurance-bipm_health_insurance_dev_core, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m13:09:31.988860 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_dw-health-insurance-bipm_health_insurance_dev, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m13:09:31.989378 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:31.990349 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_dw-health-insurance-bipm_health_insurance_dev_staging, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m13:09:31.991259 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_dw-health-insurance-bipm_health_insurance_dev_marts, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m13:09:31.991766 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:31.993167 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:31.993704 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:09:32.551570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128ad4d50>]}
[0m13:09:32.553324 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:09:32.559389 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:09:32.560082 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m13:09:32.560898 [info ] [Thread-1 (]: 1 of 9 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m13:09:32.561728 [info ] [Thread-2 (]: 2 of 9 START sql view model health_insurance_dev_staging.stg_person_dim_raw .... [RUN]
[0m13:09:32.562385 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m13:09:32.562897 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.stg_person_dim_raw)
[0m13:09:32.563393 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:09:32.563842 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m13:09:32.574557 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m13:09:32.580211 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m13:09:32.582170 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m13:09:32.582597 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:09:32.611529 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m13:09:32.613451 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m13:09:32.614533 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m13:09:32.614921 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m13:09:32.615223 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:09:32.615490 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:09:33.183251 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:249223d2-6f0b-46dc-b48e-9f8c2ec27984&page=queryresults
[0m13:09:33.183965 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:249223d2-6f0b-46dc-b48e-9f8c2ec27984&page=queryresults
[0m13:09:33.194628 [debug] [Thread-1 (]: Database Error in model stg_insurance_facts_raw (models/staging/stg_insurance_facts_raw.sql)
  Not found: Dataset dw-health-insurance-bipm:health_insurance_raw was not found in location EU
  compiled code at target/run/health_insurance_dbt/models/staging/stg_insurance_facts_raw.sql
[0m13:09:33.196324 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128e33710>]}
[0m13:09:33.196870 [error] [Thread-1 (]: 1 of 9 ERROR creating sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[31mERROR[0m in 0.63s]
[0m13:09:33.197266 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:09:33.197643 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.stg_insurance_facts_raw' to be skipped because of status 'error'.  Reason: Database Error in model stg_insurance_facts_raw (models/staging/stg_insurance_facts_raw.sql)
  Not found: Dataset dw-health-insurance-bipm:health_insurance_raw was not found in location EU
  compiled code at target/run/health_insurance_dbt/models/staging/stg_insurance_facts_raw.sql.
[0m13:09:33.248648 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:dabd1020-bdd9-45d7-84c6-76150ed1daba&page=queryresults
[0m13:09:33.249185 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:dabd1020-bdd9-45d7-84c6-76150ed1daba&page=queryresults
[0m13:09:33.252065 [debug] [Thread-2 (]: Database Error in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)
  Not found: Dataset dw-health-insurance-bipm:health_insurance_raw was not found in location EU
  compiled code at target/run/health_insurance_dbt/models/staging/stg_person_dim_raw.sql
[0m13:09:33.252383 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '956361b4-0934-4f57-ba8c-59b68343e8c3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128dbf960>]}
[0m13:09:33.252726 [error] [Thread-2 (]: 2 of 9 ERROR creating sql view model health_insurance_dev_staging.stg_person_dim_raw  [[31mERROR[0m in 0.69s]
[0m13:09:33.252998 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m13:09:33.253258 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.stg_person_dim_raw' to be skipped because of status 'error'.  Reason: Database Error in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)
  Not found: Dataset dw-health-insurance-bipm:health_insurance_raw was not found in location EU
  compiled code at target/run/health_insurance_dbt/models/staging/stg_person_dim_raw.sql.
[0m13:09:33.253894 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m13:09:33.254100 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m13:09:33.254291 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m13:09:33.254518 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m13:09:33.254855 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.dim_person
[0m13:09:33.255040 [info ] [Thread-1 (]: 3 of 9 SKIP relation health_insurance_dev_core.dim_person ...................... [[33mSKIP[0m]
[0m13:09:33.255230 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.dim_person
[0m13:09:33.255796 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m13:09:33.256097 [info ] [Thread-2 (]: 4 of 9 SKIP relation health_insurance_dev_core.fact_insurance_yearly ........... [[33mSKIP[0m]
[0m13:09:33.256547 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m13:09:33.256917 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.negative_costs
[0m13:09:33.257100 [info ] [Thread-2 (]: 8 of 9 SKIP relation health_insurance_dev.negative_costs ....................... [[33mSKIP[0m]
[0m13:09:33.257332 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m13:09:33.257535 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m13:09:33.257741 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m13:09:33.257911 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m13:09:33.258106 [info ] [Thread-3 (]: 5 of 9 SKIP relation health_insurance_dev_marts.mart_city_year_kpis ............ [[33mSKIP[0m]
[0m13:09:33.258345 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m13:09:33.258542 [info ] [Thread-1 (]: 7 of 9 SKIP relation health_insurance_dev_marts.mart_yearly_kpis ............... [[33mSKIP[0m]
[0m13:09:33.258745 [info ] [Thread-4 (]: 6 of 9 SKIP relation health_insurance_dev_marts.mart_person_kpis ............... [[33mSKIP[0m]
[0m13:09:33.258978 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m13:09:33.259170 [info ] [Thread-2 (]: 9 of 9 SKIP relation health_insurance_dev.visits_reasonable .................... [[33mSKIP[0m]
[0m13:09:33.259382 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m13:09:33.259570 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m13:09:33.259781 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m13:09:33.260767 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:09:33.261099 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:09:33.261244 [debug] [MainThread]: Connection 'model.health_insurance_dbt.stg_insurance_facts_raw' was properly closed.
[0m13:09:33.261442 [debug] [MainThread]: Connection 'model.health_insurance_dbt.stg_person_dim_raw' was properly closed.
[0m13:09:33.261572 [debug] [MainThread]: Connection 'list_dw-health-insurance-bipm_health_insurance_dev_marts' was properly closed.
[0m13:09:33.261697 [debug] [MainThread]: Connection 'list_dw-health-insurance-bipm_health_insurance_dev_core' was properly closed.
[0m13:09:33.261942 [info ] [MainThread]: 
[0m13:09:33.262122 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 4 view models in 0 hours 0 minutes and 5.19 seconds (5.19s).
[0m13:09:33.262691 [debug] [MainThread]: Command end result
[0m13:09:33.287518 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m13:09:33.290970 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m13:09:33.297541 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m13:09:33.297788 [info ] [MainThread]: 
[0m13:09:33.297974 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m13:09:33.298129 [info ] [MainThread]: 
[0m13:09:33.298333 [error] [MainThread]: [31mFailure in model stg_insurance_facts_raw (models/staging/stg_insurance_facts_raw.sql)[0m
[0m13:09:33.298504 [error] [MainThread]:   Database Error in model stg_insurance_facts_raw (models/staging/stg_insurance_facts_raw.sql)
  Not found: Dataset dw-health-insurance-bipm:health_insurance_raw was not found in location EU
  compiled code at target/run/health_insurance_dbt/models/staging/stg_insurance_facts_raw.sql
[0m13:09:33.298633 [info ] [MainThread]: 
[0m13:09:33.298781 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/staging/stg_insurance_facts_raw.sql
[0m13:09:33.298905 [info ] [MainThread]: 
[0m13:09:33.299057 [error] [MainThread]: [31mFailure in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)[0m
[0m13:09:33.299212 [error] [MainThread]:   Database Error in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)
  Not found: Dataset dw-health-insurance-bipm:health_insurance_raw was not found in location EU
  compiled code at target/run/health_insurance_dbt/models/staging/stg_person_dim_raw.sql
[0m13:09:33.299327 [info ] [MainThread]: 
[0m13:09:33.299470 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/staging/stg_person_dim_raw.sql
[0m13:09:33.299592 [info ] [MainThread]: 
[0m13:09:33.299750 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=2 SKIP=7 NO-OP=0 TOTAL=9
[0m13:09:33.300116 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 18.730127, "process_in_blocks": "0", "process_kernel_time": 5.552968, "process_mem_max_rss": "429015040", "process_out_blocks": "0", "process_user_time": 9.820684}
[0m13:09:33.300364 [debug] [MainThread]: Command `dbt run` failed at 13:09:33.300322 after 18.73 seconds
[0m13:09:33.300606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d3d4e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x12d4e3f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128ae1750>]}
[0m13:09:33.300781 [debug] [MainThread]: Flushing usage events
[0m13:09:33.777118 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m13:12:29.409878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a4ee40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fc7890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fc7b10>]}


============================== 13:12:29.414693 | 3fc311c3-b428-49d8-9a03-0ab6595e81c4 ==============================
[0m13:12:29.414693 [info ] [MainThread]: Running with dbt=1.11.2
[0m13:12:29.415026 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'version_check': 'True', 'indirect_selection': 'eager', 'warn_error': 'None', 'write_json': 'True', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'introspect': 'True', 'debug': 'False', 'cache_selected_only': 'False', 'target_path': 'None', 'fail_fast': 'False', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'empty': 'False', 'use_experimental_parser': 'False', 'use_colors': 'True', 'quiet': 'False', 'no_print': 'None', 'static_parser': 'True', 'printer_width': '80', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'log_format': 'default', 'invocation_command': 'dbt run --full-refresh'}
[0m13:12:44.421675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1063228b0>]}
[0m13:12:44.461168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058a5370>]}
[0m13:12:44.461548 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m13:12:44.594129 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m13:12:44.704401 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m13:12:44.704644 [debug] [MainThread]: Nothing changed, skipping partial parsing.
[0m13:12:44.704776 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m13:12:44.728761 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x157d1cc50>]}
[0m13:12:44.774011 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m13:12:44.775284 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m13:12:44.790215 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1557fde50>]}
[0m13:12:44.790501 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m13:12:44.790675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x157bd7150>]}
[0m13:12:44.791881 [info ] [MainThread]: 
[0m13:12:44.792069 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m13:12:44.792204 [info ] [MainThread]: 
[0m13:12:44.792463 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m13:12:44.794605 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:12:44.794821 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:12:44.795019 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:12:44.795362 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:12:44.795536 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:12:44.795737 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m13:12:44.795897 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:12:44.796156 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m13:12:46.071204 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m13:12:46.072682 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:12:46.073576 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m13:12:46.075616 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m13:12:46.076373 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:12:46.076935 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m13:12:46.077857 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:12:46.079129 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m13:12:46.321853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x157b48d50>]}
[0m13:12:46.323367 [debug] [MainThread]: Opening a new connection, currently in state init
[0m13:12:46.330508 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:12:46.331378 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m13:12:46.332174 [info ] [Thread-1 (]: 1 of 9 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m13:12:46.332984 [info ] [Thread-2 (]: 2 of 9 START sql view model health_insurance_dev_staging.stg_person_dim_raw .... [RUN]
[0m13:12:46.333692 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m13:12:46.334242 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.stg_person_dim_raw)
[0m13:12:46.334760 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:12:46.335216 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m13:12:46.352408 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m13:12:46.355516 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m13:12:46.357376 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:12:46.358091 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m13:12:46.392458 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m13:12:46.392892 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m13:12:46.393627 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m13:12:46.393961 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m13:12:46.394261 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m13:12:46.394486 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m13:12:46.898347 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:3c9f88d0-0902-4c8d-b197-77bf0d844f39&page=queryresults
[0m13:12:46.899849 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:b72827ca-cb14-481e-9ccd-cefac074d488&page=queryresults
[0m13:12:47.028302 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:b72827ca-cb14-481e-9ccd-cefac074d488&page=queryresults
[0m13:12:47.047438 [debug] [Thread-2 (]: Database Error in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)
  Unrecognized name: Person_id at [22:7]
  compiled code at target/run/health_insurance_dbt/models/staging/stg_person_dim_raw.sql
[0m13:12:47.049950 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x157fa68d0>]}
[0m13:12:47.050934 [error] [Thread-2 (]: 2 of 9 ERROR creating sql view model health_insurance_dev_staging.stg_person_dim_raw  [[31mERROR[0m in 0.71s]
[0m13:12:47.051699 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m13:12:47.052317 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.stg_person_dim_raw' to be skipped because of status 'error'.  Reason: Database Error in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)
  Unrecognized name: Person_id at [22:7]
  compiled code at target/run/health_insurance_dbt/models/staging/stg_person_dim_raw.sql.
[0m13:12:47.053913 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m13:12:47.055195 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m13:12:47.055747 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m13:12:47.056209 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m13:12:47.057079 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.dim_person
[0m13:12:47.057929 [info ] [Thread-2 (]: 3 of 9 SKIP relation health_insurance_dev_core.dim_person ...................... [[33mSKIP[0m]
[0m13:12:47.058963 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.dim_person
[0m13:12:47.135013 [debug] [Thread-1 (]: SQL status: OK in 0.235 seconds
[0m13:12:47.215193 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3fc311c3-b428-49d8-9a03-0ab6595e81c4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x157f32360>]}
[0m13:12:47.215583 [info ] [Thread-1 (]: 1 of 9 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 0.88s]
[0m13:12:47.215875 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m13:12:47.216241 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m13:12:47.216495 [info ] [Thread-3 (]: 4 of 9 SKIP relation health_insurance_dev_core.fact_insurance_yearly ........... [[33mSKIP[0m]
[0m13:12:47.216733 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m13:12:47.217031 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m13:12:47.217209 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m13:12:47.217401 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m13:12:47.217604 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.negative_costs
[0m13:12:47.217778 [info ] [Thread-1 (]: 7 of 9 SKIP relation health_insurance_dev_marts.mart_yearly_kpis ............... [[33mSKIP[0m]
[0m13:12:47.217943 [info ] [Thread-4 (]: 5 of 9 SKIP relation health_insurance_dev_marts.mart_city_year_kpis ............ [[33mSKIP[0m]
[0m13:12:47.218187 [info ] [Thread-2 (]: 6 of 9 SKIP relation health_insurance_dev_marts.mart_person_kpis ............... [[33mSKIP[0m]
[0m13:12:47.218385 [info ] [Thread-3 (]: 8 of 9 SKIP relation health_insurance_dev.negative_costs ....................... [[33mSKIP[0m]
[0m13:12:47.218571 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m13:12:47.218748 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m13:12:47.218916 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m13:12:47.219076 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m13:12:47.219239 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m13:12:47.219520 [info ] [Thread-1 (]: 9 of 9 SKIP relation health_insurance_dev.visits_reasonable .................... [[33mSKIP[0m]
[0m13:12:47.219716 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m13:12:47.220292 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m13:12:47.220567 [debug] [MainThread]: Connection 'master' was properly closed.
[0m13:12:47.220699 [debug] [MainThread]: Connection 'model.health_insurance_dbt.stg_insurance_facts_raw' was properly closed.
[0m13:12:47.220815 [debug] [MainThread]: Connection 'model.health_insurance_dbt.stg_person_dim_raw' was properly closed.
[0m13:12:47.220926 [debug] [MainThread]: Connection 'list_dw-health-insurance-bipm_health_insurance_dev_staging' was properly closed.
[0m13:12:47.221038 [debug] [MainThread]: Connection 'list_dw-health-insurance-bipm_health_insurance_dev_core' was properly closed.
[0m13:12:47.221218 [info ] [MainThread]: 
[0m13:12:47.221418 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 4 view models in 0 hours 0 minutes and 2.43 seconds (2.43s).
[0m13:12:47.221906 [debug] [MainThread]: Command end result
[0m13:12:47.238107 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m13:12:47.240227 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m13:12:47.244071 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m13:12:47.244269 [info ] [MainThread]: 
[0m13:12:47.244439 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m13:12:47.244577 [info ] [MainThread]: 
[0m13:12:47.244759 [error] [MainThread]: [31mFailure in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)[0m
[0m13:12:47.244922 [error] [MainThread]:   Database Error in model stg_person_dim_raw (models/staging/stg_person_dim_raw.sql)
  Unrecognized name: Person_id at [22:7]
  compiled code at target/run/health_insurance_dbt/models/staging/stg_person_dim_raw.sql
[0m13:12:47.245044 [info ] [MainThread]: 
[0m13:12:47.245189 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/staging/stg_person_dim_raw.sql
[0m13:12:47.245314 [info ] [MainThread]: 
[0m13:12:47.245461 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=7 NO-OP=0 TOTAL=9
[0m13:12:47.245762 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 17.884361, "process_in_blocks": "0", "process_kernel_time": 6.605464, "process_mem_max_rss": "419151872", "process_out_blocks": "0", "process_user_time": 9.529489}
[0m13:12:47.246010 [debug] [MainThread]: Command `dbt run` failed at 13:12:47.245972 after 17.88 seconds
[0m13:12:47.246218 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x157f8a210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1648a6570>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1648a3b50>]}
[0m13:12:47.246395 [debug] [MainThread]: Flushing usage events
[0m13:12:47.695782 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:24:14.595778 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10393ee40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104eb7890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104eb7b10>]}


============================== 15:24:14.600686 | 306c68d3-738c-42c2-ad3a-39aa2d210e62 ==============================
[0m15:24:14.600686 [info ] [MainThread]: Running with dbt=1.11.2
[0m15:24:14.601033 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'version_check': 'True', 'indirect_selection': 'eager', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt run --full-refresh', 'no_print': 'None', 'debug': 'False', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'target_path': 'None', 'empty': 'False', 'printer_width': '80', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'use_experimental_parser': 'False', 'fail_fast': 'False', 'introspect': 'True', 'warn_error': 'None', 'static_parser': 'True', 'quiet': 'False', 'cache_selected_only': 'False', 'write_json': 'True', 'partial_parse': 'True'}
[0m15:24:28.453362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1042128b0>]}
[0m15:24:28.491738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103795370>]}
[0m15:24:28.492089 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m15:24:28.662593 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m15:24:28.773967 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:24:28.774230 [debug] [MainThread]: Nothing changed, skipping partial parsing.
[0m15:24:28.774366 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:24:28.797602 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155d20c50>]}
[0m15:24:28.878793 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:24:28.880904 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:24:28.898099 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x153e89e50>]}
[0m15:24:28.898426 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m15:24:28.898623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155bd3150>]}
[0m15:24:28.900015 [info ] [MainThread]: 
[0m15:24:28.900209 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:24:28.900351 [info ] [MainThread]: 
[0m15:24:28.900622 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:24:28.902873 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:24:28.903130 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:24:28.903291 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:28.903511 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:24:28.903757 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:24:28.903990 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:28.904399 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:28.904589 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:24:32.000593 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m15:24:32.002557 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:24:32.003534 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m15:24:32.005689 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m15:24:32.006464 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:24:32.007034 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m15:24:32.008054 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:24:32.009287 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:24:32.484426 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155b48d50>]}
[0m15:24:32.486205 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:24:32.492403 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:24:32.493060 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:24:32.493876 [info ] [Thread-1 (]: 1 of 9 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m15:24:32.494760 [info ] [Thread-2 (]: 2 of 9 START sql view model health_insurance_dev_staging.stg_person_dim_raw .... [RUN]
[0m15:24:32.495484 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m15:24:32.496018 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.stg_person_dim_raw)
[0m15:24:32.496536 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:24:32.497001 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m15:24:32.512228 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:24:32.515190 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:24:32.516651 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m15:24:32.517058 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:24:32.545690 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:24:32.546869 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:24:32.547851 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m15:24:32.548127 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:24:32.548895 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m15:24:32.549172 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:24:33.244972 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:5053f8c7-f5e9-456b-aa46-8226bb5e2b5d&page=queryresults
[0m15:24:33.336547 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:a7602ae3-85b8-4615-9796-a2176d59f414&page=queryresults
[0m15:24:33.619573 [debug] [Thread-2 (]: SQL status: OK in 0.372 seconds
[0m15:24:33.671224 [debug] [Thread-1 (]: SQL status: OK in 0.333 seconds
[0m15:24:33.719543 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155faa990>]}
[0m15:24:33.719751 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155f324c0>]}
[0m15:24:33.720110 [info ] [Thread-1 (]: 1 of 9 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m15:24:33.720751 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:24:33.720477 [info ] [Thread-2 (]: 2 of 9 OK created sql view model health_insurance_dev_staging.stg_person_dim_raw  [[32mCREATE VIEW (0 processed)[0m in 1.22s]
[0m15:24:33.721145 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:24:33.721498 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m15:24:33.721698 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.int_person_deduped)
[0m15:24:33.721877 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m15:24:33.722071 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m15:24:33.722257 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now model.health_insurance_dbt.int_person_cleaned)
[0m15:24:33.724306 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m15:24:33.724493 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m15:24:33.726901 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m15:24:33.727796 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:24:33.728246 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m15:24:33.728463 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:24:33.729030 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m15:24:33.729391 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.dim_person
[0m15:24:33.729645 [info ] [Thread-1 (]: 3 of 9 START sql table model health_insurance_dev_core.dim_person .............. [RUN]
[0m15:24:33.729948 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.dim_person)
[0m15:24:33.730168 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m15:24:33.735177 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m15:24:33.735878 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.dim_person
[0m15:24:33.752072 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.dim_person"
[0m15:24:33.753097 [debug] [Thread-1 (]: On model.health_insurance_dbt.dim_person: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.dim_person"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Conformed person dimension (SCD Type 1)
-- Grain: One row per person_id
-- Business key: person_id

WITH  __dbt__cte__int_person_deduped as (


-- Parse dates, standardize categories, extract address components
-- Each raw row is cleaned but duplicates remain

WITH source AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
),

-- Date parsing logic for birthdate
birthdate_parsed AS (
  SELECT
    person_id,
    birthdate_raw,
    
    -- Try multiple date formats
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', birthdate_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', birthdate_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', birthdate_raw),
      
      -- Slash format with heuristic (birthdate defaults to MM/DD/...)
      CASE
        -- Check if it's a slash-delimited date
        WHEN REGEXP_CONTAINS(birthdate_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            -- Extract parts
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to MM/DD/... for birthdate
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS birthdate_parsed
  FROM source
),

-- Date parsing logic for insurance_sign_up_date
signup_date_parsed AS (
  SELECT
    person_id,
    insurance_sign_up_date_raw,
    
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', insurance_sign_up_date_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', insurance_sign_up_date_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', insurance_sign_up_date_raw),
      
      -- Slash format with heuristic (signup defaults to DD/MM/...)
      CASE
        WHEN REGEXP_CONTAINS(insurance_sign_up_date_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to DD/MM/... for signup date
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS insurance_sign_up_date_parsed
  FROM source
),

-- Address parsing
address_parsed AS (
  SELECT
    person_id,
    address_raw,
    REGEXP_REPLACE(TRIM(address_raw), r'\s+', ' ') AS address_clean,
    REGEXP_EXTRACT(address_raw, r'\b(\d{5})\b') AS postal_code,
    INITCAP(TRIM(REGEXP_EXTRACT(address_raw, r'\d{5}\s+(.+)$'))) AS city,
    TRIM(SPLIT(address_raw, ',')[SAFE_OFFSET(0)]) AS street_and_number
  FROM source
)

-- Final cleaned output
SELECT
  s.person_id,
  
  -- Dates with parse error flags
  bd.birthdate_parsed,
  CASE WHEN bd.birthdate_parsed IS NULL AND s.birthdate_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS birthdate_parse_error,
  
  sd.insurance_sign_up_date_parsed,
  CASE WHEN sd.insurance_sign_up_date_parsed IS NULL AND s.insurance_sign_up_date_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_sign_up_date_parse_error,
  
  -- Address components
  ap.address_raw,
  ap.address_clean,
  ap.postal_code,
  ap.city,
  ap.street_and_number,
  
  -- Standardized gender
  CASE
    WHEN UPPER(TRIM(s.gender_raw)) IN ('M', 'MALE') THEN 'male'
    WHEN UPPER(TRIM(s.gender_raw)) IN ('F', 'FEMALE') THEN 'female'
    ELSE 'unknown'
  END AS gender_std,
  
  -- Standardized family status
  CASE
    WHEN UPPER(TRIM(s.family_status_raw)) = 'SINGLE' THEN 'single'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'MARRIED' THEN 'married'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'DIVORCED' THEN 'divorced'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'WIDOWED' THEN 'widowed'
    ELSE 'unknown'
  END AS family_status_std,
  
  -- Standardized insurance status
  CASE
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'ACTIVE' THEN 'active'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'INACTIVE' THEN 'inactive'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'PENDING' THEN 'pending'
    ELSE 'unknown'
  END AS insurance_status_std,
  
  -- Cleaned occupational category
  CASE 
    WHEN TRIM(s.occupational_category_raw) = '' THEN NULL
    ELSE TRIM(s.occupational_category_raw)
  END AS occupational_category_clean,
  
  -- Standardized wealth bracket
  CASE
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('LOW', 'LOWER') THEN 'low'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) = 'MEDIUM' THEN 'medium'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('UPPER_MIDDLE', 'UPPER MIDDLE', 'UPPERMIDDLE') THEN 'upper_middle'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('HIGH', 'UPPER') THEN 'high'
    ELSE 'unknown'
  END AS wealth_bracket_std

FROM source s
LEFT JOIN birthdate_parsed bd USING (person_id)
LEFT JOIN signup_date_parsed sd USING (person_id)
LEFT JOIN address_parsed ap USING (person_id)
), deduped AS (
  SELECT * FROM __dbt__cte__int_person_deduped
)

SELECT
  person_id,
  
  -- Demographic attributes
  birthdate_parsed AS birthdate,
  CASE 
    WHEN birthdate_parsed IS NOT NULL 
    THEN DATE_DIFF(CURRENT_DATE(), birthdate_parsed, YEAR)
    ELSE NULL 
  END AS age_years,
  gender_std AS gender,
  family_status_std AS family_status,
  
  -- Insurance attributes
  insurance_status_std AS insurance_status,
  insurance_sign_up_date_parsed AS insurance_sign_up_date,
  EXTRACT(YEAR FROM insurance_sign_up_date_parsed) AS signup_year,
  FORMAT_DATE('%Y-%m', insurance_sign_up_date_parsed) AS signup_month,
  
  -- Economic attributes
  occupational_category_clean AS occupational_category,
  wealth_bracket_std AS wealth_bracket,
  
  -- Address attributes
  address_clean AS address,
  street_and_number,
  postal_code,
  city,
  
  -- Data quality flags
  birthdate_parse_error,
  insurance_sign_up_date_parse_error,
  completeness_score,
  
  -- Metadata
  dedupe_processed_at,
  CURRENT_TIMESTAMP() AS dim_updated_at

FROM deduped
    );
  
[0m15:24:33.753610 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:24:34.719039 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:d8b0ed74-5fa4-4544-8fc5-199e2ba1f468&page=queryresults
[0m15:24:34.901313 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:d8b0ed74-5fa4-4544-8fc5-199e2ba1f468&page=queryresults
[0m15:24:34.911619 [debug] [Thread-1 (]: Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: completeness_score at [281:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql
[0m15:24:34.912346 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '306c68d3-738c-42c2-ad3a-39aa2d210e62', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15a3239d0>]}
[0m15:24:34.913089 [error] [Thread-1 (]: 3 of 9 ERROR creating sql table model health_insurance_dev_core.dim_person ..... [[31mERROR[0m in 1.18s]
[0m15:24:34.913718 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.dim_person
[0m15:24:34.914324 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.dim_person' to be skipped because of status 'error'.  Reason: Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: completeness_score at [281:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql.
[0m15:24:34.916439 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:24:34.917030 [info ] [Thread-2 (]: 4 of 9 SKIP relation health_insurance_dev_core.fact_insurance_yearly ........... [[33mSKIP[0m]
[0m15:24:34.917880 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:24:34.918677 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:24:34.919045 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.negative_costs
[0m15:24:34.919370 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:24:34.919664 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m15:24:34.920015 [info ] [Thread-3 (]: 5 of 9 SKIP relation health_insurance_dev_marts.mart_city_year_kpis ............ [[33mSKIP[0m]
[0m15:24:34.920394 [info ] [Thread-2 (]: 8 of 9 SKIP relation health_insurance_dev.negative_costs ....................... [[33mSKIP[0m]
[0m15:24:34.920832 [info ] [Thread-1 (]: 7 of 9 SKIP relation health_insurance_dev_marts.mart_yearly_kpis ............... [[33mSKIP[0m]
[0m15:24:34.921316 [info ] [Thread-4 (]: 6 of 9 SKIP relation health_insurance_dev_marts.mart_person_kpis ............... [[33mSKIP[0m]
[0m15:24:34.921744 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:24:34.922095 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m15:24:34.922432 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:24:34.922747 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m15:24:34.923089 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m15:24:34.923665 [info ] [Thread-3 (]: 9 of 9 SKIP relation health_insurance_dev.visits_reasonable .................... [[33mSKIP[0m]
[0m15:24:34.924658 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m15:24:34.926158 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:24:34.926853 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:24:34.927162 [debug] [MainThread]: Connection 'model.health_insurance_dbt.dim_person' was properly closed.
[0m15:24:34.927533 [debug] [MainThread]: Connection 'model.health_insurance_dbt.stg_person_dim_raw' was properly closed.
[0m15:24:34.927801 [debug] [MainThread]: Connection 'model.health_insurance_dbt.int_person_cleaned' was properly closed.
[0m15:24:34.928045 [debug] [MainThread]: Connection 'model.health_insurance_dbt.int_person_deduped' was properly closed.
[0m15:24:34.928395 [info ] [MainThread]: 
[0m15:24:34.928709 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 4 view models in 0 hours 0 minutes and 6.03 seconds (6.03s).
[0m15:24:34.929690 [debug] [MainThread]: Command end result
[0m15:24:34.951684 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:24:34.953107 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:24:34.958359 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m15:24:34.958652 [info ] [MainThread]: 
[0m15:24:34.958875 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:24:34.959059 [info ] [MainThread]: 
[0m15:24:34.959318 [error] [MainThread]: [31mFailure in model dim_person (models/core/dim_person.sql)[0m
[0m15:24:34.959513 [error] [MainThread]:   Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: completeness_score at [281:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql
[0m15:24:34.959642 [info ] [MainThread]: 
[0m15:24:34.959795 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/core/dim_person.sql
[0m15:24:34.959928 [info ] [MainThread]: 
[0m15:24:34.960134 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=6 NO-OP=0 TOTAL=9
[0m15:24:34.961451 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 20.421225, "process_in_blocks": "0", "process_kernel_time": 5.856449, "process_mem_max_rss": "430112768", "process_out_blocks": "0", "process_user_time": 9.846927}
[0m15:24:34.961866 [debug] [MainThread]: Command `dbt run` failed at 15:24:34.961822 after 20.42 seconds
[0m15:24:34.962239 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155b69750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155b2b950>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f5cf30>]}
[0m15:24:34.962424 [debug] [MainThread]: Flushing usage events
[0m15:24:35.772780 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:26:44.923689 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105feae40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b93890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b93b10>]}


============================== 15:26:44.928189 | e27ca6b7-efda-4751-90fb-039ec9b1b5d7 ==============================
[0m15:26:44.928189 [info ] [MainThread]: Running with dbt=1.11.2
[0m15:26:44.928552 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'no_print': 'None', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'static_parser': 'True', 'introspect': 'True', 'printer_width': '80', 'version_check': 'True', 'write_json': 'True', 'fail_fast': 'False', 'indirect_selection': 'eager', 'quiet': 'False', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'log_cache_events': 'False', 'empty': 'False', 'warn_error': 'None', 'use_colors': 'True', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'invocation_command': 'dbt run', 'partial_parse': 'True', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'debug': 'False'}
[0m15:26:58.271895 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1072ee8b0>]}
[0m15:26:58.309830 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105d41370>]}
[0m15:26:58.310191 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m15:26:58.430964 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m15:26:58.539244 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m15:26:58.539628 [debug] [MainThread]: Nothing changed, skipping partial parsing.
[0m15:26:58.539814 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m15:26:58.563738 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15611cc50>]}
[0m15:26:58.608304 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:26:58.609658 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:26:58.624607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x153981e50>]}
[0m15:26:58.624878 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m15:26:58.625056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x154fd7150>]}
[0m15:26:58.626267 [info ] [MainThread]: 
[0m15:26:58.626448 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:26:58.626583 [info ] [MainThread]: 
[0m15:26:58.626831 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:26:58.628903 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:26:58.629153 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:26:58.629395 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:26:58.629716 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:26:58.629939 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:26:58.630089 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:26:58.630287 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:26:58.630512 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:27:00.340991 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m15:27:00.342663 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:27:00.343353 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m15:27:00.345049 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m15:27:00.345904 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m15:27:00.346350 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:27:00.347338 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:27:00.347787 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:27:00.789433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x154f4cd50>]}
[0m15:27:00.791562 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:27:00.796893 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:27:00.797560 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:27:00.798399 [info ] [Thread-2 (]: 2 of 9 START sql view model health_insurance_dev_staging.stg_person_dim_raw .... [RUN]
[0m15:27:00.799205 [info ] [Thread-1 (]: 1 of 9 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m15:27:00.799879 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.stg_person_dim_raw)
[0m15:27:00.800400 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m15:27:00.800908 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m15:27:00.801370 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:27:00.822571 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:27:00.825219 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:27:00.826478 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m15:27:00.838807 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:27:00.854060 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:27:00.854764 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:27:00.855609 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m15:27:00.855893 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:27:00.856755 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m15:27:00.857101 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:27:01.765935 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:583de747-e7a1-4da0-a447-0f8a56ce526d&page=queryresults
[0m15:27:01.767236 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:2d6ad1f2-b4e5-4262-a7fb-af1413c006b7&page=queryresults
[0m15:27:02.243525 [debug] [Thread-2 (]: SQL status: OK in 0.475 seconds
[0m15:27:02.247121 [debug] [Thread-1 (]: SQL status: OK in 0.478 seconds
[0m15:27:02.338097 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1562a1310>]}
[0m15:27:02.338296 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15622e620>]}
[0m15:27:02.338649 [info ] [Thread-1 (]: 1 of 9 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m15:27:02.338916 [info ] [Thread-2 (]: 2 of 9 OK created sql view model health_insurance_dev_staging.stg_person_dim_raw  [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m15:27:02.339325 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:27:02.339602 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:27:02.340037 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m15:27:02.340242 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m15:27:02.340422 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.int_person_deduped)
[0m15:27:02.340629 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.int_person_cleaned)
[0m15:27:02.340793 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m15:27:02.340953 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m15:27:02.343033 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m15:27:02.345335 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m15:27:02.347090 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:27:02.347302 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:27:02.348040 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m15:27:02.348421 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m15:27:02.348733 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.dim_person
[0m15:27:02.348995 [info ] [Thread-1 (]: 3 of 9 START sql table model health_insurance_dev_core.dim_person .............. [RUN]
[0m15:27:02.349199 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.dim_person)
[0m15:27:02.349366 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m15:27:02.356264 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m15:27:02.357460 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.dim_person
[0m15:27:02.374694 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.dim_person"
[0m15:27:02.376485 [debug] [Thread-1 (]: On model.health_insurance_dbt.dim_person: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.dim_person"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Conformed person dimension (SCD Type 1)
-- Grain: One row per person_id
-- Business key: person_id

WITH  __dbt__cte__int_person_deduped as (


-- Parse dates, standardize categories, extract address components
-- Each raw row is cleaned but duplicates remain

WITH source AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
),

-- Date parsing logic for birthdate
birthdate_parsed AS (
  SELECT
    person_id,
    birthdate_raw,
    
    -- Try multiple date formats
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', birthdate_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', birthdate_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', birthdate_raw),
      
      -- Slash format with heuristic (birthdate defaults to MM/DD/...)
      CASE
        -- Check if it's a slash-delimited date
        WHEN REGEXP_CONTAINS(birthdate_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            -- Extract parts
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to MM/DD/... for birthdate
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS birthdate_parsed
  FROM source
),

-- Date parsing logic for insurance_sign_up_date
signup_date_parsed AS (
  SELECT
    person_id,
    insurance_sign_up_date_raw,
    
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', insurance_sign_up_date_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', insurance_sign_up_date_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', insurance_sign_up_date_raw),
      
      -- Slash format with heuristic (signup defaults to DD/MM/...)
      CASE
        WHEN REGEXP_CONTAINS(insurance_sign_up_date_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to DD/MM/... for signup date
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS insurance_sign_up_date_parsed
  FROM source
),

-- Address parsing
address_parsed AS (
  SELECT
    person_id,
    address_raw,
    REGEXP_REPLACE(TRIM(address_raw), r'\s+', ' ') AS address_clean,
    REGEXP_EXTRACT(address_raw, r'\b(\d{5})\b') AS postal_code,
    INITCAP(TRIM(REGEXP_EXTRACT(address_raw, r'\d{5}\s+(.+)$'))) AS city,
    TRIM(SPLIT(address_raw, ',')[SAFE_OFFSET(0)]) AS street_and_number
  FROM source
)

-- Final cleaned output
SELECT
  s.person_id,
  
  -- Dates with parse error flags
  bd.birthdate_parsed,
  CASE WHEN bd.birthdate_parsed IS NULL AND s.birthdate_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS birthdate_parse_error,
  
  sd.insurance_sign_up_date_parsed,
  CASE WHEN sd.insurance_sign_up_date_parsed IS NULL AND s.insurance_sign_up_date_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_sign_up_date_parse_error,
  
  -- Address components
  ap.address_raw,
  ap.address_clean,
  ap.postal_code,
  ap.city,
  ap.street_and_number,
  
  -- Standardized gender
  CASE
    WHEN UPPER(TRIM(s.gender_raw)) IN ('M', 'MALE') THEN 'male'
    WHEN UPPER(TRIM(s.gender_raw)) IN ('F', 'FEMALE') THEN 'female'
    ELSE 'unknown'
  END AS gender_std,
  
  -- Standardized family status
  CASE
    WHEN UPPER(TRIM(s.family_status_raw)) = 'SINGLE' THEN 'single'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'MARRIED' THEN 'married'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'DIVORCED' THEN 'divorced'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'WIDOWED' THEN 'widowed'
    ELSE 'unknown'
  END AS family_status_std,
  
  -- Standardized insurance status
  CASE
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'ACTIVE' THEN 'active'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'INACTIVE' THEN 'inactive'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'PENDING' THEN 'pending'
    ELSE 'unknown'
  END AS insurance_status_std,
  
  -- Cleaned occupational category
  CASE 
    WHEN TRIM(s.occupational_category_raw) = '' THEN NULL
    ELSE TRIM(s.occupational_category_raw)
  END AS occupational_category_clean,
  
  -- Standardized wealth bracket
  CASE
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('LOW', 'LOWER') THEN 'low'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) = 'MEDIUM' THEN 'medium'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('UPPER_MIDDLE', 'UPPER MIDDLE', 'UPPERMIDDLE') THEN 'upper_middle'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('HIGH', 'UPPER') THEN 'high'
    ELSE 'unknown'
  END AS wealth_bracket_std

FROM source s
LEFT JOIN birthdate_parsed bd USING (person_id)
LEFT JOIN signup_date_parsed sd USING (person_id)
LEFT JOIN address_parsed ap USING (person_id)
), deduped AS (
  SELECT * FROM __dbt__cte__int_person_deduped
)

SELECT
  person_id,
  
  -- Demographic attributes
  birthdate_parsed AS birthdate,
  CASE 
    WHEN birthdate_parsed IS NOT NULL 
    THEN DATE_DIFF(CURRENT_DATE(), birthdate_parsed, YEAR)
    ELSE NULL 
  END AS age_years,
  gender_std AS gender,
  family_status_std AS family_status,
  
  -- Insurance attributes
  insurance_status_std AS insurance_status,
  insurance_sign_up_date_parsed AS insurance_sign_up_date,
  EXTRACT(YEAR FROM insurance_sign_up_date_parsed) AS signup_year,
  FORMAT_DATE('%Y-%m', insurance_sign_up_date_parsed) AS signup_month,
  
  -- Economic attributes
  occupational_category_clean AS occupational_category,
  wealth_bracket_std AS wealth_bracket,
  
  -- Address attributes
  address_clean AS address,
  street_and_number,
  postal_code,
  city,
  
  -- Data quality flags
  birthdate_parse_error,
  insurance_sign_up_date_parse_error,
  completeness_score,
  
  -- Metadata
  dedupe_processed_at,
  CURRENT_TIMESTAMP() AS dim_updated_at

FROM deduped
    );
  
[0m15:27:02.376974 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:27:03.422823 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:c6264656-0c1c-4efc-83d8-684c1602066e&page=queryresults
[0m15:27:03.582988 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:c6264656-0c1c-4efc-83d8-684c1602066e&page=queryresults
[0m15:27:03.602353 [debug] [Thread-1 (]: Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: completeness_score at [281:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql
[0m15:27:03.603259 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'e27ca6b7-efda-4751-90fb-039ec9b1b5d7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15661f890>]}
[0m15:27:03.604250 [error] [Thread-1 (]: 3 of 9 ERROR creating sql table model health_insurance_dev_core.dim_person ..... [[31mERROR[0m in 1.25s]
[0m15:27:03.605260 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.dim_person
[0m15:27:03.606015 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.dim_person' to be skipped because of status 'error'.  Reason: Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: completeness_score at [281:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql.
[0m15:27:03.607859 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:27:03.608464 [info ] [Thread-2 (]: 4 of 9 SKIP relation health_insurance_dev_core.fact_insurance_yearly ........... [[33mSKIP[0m]
[0m15:27:03.609114 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:27:03.609828 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m15:27:03.610257 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:27:03.610777 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:27:03.611188 [info ] [Thread-3 (]: 6 of 9 SKIP relation health_insurance_dev_marts.mart_person_kpis ............... [[33mSKIP[0m]
[0m15:27:03.611614 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.negative_costs
[0m15:27:03.611986 [info ] [Thread-4 (]: 5 of 9 SKIP relation health_insurance_dev_marts.mart_city_year_kpis ............ [[33mSKIP[0m]
[0m15:27:03.612404 [info ] [Thread-1 (]: 7 of 9 SKIP relation health_insurance_dev_marts.mart_yearly_kpis ............... [[33mSKIP[0m]
[0m15:27:03.612829 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m15:27:03.613209 [info ] [Thread-2 (]: 8 of 9 SKIP relation health_insurance_dev.negative_costs ....................... [[33mSKIP[0m]
[0m15:27:03.613596 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:27:03.613921 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:27:03.614258 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m15:27:03.614619 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m15:27:03.615074 [info ] [Thread-3 (]: 9 of 9 SKIP relation health_insurance_dev.visits_reasonable .................... [[33mSKIP[0m]
[0m15:27:03.615355 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m15:27:03.616201 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:27:03.616552 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:27:03.616933 [debug] [MainThread]: Connection 'model.health_insurance_dbt.dim_person' was properly closed.
[0m15:27:03.617101 [debug] [MainThread]: Connection 'model.health_insurance_dbt.stg_person_dim_raw' was properly closed.
[0m15:27:03.617244 [debug] [MainThread]: Connection 'model.health_insurance_dbt.int_person_cleaned' was properly closed.
[0m15:27:03.617381 [debug] [MainThread]: Connection 'model.health_insurance_dbt.int_person_deduped' was properly closed.
[0m15:27:03.617636 [info ] [MainThread]: 
[0m15:27:03.617827 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 4 view models in 0 hours 0 minutes and 4.99 seconds (4.99s).
[0m15:27:03.618438 [debug] [MainThread]: Command end result
[0m15:27:03.642720 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:27:03.644687 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:27:03.648889 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m15:27:03.649120 [info ] [MainThread]: 
[0m15:27:03.649316 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:27:03.649472 [info ] [MainThread]: 
[0m15:27:03.649870 [error] [MainThread]: [31mFailure in model dim_person (models/core/dim_person.sql)[0m
[0m15:27:03.650094 [error] [MainThread]:   Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: completeness_score at [281:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql
[0m15:27:03.650235 [info ] [MainThread]: 
[0m15:27:03.650399 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/core/dim_person.sql
[0m15:27:03.650652 [info ] [MainThread]: 
[0m15:27:03.651061 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=6 NO-OP=0 TOTAL=9
[0m15:27:03.652966 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 18.788046, "process_in_blocks": "0", "process_kernel_time": 5.592278, "process_mem_max_rss": "454164480", "process_out_blocks": "0", "process_user_time": 9.783171}
[0m15:27:03.653659 [debug] [MainThread]: Command `dbt run` failed at 15:27:03.653600 after 18.79 seconds
[0m15:27:03.654394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x154f69750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1566387d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108c3cf30>]}
[0m15:27:03.654591 [debug] [MainThread]: Flushing usage events
[0m15:27:04.782165 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:29:49.798898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107f5ae40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a093890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a093b10>]}


============================== 15:29:49.804788 | 896ffd1c-326e-4e0d-965f-cea69a06863a ==============================
[0m15:29:49.804788 [info ] [MainThread]: Running with dbt=1.11.2
[0m15:29:49.805133 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'write_json': 'True', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'no_print': 'None', 'debug': 'False', 'target_path': 'None', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'introspect': 'True', 'log_format': 'default', 'version_check': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'quiet': 'False', 'partial_parse': 'True', 'printer_width': '80', 'fail_fast': 'False', 'warn_error': 'None'}
[0m15:30:03.233468 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10882e8b0>]}
[0m15:30:03.272945 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107db1370>]}
[0m15:30:03.273344 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m15:30:03.414163 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m15:30:03.549385 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:30:03.550303 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/core/fact_insurance_yearly.sql
[0m15:30:03.550529 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/core/dim_person.sql
[0m15:30:03.814436 [warn ] [MainThread]: [[33mWARNING[0m][MissingArgumentsPropertyInGenericTestDeprecation]: Deprecated
functionality
Found top-level arguments to test `relationships` defined on
'fact_insurance_yearly' in package 'health_insurance_dbt'
(models/core/schema.yml). Arguments to generic tests should be nested under the
`arguments` property.
[0m15:30:03.814847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10959ba50>]}
[0m15:30:03.892870 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x159592120>]}
[0m15:30:03.940068 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:30:03.942128 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:30:04.130712 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x159554670>]}
[0m15:30:04.131013 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m15:30:04.131181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15a85bee0>]}
[0m15:30:04.132369 [info ] [MainThread]: 
[0m15:30:04.132565 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:30:04.132699 [info ] [MainThread]: 
[0m15:30:04.132939 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:30:04.135186 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:30:04.135450 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:30:04.135618 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:30:04.135871 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:30:04.136023 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:30:04.136252 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:30:04.136645 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:30:04.137045 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:30:06.264767 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m15:30:06.266552 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m15:30:06.267313 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:30:06.267856 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m15:30:06.268461 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:30:06.269109 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m15:30:06.270744 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:30:06.272457 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:30:06.814548 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15a868a10>]}
[0m15:30:06.815682 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:30:06.822382 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:30:06.822946 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:30:06.823917 [info ] [Thread-1 (]: 1 of 9 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m15:30:06.825197 [info ] [Thread-2 (]: 2 of 9 START sql view model health_insurance_dev_staging.stg_person_dim_raw .... [RUN]
[0m15:30:06.825967 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m15:30:06.826601 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_person_dim_raw)
[0m15:30:06.827164 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:30:06.827657 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m15:30:06.838507 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:30:06.842957 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:30:06.844237 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:30:06.844529 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m15:30:06.867593 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:30:06.867979 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:30:06.869159 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m15:30:06.869570 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:30:06.870423 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m15:30:06.870701 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:30:07.607696 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:8030f9a6-ad95-480b-8fb8-bbb1823a1510&page=queryresults
[0m15:30:07.628648 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:bd014c03-fafd-4d10-b95a-346e393c2f1e&page=queryresults
[0m15:30:07.984898 [debug] [Thread-2 (]: SQL status: OK in 0.355 seconds
[0m15:30:07.999013 [debug] [Thread-1 (]: SQL status: OK in 0.390 seconds
[0m15:30:08.078826 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1577d3cd0>]}
[0m15:30:08.079604 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15a85f890>]}
[0m15:30:08.080053 [info ] [Thread-1 (]: 1 of 9 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m15:30:08.080349 [info ] [Thread-2 (]: 2 of 9 OK created sql view model health_insurance_dev_staging.stg_person_dim_raw  [[32mCREATE VIEW (0 processed)[0m in 1.25s]
[0m15:30:08.080779 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:30:08.081064 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:30:08.082202 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m15:30:08.082624 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m15:30:08.082867 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.int_person_deduped)
[0m15:30:08.083106 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.int_person_cleaned)
[0m15:30:08.083285 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m15:30:08.083446 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m15:30:08.085868 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m15:30:08.089100 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m15:30:08.090577 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:30:08.091161 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:30:08.091856 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m15:30:08.092291 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m15:30:08.092655 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.dim_person
[0m15:30:08.092913 [info ] [Thread-1 (]: 3 of 9 START sql table model health_insurance_dev_core.dim_person .............. [RUN]
[0m15:30:08.093130 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.dim_person)
[0m15:30:08.093300 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m15:30:08.098757 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m15:30:08.099644 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.dim_person
[0m15:30:08.117906 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.dim_person"
[0m15:30:08.118978 [debug] [Thread-1 (]: On model.health_insurance_dbt.dim_person: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.dim_person"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Conformed person dimension (SCD Type 1)
-- Grain: One row per person_id
-- Business key: person_id

WITH  __dbt__cte__int_person_deduped as (


-- Parse dates, standardize categories, extract address components
-- Each raw row is cleaned but duplicates remain

WITH source AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
),

-- Date parsing logic for birthdate
birthdate_parsed AS (
  SELECT
    person_id,
    birthdate_raw,
    
    -- Try multiple date formats
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', birthdate_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', birthdate_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', birthdate_raw),
      
      -- Slash format with heuristic (birthdate defaults to MM/DD/...)
      CASE
        -- Check if it's a slash-delimited date
        WHEN REGEXP_CONTAINS(birthdate_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            -- Extract parts
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to MM/DD/... for birthdate
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS birthdate_parsed
  FROM source
),

-- Date parsing logic for insurance_sign_up_date
signup_date_parsed AS (
  SELECT
    person_id,
    insurance_sign_up_date_raw,
    
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', insurance_sign_up_date_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', insurance_sign_up_date_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', insurance_sign_up_date_raw),
      
      -- Slash format with heuristic (signup defaults to DD/MM/...)
      CASE
        WHEN REGEXP_CONTAINS(insurance_sign_up_date_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to DD/MM/... for signup date
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS insurance_sign_up_date_parsed
  FROM source
),

-- Address parsing
address_parsed AS (
  SELECT
    person_id,
    address_raw,
    REGEXP_REPLACE(TRIM(address_raw), r'\s+', ' ') AS address_clean,
    REGEXP_EXTRACT(address_raw, r'\b(\d{5})\b') AS postal_code,
    INITCAP(TRIM(REGEXP_EXTRACT(address_raw, r'\d{5}\s+(.+)$'))) AS city,
    TRIM(SPLIT(address_raw, ',')[SAFE_OFFSET(0)]) AS street_and_number
  FROM source
)

-- Final cleaned output
SELECT
  s.person_id,
  
  -- Dates with parse error flags
  bd.birthdate_parsed,
  CASE WHEN bd.birthdate_parsed IS NULL AND s.birthdate_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS birthdate_parse_error,
  
  sd.insurance_sign_up_date_parsed,
  CASE WHEN sd.insurance_sign_up_date_parsed IS NULL AND s.insurance_sign_up_date_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_sign_up_date_parse_error,
  
  -- Address components
  ap.address_raw,
  ap.address_clean,
  ap.postal_code,
  ap.city,
  ap.street_and_number,
  
  -- Standardized gender
  CASE
    WHEN UPPER(TRIM(s.gender_raw)) IN ('M', 'MALE') THEN 'male'
    WHEN UPPER(TRIM(s.gender_raw)) IN ('F', 'FEMALE') THEN 'female'
    ELSE 'unknown'
  END AS gender_std,
  
  -- Standardized family status
  CASE
    WHEN UPPER(TRIM(s.family_status_raw)) = 'SINGLE' THEN 'single'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'MARRIED' THEN 'married'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'DIVORCED' THEN 'divorced'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'WIDOWED' THEN 'widowed'
    ELSE 'unknown'
  END AS family_status_std,
  
  -- Standardized insurance status
  CASE
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'ACTIVE' THEN 'active'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'INACTIVE' THEN 'inactive'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'PENDING' THEN 'pending'
    ELSE 'unknown'
  END AS insurance_status_std,
  
  -- Cleaned occupational category
  CASE 
    WHEN TRIM(s.occupational_category_raw) = '' THEN NULL
    ELSE TRIM(s.occupational_category_raw)
  END AS occupational_category_clean,
  
  -- Standardized wealth bracket
  CASE
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('LOW', 'LOWER') THEN 'low'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) = 'MEDIUM' THEN 'medium'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('UPPER_MIDDLE', 'UPPER MIDDLE', 'UPPERMIDDLE') THEN 'upper_middle'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('HIGH', 'UPPER') THEN 'high'
    ELSE 'unknown'
  END AS wealth_bracket_std

FROM source s
LEFT JOIN birthdate_parsed bd USING (person_id)
LEFT JOIN signup_date_parsed sd USING (person_id)
LEFT JOIN address_parsed ap USING (person_id)
), deduped AS (
  SELECT * FROM __dbt__cte__int_person_deduped
)

SELECT
  person_id,
  
  -- Demographic attributes
  birthdate_parsed AS birthdate,
  CASE 
    WHEN birthdate_parsed IS NOT NULL 
    THEN DATE_DIFF(CURRENT_DATE(), birthdate_parsed, YEAR)
    ELSE NULL 
  END AS age_years,
  gender_std AS gender,
  family_status_std AS family_status,
  
  -- Insurance attributes
  insurance_status_std AS insurance_status,
  insurance_sign_up_date_parsed AS insurance_sign_up_date,
  EXTRACT(YEAR FROM insurance_sign_up_date_parsed) AS signup_year,
  FORMAT_DATE('%Y-%m', insurance_sign_up_date_parsed) AS signup_month,
  
  -- Economic attributes
  occupational_category_clean AS occupational_category,
  wealth_bracket_std AS wealth_bracket,
  
  -- Address attributes
  address_clean AS address,
  street_and_number,
  postal_code,
  city,
  
  -- Data quality flags
  birthdate_parse_error,
  insurance_sign_up_date_parse_error,
  
  -- Metadata
  dedupe_processed_at,
  CURRENT_TIMESTAMP() AS dim_updated_at

FROM deduped
    );
  
[0m15:30:08.119494 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:30:09.181691 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:32e8bc5f-8d8f-473f-ba65-2c0830995694&page=queryresults
[0m15:30:09.366794 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:32e8bc5f-8d8f-473f-ba65-2c0830995694&page=queryresults
[0m15:30:09.377790 [debug] [Thread-1 (]: Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: dedupe_processed_at at [283:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql
[0m15:30:09.378239 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '896ffd1c-326e-4e0d-965f-cea69a06863a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15ab858d0>]}
[0m15:30:09.378629 [error] [Thread-1 (]: 3 of 9 ERROR creating sql table model health_insurance_dev_core.dim_person ..... [[31mERROR[0m in 1.29s]
[0m15:30:09.378966 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.dim_person
[0m15:30:09.379301 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.dim_person' to be skipped because of status 'error'.  Reason: Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: dedupe_processed_at at [283:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql.
[0m15:30:09.382281 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:30:09.382758 [info ] [Thread-2 (]: 4 of 9 SKIP relation health_insurance_dev_core.fact_insurance_yearly ........... [[33mSKIP[0m]
[0m15:30:09.383008 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:30:09.383325 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:30:09.383652 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m15:30:09.383903 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.negative_costs
[0m15:30:09.384099 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:30:09.383506 [info ] [Thread-1 (]: 7 of 9 SKIP relation health_insurance_dev_marts.mart_yearly_kpis ............... [[33mSKIP[0m]
[0m15:30:09.384337 [info ] [Thread-3 (]: 6 of 9 SKIP relation health_insurance_dev_marts.mart_person_kpis ............... [[33mSKIP[0m]
[0m15:30:09.384531 [info ] [Thread-2 (]: 8 of 9 SKIP relation health_insurance_dev.negative_costs ....................... [[33mSKIP[0m]
[0m15:30:09.384731 [info ] [Thread-4 (]: 5 of 9 SKIP relation health_insurance_dev_marts.mart_city_year_kpis ............ [[33mSKIP[0m]
[0m15:30:09.384932 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:30:09.385094 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m15:30:09.385250 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m15:30:09.385414 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:30:09.385602 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m15:30:09.385932 [info ] [Thread-1 (]: 9 of 9 SKIP relation health_insurance_dev.visits_reasonable .................... [[33mSKIP[0m]
[0m15:30:09.386119 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m15:30:09.386810 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:30:09.388136 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:30:09.388327 [debug] [MainThread]: Connection 'model.health_insurance_dbt.dim_person' was properly closed.
[0m15:30:09.388462 [debug] [MainThread]: Connection 'model.health_insurance_dbt.stg_person_dim_raw' was properly closed.
[0m15:30:09.388582 [debug] [MainThread]: Connection 'model.health_insurance_dbt.int_person_cleaned' was properly closed.
[0m15:30:09.388697 [debug] [MainThread]: Connection 'model.health_insurance_dbt.int_person_deduped' was properly closed.
[0m15:30:09.388897 [info ] [MainThread]: 
[0m15:30:09.389071 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 4 view models in 0 hours 0 minutes and 5.26 seconds (5.26s).
[0m15:30:09.389742 [debug] [MainThread]: Command end result
[0m15:30:09.411017 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:30:09.413009 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:30:09.416839 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m15:30:09.417031 [info ] [MainThread]: 
[0m15:30:09.417218 [info ] [MainThread]: [31mCompleted with 1 error, 0 partial successes, and 0 warnings:[0m
[0m15:30:09.417365 [info ] [MainThread]: 
[0m15:30:09.417552 [error] [MainThread]: [31mFailure in model dim_person (models/core/dim_person.sql)[0m
[0m15:30:09.417721 [error] [MainThread]:   Database Error in model dim_person (models/core/dim_person.sql)
  Unrecognized name: dedupe_processed_at at [283:3]
  compiled code at target/run/health_insurance_dbt/models/core/dim_person.sql
[0m15:30:09.417845 [info ] [MainThread]: 
[0m15:30:09.417997 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/core/dim_person.sql
[0m15:30:09.418131 [info ] [MainThread]: 
[0m15:30:09.418295 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=6 NO-OP=0 TOTAL=9
[0m15:30:09.418711 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- MissingArgumentsPropertyInGenericTestDeprecation: 5 occurrences
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m15:30:09.419144 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 19.668732, "process_in_blocks": "0", "process_kernel_time": 5.761979, "process_mem_max_rss": "428392448", "process_out_blocks": "0", "process_user_time": 10.13982}
[0m15:30:09.419432 [debug] [MainThread]: Command `dbt run` failed at 15:30:09.419381 after 19.67 seconds
[0m15:30:09.419707 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a13cf30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050ade10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15acdfa70>]}
[0m15:30:09.419990 [debug] [MainThread]: Flushing usage events
[0m15:30:10.315241 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:30:46.089286 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10456ee40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ae7890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105ae7b10>]}


============================== 15:30:46.092854 | c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4 ==============================
[0m15:30:46.092854 [info ] [MainThread]: Running with dbt=1.11.2
[0m15:30:46.093184 [debug] [MainThread]: running dbt with arguments {'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'version_check': 'True', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'partial_parse': 'True', 'log_format': 'default', 'target_path': 'None', 'printer_width': '80', 'write_json': 'True', 'static_parser': 'True', 'cache_selected_only': 'False', 'no_print': 'None', 'warn_error': 'None', 'quiet': 'False', 'invocation_command': 'dbt run', 'use_colors': 'True', 'debug': 'False', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'empty': 'False', 'log_cache_events': 'False', 'fail_fast': 'False'}
[0m15:30:59.362402 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e428b0>]}
[0m15:30:59.400409 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1043c5370>]}
[0m15:30:59.400748 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m15:30:59.536514 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m15:30:59.648686 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 1 files changed.
[0m15:30:59.649212 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/core/fact_insurance_yearly.sql
[0m15:30:59.649375 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/core/dim_person.sql
[0m15:30:59.864772 [warn ] [MainThread]: [[33mWARNING[0m][MissingArgumentsPropertyInGenericTestDeprecation]: Deprecated
functionality
Found top-level arguments to test `relationships` defined on
'fact_insurance_yearly' in package 'health_insurance_dbt'
(models/core/schema.yml). Arguments to generic tests should be nested under the
`arguments` property.
[0m15:30:59.865106 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'deprecation', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'property_': 'warn', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15512e550>]}
[0m15:30:59.932161 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15526e7b0>]}
[0m15:30:59.980576 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:30:59.981864 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:31:00.122350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15524c2f0>]}
[0m15:31:00.122657 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m15:31:00.122825 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105975d90>]}
[0m15:31:00.124048 [info ] [MainThread]: 
[0m15:31:00.124230 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:31:00.124364 [info ] [MainThread]: 
[0m15:31:00.124600 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:31:00.126709 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:31:00.126876 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:00.127215 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:31:00.127401 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:00.127704 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:31:00.127852 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:00.128108 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:31:00.128443 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:31:01.697518 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m15:31:01.698829 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m15:31:01.699429 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:31:01.700065 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m15:31:01.700685 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:31:01.701245 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m15:31:01.702905 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:31:01.704606 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:31:02.116091 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1554684d0>]}
[0m15:31:02.117242 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:31:02.122768 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:31:02.123527 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:31:02.124397 [info ] [Thread-1 (]: 1 of 9 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m15:31:02.125252 [info ] [Thread-2 (]: 2 of 9 START sql view model health_insurance_dev_staging.stg_person_dim_raw .... [RUN]
[0m15:31:02.126126 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m15:31:02.126734 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.stg_person_dim_raw)
[0m15:31:02.127275 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:31:02.127736 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m15:31:02.145893 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:31:02.147376 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:31:02.148365 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m15:31:02.148744 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:31:02.176840 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:31:02.178016 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:31:02.178893 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m15:31:02.179209 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m15:31:02.179522 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:31:02.179731 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:31:02.887027 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:609ab179-823f-484c-b6d6-d967f77d6f2c&page=queryresults
[0m15:31:02.951607 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:ed4f5104-1c66-4110-8033-009177be61d8&page=queryresults
[0m15:31:03.306664 [debug] [Thread-1 (]: SQL status: OK in 0.354 seconds
[0m15:31:03.320112 [debug] [Thread-2 (]: SQL status: OK in 0.432 seconds
[0m15:31:03.399288 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x154ed3800>]}
[0m15:31:03.399557 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15533aa30>]}
[0m15:31:03.399920 [info ] [Thread-1 (]: 1 of 9 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m15:31:03.400571 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:31:03.400285 [info ] [Thread-2 (]: 2 of 9 OK created sql view model health_insurance_dev_staging.stg_person_dim_raw  [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m15:31:03.400915 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:31:03.401388 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m15:31:03.401602 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m15:31:03.401827 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now model.health_insurance_dbt.int_person_cleaned)
[0m15:31:03.402058 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.int_person_deduped)
[0m15:31:03.402233 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m15:31:03.402397 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m15:31:03.404530 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m15:31:03.406642 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m15:31:03.407534 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:31:03.407746 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:31:03.408146 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m15:31:03.408509 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m15:31:03.408863 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.dim_person
[0m15:31:03.409156 [info ] [Thread-1 (]: 3 of 9 START sql table model health_insurance_dev_core.dim_person .............. [RUN]
[0m15:31:03.409392 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.dim_person)
[0m15:31:03.409566 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m15:31:03.415121 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m15:31:03.416006 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.dim_person
[0m15:31:03.432375 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.dim_person"
[0m15:31:03.433497 [debug] [Thread-1 (]: On model.health_insurance_dbt.dim_person: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.dim_person"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Conformed person dimension (SCD Type 1)
-- Grain: One row per person_id
-- Business key: person_id

WITH  __dbt__cte__int_person_deduped as (


-- Parse dates, standardize categories, extract address components
-- Each raw row is cleaned but duplicates remain

WITH source AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
),

-- Date parsing logic for birthdate
birthdate_parsed AS (
  SELECT
    person_id,
    birthdate_raw,
    
    -- Try multiple date formats
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', birthdate_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', birthdate_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', birthdate_raw),
      
      -- Slash format with heuristic (birthdate defaults to MM/DD/...)
      CASE
        -- Check if it's a slash-delimited date
        WHEN REGEXP_CONTAINS(birthdate_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            -- Extract parts
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to MM/DD/... for birthdate
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS birthdate_parsed
  FROM source
),

-- Date parsing logic for insurance_sign_up_date
signup_date_parsed AS (
  SELECT
    person_id,
    insurance_sign_up_date_raw,
    
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', insurance_sign_up_date_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', insurance_sign_up_date_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', insurance_sign_up_date_raw),
      
      -- Slash format with heuristic (signup defaults to DD/MM/...)
      CASE
        WHEN REGEXP_CONTAINS(insurance_sign_up_date_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to DD/MM/... for signup date
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS insurance_sign_up_date_parsed
  FROM source
),

-- Address parsing
address_parsed AS (
  SELECT
    person_id,
    address_raw,
    REGEXP_REPLACE(TRIM(address_raw), r'\s+', ' ') AS address_clean,
    REGEXP_EXTRACT(address_raw, r'\b(\d{5})\b') AS postal_code,
    INITCAP(TRIM(REGEXP_EXTRACT(address_raw, r'\d{5}\s+(.+)$'))) AS city,
    TRIM(SPLIT(address_raw, ',')[SAFE_OFFSET(0)]) AS street_and_number
  FROM source
)

-- Final cleaned output
SELECT
  s.person_id,
  
  -- Dates with parse error flags
  bd.birthdate_parsed,
  CASE WHEN bd.birthdate_parsed IS NULL AND s.birthdate_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS birthdate_parse_error,
  
  sd.insurance_sign_up_date_parsed,
  CASE WHEN sd.insurance_sign_up_date_parsed IS NULL AND s.insurance_sign_up_date_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_sign_up_date_parse_error,
  
  -- Address components
  ap.address_raw,
  ap.address_clean,
  ap.postal_code,
  ap.city,
  ap.street_and_number,
  
  -- Standardized gender
  CASE
    WHEN UPPER(TRIM(s.gender_raw)) IN ('M', 'MALE') THEN 'male'
    WHEN UPPER(TRIM(s.gender_raw)) IN ('F', 'FEMALE') THEN 'female'
    ELSE 'unknown'
  END AS gender_std,
  
  -- Standardized family status
  CASE
    WHEN UPPER(TRIM(s.family_status_raw)) = 'SINGLE' THEN 'single'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'MARRIED' THEN 'married'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'DIVORCED' THEN 'divorced'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'WIDOWED' THEN 'widowed'
    ELSE 'unknown'
  END AS family_status_std,
  
  -- Standardized insurance status
  CASE
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'ACTIVE' THEN 'active'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'INACTIVE' THEN 'inactive'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'PENDING' THEN 'pending'
    ELSE 'unknown'
  END AS insurance_status_std,
  
  -- Cleaned occupational category
  CASE 
    WHEN TRIM(s.occupational_category_raw) = '' THEN NULL
    ELSE TRIM(s.occupational_category_raw)
  END AS occupational_category_clean,
  
  -- Standardized wealth bracket
  CASE
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('LOW', 'LOWER') THEN 'low'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) = 'MEDIUM' THEN 'medium'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('UPPER_MIDDLE', 'UPPER MIDDLE', 'UPPERMIDDLE') THEN 'upper_middle'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('HIGH', 'UPPER') THEN 'high'
    ELSE 'unknown'
  END AS wealth_bracket_std

FROM source s
LEFT JOIN birthdate_parsed bd USING (person_id)
LEFT JOIN signup_date_parsed sd USING (person_id)
LEFT JOIN address_parsed ap USING (person_id)
), deduped AS (
  SELECT * FROM __dbt__cte__int_person_deduped
)

SELECT
  person_id,
  
  -- Demographic attributes
  birthdate_parsed AS birthdate,
  CASE 
    WHEN birthdate_parsed IS NOT NULL 
    THEN DATE_DIFF(CURRENT_DATE(), birthdate_parsed, YEAR)
    ELSE NULL 
  END AS age_years,
  gender_std AS gender,
  family_status_std AS family_status,
  
  -- Insurance attributes
  insurance_status_std AS insurance_status,
  insurance_sign_up_date_parsed AS insurance_sign_up_date,
  EXTRACT(YEAR FROM insurance_sign_up_date_parsed) AS signup_year,
  FORMAT_DATE('%Y-%m', insurance_sign_up_date_parsed) AS signup_month,
  
  -- Economic attributes
  occupational_category_clean AS occupational_category,
  wealth_bracket_std AS wealth_bracket,
  
  -- Address attributes
  address_clean AS address,
  street_and_number,
  postal_code,
  city,
  
  -- Data quality flags
  birthdate_parse_error,
  insurance_sign_up_date_parse_error,
  CURRENT_TIMESTAMP() AS dim_updated_at

FROM deduped
    );
  
[0m15:31:03.433958 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:31:04.599486 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:1de63f2f-9646-40a4-8a52-47a97a7feaf4&page=queryresults
[0m15:31:06.188143 [debug] [Thread-1 (]: SQL status: OK in 1.587 seconds
[0m15:31:06.430986 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15b18f850>]}
[0m15:31:06.433019 [info ] [Thread-1 (]: 3 of 9 OK created sql table model health_insurance_dev_core.dim_person ......... [[32mCREATE TABLE (166.0 rows, 12.4 KiB processed)[0m in 3.02s]
[0m15:31:06.434817 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.dim_person
[0m15:31:06.436178 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:31:06.437178 [info ] [Thread-2 (]: 4 of 9 START sql incremental model health_insurance_dev_core.fact_insurance_yearly  [RUN]
[0m15:31:06.437955 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_person_dim_raw, now model.health_insurance_dbt.fact_insurance_yearly)
[0m15:31:06.438524 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.fact_insurance_yearly
[0m15:31:06.446787 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:31:06.449403 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.fact_insurance_yearly
[0m15:31:06.495281 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:31:06.496026 [debug] [Thread-2 (]: On model.health_insurance_dbt.fact_insurance_yearly: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.fact_insurance_yearly"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Insurance facts by person and year
-- Grain: One row per person_id + year
-- Incremental strategy: Merge on (person_id, year)

WITH facts_raw AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
),

person_dim AS (
  SELECT person_id FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  f.person_id,
  f.year,
  
  -- Metrics
  f.insurance_cost_year,
  f.annual_doctor_visits,
  f.annual_cost_to_insurance,
  
  -- Data quality flags
  f.insurance_cost_year_parse_error,
  f.annual_doctor_visits_parse_error,
  f.annual_cost_to_insurance_parse_error,
  f.year_parse_error,
  
  -- Referential integrity check
  CASE WHEN p.person_id IS NULL THEN TRUE ELSE FALSE END AS orphan_record,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS fact_updated_at

FROM facts_raw f
LEFT JOIN person_dim p USING (person_id)

WHERE f.year IS NOT NULL
  AND f.person_id IS NOT NULL


    );
  
[0m15:31:06.496337 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:31:07.374853 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:d75b3e1d-d6c6-4d29-8c97-29540cb03b5a&page=queryresults
[0m15:31:10.467190 [debug] [Thread-2 (]: SQL status: OK in 3.091 seconds
[0m15:31:10.662806 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155325550>]}
[0m15:31:10.664195 [info ] [Thread-2 (]: 4 of 9 OK created sql incremental model health_insurance_dev_core.fact_insurance_yearly  [[32mCREATE TABLE (500.0 rows, 12.7 KiB processed)[0m in 4.22s]
[0m15:31:10.665048 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:31:10.666328 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:31:10.666942 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m15:31:10.667408 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.negative_costs
[0m15:31:10.667925 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:31:10.668512 [info ] [Thread-3 (]: 5 of 9 START sql table model health_insurance_dev_marts.mart_city_year_kpis .... [RUN]
[0m15:31:10.669144 [info ] [Thread-4 (]: 6 of 9 START sql table model health_insurance_dev_marts.mart_person_kpis ....... [RUN]
[0m15:31:10.670173 [info ] [Thread-2 (]: 8 of 9 START sql view model health_insurance_dev.negative_costs ................ [RUN]
[0m15:31:10.670959 [info ] [Thread-1 (]: 7 of 9 START sql table model health_insurance_dev_marts.mart_yearly_kpis ....... [RUN]
[0m15:31:10.671597 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_cleaned, now model.health_insurance_dbt.mart_city_year_kpis)
[0m15:31:10.672118 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_deduped, now model.health_insurance_dbt.mart_person_kpis)
[0m15:31:10.672578 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.fact_insurance_yearly, now model.health_insurance_dbt.negative_costs)
[0m15:31:10.673008 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.dim_person, now model.health_insurance_dbt.mart_yearly_kpis)
[0m15:31:10.673476 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.mart_city_year_kpis
[0m15:31:10.673916 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.mart_person_kpis
[0m15:31:10.674332 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.negative_costs
[0m15:31:10.674733 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.mart_yearly_kpis
[0m15:31:10.690139 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:31:10.693921 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:31:10.696181 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.negative_costs"
[0m15:31:10.699249 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:31:10.700617 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.negative_costs
[0m15:31:10.700968 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.mart_city_year_kpis
[0m15:31:10.701292 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.mart_yearly_kpis
[0m15:31:10.701555 [debug] [Thread-4 (]: Began executing node model.health_insurance_dbt.mart_person_kpis
[0m15:31:10.704418 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.negative_costs"
[0m15:31:10.707269 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:31:10.709015 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:31:10.711023 [debug] [Thread-4 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:31:10.712201 [debug] [Thread-3 (]: On model.health_insurance_dbt.mart_city_year_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_city_year_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_city_year_kpis`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by city

    
    OPTIONS()
    as (
      

-- City-level yearly aggregations for geographic analysis
-- Grain: One row per city + year
-- BI Use: Regional performance, geographic segmentation, market analysis

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  COALESCE(p.city, 'Unknown') AS city,
  p.postal_code,
  f.year,
  
  -- Volume metrics
  COUNT(DISTINCT f.person_id) AS persons_in_city,
  
  -- Cost aggregates
  SUM(f.insurance_cost_year) AS total_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS total_cost_to_insurance,
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_person,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_person,
  
  -- Visit aggregates
  SUM(f.annual_doctor_visits) AS total_doctor_visits,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_person,
  
  -- Demographics
  AVG(p.age_years) AS avg_age,
  COUNTIF(p.gender = 'male') AS male_count,
  COUNTIF(p.gender = 'female') AS female_count,
  
  -- Wealth distribution
  COUNTIF(p.wealth_bracket = 'low') AS low_wealth_count,
  COUNTIF(p.wealth_bracket = 'medium') AS medium_wealth_count,
  COUNTIF(p.wealth_bracket = 'upper_middle') AS upper_middle_wealth_count,
  COUNTIF(p.wealth_bracket = 'high') AS high_wealth_count,
  
  -- Insurance status
  COUNTIF(p.insurance_status = 'active') AS active_count,
  COUNTIF(p.insurance_status = 'inactive') AS inactive_count,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at

FROM person_dim p
INNER JOIN facts f USING (person_id)
WHERE p.city IS NOT NULL
GROUP BY
  p.city,
  p.postal_code,
  f.year
ORDER BY
  f.year DESC,
  persons_in_city DESC
    );
  
[0m15:31:10.712683 [debug] [Thread-1 (]: On model.health_insurance_dbt.mart_yearly_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_yearly_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_yearly_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  MAX(CASE WHEN f.year = MAX(f.year)
  OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS latest_year_cost,
  MIN(CASE WHEN f.year = MIN(f.year) OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS earliest_year_cost,
-- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:31:10.713076 [debug] [Thread-2 (]: On model.health_insurance_dbt.negative_costs: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.negative_costs"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`negative_costs`
  OPTIONS()
  as -- Test: No negative costs in fact table
-- This test fails if any negative values exist in cost columns

SELECT
  person_id,
  year,
  insurance_cost_year,
  annual_cost_to_insurance
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  (insurance_cost_year < 0 AND insurance_cost_year IS NOT NULL)
  OR (annual_cost_to_insurance < 0 AND annual_cost_to_insurance IS NOT NULL);


[0m15:31:10.713404 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:31:10.713718 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:31:10.714051 [debug] [Thread-4 (]: On model.health_insurance_dbt.mart_person_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_person_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_person_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  MAX(CASE WHEN f.year = MAX(f.year)
  OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS latest_year_cost,
  MIN(CASE WHEN f.year = MIN(f.year) OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS earliest_year_cost,
-- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:31:10.714416 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:31:10.715990 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:31:11.228146 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:cfa128b8-e97a-46dd-9f2e-ecfd9f1e5ba0&page=queryresults
[0m15:31:11.352913 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:75336a05-5c49-4988-98d8-4fee5787a25c&page=queryresults
[0m15:31:11.398620 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:3c5e4e0c-2b8d-4ac0-be6f-4751b98d2bd3&page=queryresults
[0m15:31:11.407429 [error] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:cfa128b8-e97a-46dd-9f2e-ecfd9f1e5ba0&page=queryresults
[0m15:31:11.414983 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:c71cce18-c115-4e3c-bb80-a86bafdd77ea&page=queryresults
[0m15:31:11.427326 [debug] [Thread-3 (]: Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:31:11.428088 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x154c0fbf0>]}
[0m15:31:11.428865 [error] [Thread-3 (]: 5 of 9 ERROR creating sql table model health_insurance_dev_marts.mart_city_year_kpis  [[31mERROR[0m in 0.76s]
[0m15:31:11.429503 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:31:11.429857 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m15:31:11.430131 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.mart_city_year_kpis' to be skipped because of status 'error'.  Reason: Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql.
[0m15:31:11.430383 [info ] [Thread-3 (]: 9 of 9 START sql view model health_insurance_dev.visits_reasonable ............. [RUN]
[0m15:31:11.431283 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.mart_city_year_kpis, now model.health_insurance_dbt.visits_reasonable)
[0m15:31:11.431493 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.visits_reasonable
[0m15:31:11.433350 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.visits_reasonable"
[0m15:31:11.433988 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.visits_reasonable
[0m15:31:11.437406 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.visits_reasonable"
[0m15:31:11.438437 [debug] [Thread-3 (]: On model.health_insurance_dbt.visits_reasonable: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.visits_reasonable"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`visits_reasonable`
  OPTIONS()
  as -- Test: Doctor visits should be between 0 and 365 per year
-- This test fails if values are outside reasonable bounds

SELECT
  person_id,
  year,
  annual_doctor_visits
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  annual_doctor_visits IS NOT NULL
  AND (annual_doctor_visits < 0 OR annual_doctor_visits > 365)
```

### 5.3 tests/parse_error_rate.sql
```sql
-- Test: Parse error rate should be below threshold (5%)
-- This test fails if too many records have parse errors

WITH error_counts AS (
  SELECT
    COUNT(*) AS total_records,
    SUM(CASE WHEN birthdate_parse_error THEN 1 ELSE 0 END) AS birthdate_errors,
    SUM(CASE WHEN insurance_sign_up_date_parse_error THEN 1 ELSE 0 END) AS signup_date_errors
  FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
),

error_rates AS (
  SELECT
    total_records,
    birthdate_errors,
    signup_date_errors,
    ROUND(100.0 * birthdate_errors / NULLIF(total_records, 0), 2) AS birthdate_error_pct,
    ROUND(100.0 * signup_date_errors / NULLIF(total_records, 0), 2) AS signup_date_error_pct
  FROM error_counts
)

-- Fail if error rate exceeds 5%
SELECT
  'birthdate' AS field,
  birthdate_errors AS error_count,
  total_records,
  birthdate_error_pct AS error_rate_pct
FROM error_rates
WHERE birthdate_error_pct > 5

UNION ALL

SELECT
  'insurance_sign_up_date' AS field,
  signup_date_errors AS error_count,
  total_records,
  signup_date_error_pct AS error_rate_pct
FROM error_rates
WHERE signup_date_error_pct > 5
```

### 5.4 tests/orphan_records.sql
```sql
-- Test: Flag orphan records in fact table (for monitoring)
-- This test warns if orphan records exist (not a hard failure)

SELECT
  person_id,
  year,
  'Fact record has no matching person in dim_person' AS issue
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE orphan_record = TRUE;


[0m15:31:11.438907 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:31:11.549749 [error] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:75336a05-5c49-4988-98d8-4fee5787a25c&page=queryresults
[0m15:31:11.550705 [error] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:3c5e4e0c-2b8d-4ac0-be6f-4751b98d2bd3&page=queryresults
[0m15:31:11.558220 [debug] [Thread-4 (]: Database Error in model mart_person_kpis (models/marts/mart_person_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_person_kpis.sql
[0m15:31:11.561908 [debug] [Thread-1 (]: Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:31:11.562252 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x153a0a690>]}
[0m15:31:11.562500 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15b307b90>]}
[0m15:31:11.563417 [error] [Thread-4 (]: 6 of 9 ERROR creating sql table model health_insurance_dev_marts.mart_person_kpis  [[31mERROR[0m in 0.89s]
[0m15:31:11.563817 [error] [Thread-1 (]: 7 of 9 ERROR creating sql table model health_insurance_dev_marts.mart_yearly_kpis  [[31mERROR[0m in 0.89s]
[0m15:31:11.564146 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m15:31:11.564402 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:31:11.564639 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.mart_person_kpis' to be skipped because of status 'error'.  Reason: Database Error in model mart_person_kpis (models/marts/mart_person_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_person_kpis.sql.
[0m15:31:11.564922 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.mart_yearly_kpis' to be skipped because of status 'error'.  Reason: Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql.
[0m15:31:11.760366 [debug] [Thread-2 (]: SQL status: OK in 0.344 seconds
[0m15:31:11.765630 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15381fd70>]}
[0m15:31:11.766870 [info ] [Thread-2 (]: 8 of 9 OK created sql view model health_insurance_dev.negative_costs ........... [[32mCREATE VIEW (0 processed)[0m in 1.09s]
[0m15:31:11.767942 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m15:31:11.783382 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:f468b4fc-9287-4888-ab4d-06667352e463&page=queryresults
[0m15:31:11.784799 [error] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:f468b4fc-9287-4888-ab4d-06667352e463&page=queryresults
[0m15:31:11.792179 [debug] [Thread-3 (]: Database Error in model visits_reasonable (models/tests/visits_reasonable.sql)
  Syntax error: Expected end of input but got identifier `` at [17:1]
  compiled code at target/run/health_insurance_dbt/models/tests/visits_reasonable.sql
[0m15:31:11.792833 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c4b87a41-aac6-4425-88a0-eb5d6f9fa2b4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x15381c8f0>]}
[0m15:31:11.793550 [error] [Thread-3 (]: 9 of 9 ERROR creating sql view model health_insurance_dev.visits_reasonable .... [[31mERROR[0m in 0.36s]
[0m15:31:11.794157 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m15:31:11.794641 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.visits_reasonable' to be skipped because of status 'error'.  Reason: Database Error in model visits_reasonable (models/tests/visits_reasonable.sql)
  Syntax error: Expected end of input but got identifier `` at [17:1]
  compiled code at target/run/health_insurance_dbt/models/tests/visits_reasonable.sql.
[0m15:31:11.796281 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:31:11.796953 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:31:11.797159 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_yearly_kpis' was properly closed.
[0m15:31:11.797289 [debug] [MainThread]: Connection 'model.health_insurance_dbt.negative_costs' was properly closed.
[0m15:31:11.797407 [debug] [MainThread]: Connection 'model.health_insurance_dbt.visits_reasonable' was properly closed.
[0m15:31:11.797588 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_person_kpis' was properly closed.
[0m15:31:11.797830 [info ] [MainThread]: 
[0m15:31:11.798010 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 4 view models in 0 hours 0 minutes and 11.67 seconds (11.67s).
[0m15:31:11.798819 [debug] [MainThread]: Command end result
[0m15:31:11.820489 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:31:11.824091 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:31:11.827443 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m15:31:11.827627 [info ] [MainThread]: 
[0m15:31:11.827841 [info ] [MainThread]: [31mCompleted with 4 errors, 0 partial successes, and 0 warnings:[0m
[0m15:31:11.828008 [info ] [MainThread]: 
[0m15:31:11.828215 [error] [MainThread]: [31mFailure in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)[0m
[0m15:31:11.828385 [error] [MainThread]:   Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:31:11.828510 [info ] [MainThread]: 
[0m15:31:11.828664 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:31:11.828787 [info ] [MainThread]: 
[0m15:31:11.828935 [error] [MainThread]: [31mFailure in model mart_person_kpis (models/marts/mart_person_kpis.sql)[0m
[0m15:31:11.829088 [error] [MainThread]:   Database Error in model mart_person_kpis (models/marts/mart_person_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_person_kpis.sql
[0m15:31:11.829203 [info ] [MainThread]: 
[0m15:31:11.829345 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/marts/mart_person_kpis.sql
[0m15:31:11.829484 [info ] [MainThread]: 
[0m15:31:11.829657 [error] [MainThread]: [31mFailure in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)[0m
[0m15:31:11.829824 [error] [MainThread]:   Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:31:11.829946 [info ] [MainThread]: 
[0m15:31:11.830092 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:31:11.830211 [info ] [MainThread]: 
[0m15:31:11.830354 [error] [MainThread]: [31mFailure in model visits_reasonable (models/tests/visits_reasonable.sql)[0m
[0m15:31:11.830504 [error] [MainThread]:   Database Error in model visits_reasonable (models/tests/visits_reasonable.sql)
  Syntax error: Expected end of input but got identifier `` at [17:1]
  compiled code at target/run/health_insurance_dbt/models/tests/visits_reasonable.sql
[0m15:31:11.830626 [info ] [MainThread]: 
[0m15:31:11.830771 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/tests/visits_reasonable.sql
[0m15:31:11.830899 [info ] [MainThread]: 
[0m15:31:11.831072 [info ] [MainThread]: Done. PASS=5 WARN=0 ERROR=4 SKIP=0 NO-OP=0 TOTAL=9
[0m15:31:11.831542 [warn ] [MainThread]: [[33mWARNING[0m][DeprecationsSummary]: Deprecated functionality
Summary of encountered deprecations:
- MissingArgumentsPropertyInGenericTestDeprecation: 5 occurrences
To see all deprecation instances instead of just the first occurrence of each,
run command again with the `--show-all-deprecations` flag. You may also need to
run with `--no-partial-parse` as some deprecations are only encountered during
parsing.
[0m15:31:11.831912 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 25.791685, "process_in_blocks": "0", "process_kernel_time": 5.68898, "process_mem_max_rss": "445169664", "process_out_blocks": "0", "process_user_time": 10.284352}
[0m15:31:11.832226 [debug] [MainThread]: Command `dbt run` failed at 15:31:11.832174 after 25.79 seconds
[0m15:31:11.832495 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155304a10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1054b7cb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b84110>]}
[0m15:31:11.832696 [debug] [MainThread]: Flushing usage events
[0m15:31:12.707569 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:33:41.772623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064b2e40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a2b890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a2bb10>]}


============================== 15:33:41.777124 | 6f967f65-ce6c-4f88-8834-44cdf9474ac7 ==============================
[0m15:33:41.777124 [info ] [MainThread]: Running with dbt=1.11.2
[0m15:33:41.777463 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'static_parser': 'True', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'cache_selected_only': 'False', 'quiet': 'False', 'log_cache_events': 'False', 'log_format': 'default', 'invocation_command': 'dbt run --full-refresh', 'version_check': 'True', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'target_path': 'None', 'partial_parse': 'True', 'warn_error': 'None', 'empty': 'False', 'printer_width': '80', 'debug': 'False', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'use_colors': 'True', 'write_json': 'True', 'use_experimental_parser': 'False'}
[0m15:33:55.555389 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d868b0>]}
[0m15:33:55.595095 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106309370>]}
[0m15:33:55.595588 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m15:33:55.720902 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m15:33:55.836114 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:33:55.836620 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/marts/mart_person_kpis.sql
[0m15:33:55.836835 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/marts/mart_city_year_kpis.sql
[0m15:33:56.106195 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x171709550>]}
[0m15:33:56.149945 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:33:56.151134 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:33:56.167088 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16d4ae120>]}
[0m15:33:56.167370 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m15:33:56.167543 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x173b7c670>]}
[0m15:33:56.168782 [info ] [MainThread]: 
[0m15:33:56.168986 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:33:56.169121 [info ] [MainThread]: 
[0m15:33:56.169362 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:33:56.171434 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:33:56.171670 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:33:56.171908 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:33:56.172218 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:33:56.172427 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:33:56.172610 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:33:56.172806 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:33:56.173022 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:33:58.401693 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m15:33:58.403429 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:33:58.404088 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m15:33:58.405910 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m15:33:58.406430 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:33:58.407200 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m15:33:58.407654 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:33:58.409282 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:33:58.844017 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x173b23790>]}
[0m15:33:58.844876 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:33:58.849090 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:33:58.849539 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:33:58.850111 [info ] [Thread-1 (]: 1 of 9 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m15:33:58.850673 [info ] [Thread-2 (]: 2 of 9 START sql view model health_insurance_dev_staging.stg_person_dim_raw .... [RUN]
[0m15:33:58.851194 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m15:33:58.851560 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now model.health_insurance_dbt.stg_person_dim_raw)
[0m15:33:58.851920 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:33:58.852215 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m15:33:58.862662 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:33:58.864791 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:33:58.865605 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m15:33:58.882135 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:33:58.882635 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:33:58.883915 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:33:58.884365 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m15:33:58.884622 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:33:58.885389 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m15:33:58.885670 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:33:59.851152 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:855f0264-3f64-4576-a021-7b89e126e16f&page=queryresults
[0m15:33:59.863686 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:1a4cc47a-1450-4092-8a60-305586fe8160&page=queryresults
[0m15:34:00.227314 [debug] [Thread-1 (]: SQL status: OK in 0.363 seconds
[0m15:34:00.284889 [debug] [Thread-2 (]: SQL status: OK in 0.433 seconds
[0m15:34:00.328927 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x173bdbe90>]}
[0m15:34:00.329149 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x17f1f4050>]}
[0m15:34:00.329485 [info ] [Thread-2 (]: 2 of 9 OK created sql view model health_insurance_dev_staging.stg_person_dim_raw  [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m15:34:00.330097 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:34:00.329780 [info ] [Thread-1 (]: 1 of 9 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m15:34:00.330532 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:34:00.330716 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m15:34:00.330870 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m15:34:00.331085 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.int_person_cleaned)
[0m15:34:00.331257 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.int_person_deduped)
[0m15:34:00.331415 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m15:34:00.331565 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m15:34:00.333558 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m15:34:00.335765 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m15:34:00.336608 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:34:00.336798 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:34:00.337213 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m15:34:00.337636 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m15:34:00.337956 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.dim_person
[0m15:34:00.338181 [info ] [Thread-2 (]: 3 of 9 START sql table model health_insurance_dev_core.dim_person .............. [RUN]
[0m15:34:00.338376 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_person_dim_raw, now model.health_insurance_dbt.dim_person)
[0m15:34:00.338535 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m15:34:00.343610 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m15:34:00.344605 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.dim_person
[0m15:34:00.350893 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:34:00.816661 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.dim_person"
[0m15:34:00.819781 [debug] [Thread-2 (]: On model.health_insurance_dbt.dim_person: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.dim_person"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Conformed person dimension (SCD Type 1)
-- Grain: One row per person_id
-- Business key: person_id

WITH  __dbt__cte__int_person_deduped as (


-- Parse dates, standardize categories, extract address components
-- Each raw row is cleaned but duplicates remain

WITH source AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
),

-- Date parsing logic for birthdate
birthdate_parsed AS (
  SELECT
    person_id,
    birthdate_raw,
    
    -- Try multiple date formats
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', birthdate_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', birthdate_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', birthdate_raw),
      
      -- Slash format with heuristic (birthdate defaults to MM/DD/...)
      CASE
        -- Check if it's a slash-delimited date
        WHEN REGEXP_CONTAINS(birthdate_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            -- Extract parts
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to MM/DD/... for birthdate
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS birthdate_parsed
  FROM source
),

-- Date parsing logic for insurance_sign_up_date
signup_date_parsed AS (
  SELECT
    person_id,
    insurance_sign_up_date_raw,
    
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', insurance_sign_up_date_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', insurance_sign_up_date_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', insurance_sign_up_date_raw),
      
      -- Slash format with heuristic (signup defaults to DD/MM/...)
      CASE
        WHEN REGEXP_CONTAINS(insurance_sign_up_date_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to DD/MM/... for signup date
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS insurance_sign_up_date_parsed
  FROM source
),

-- Address parsing
address_parsed AS (
  SELECT
    person_id,
    address_raw,
    REGEXP_REPLACE(TRIM(address_raw), r'\s+', ' ') AS address_clean,
    REGEXP_EXTRACT(address_raw, r'\b(\d{5})\b') AS postal_code,
    INITCAP(TRIM(REGEXP_EXTRACT(address_raw, r'\d{5}\s+(.+)$'))) AS city,
    TRIM(SPLIT(address_raw, ',')[SAFE_OFFSET(0)]) AS street_and_number
  FROM source
)

-- Final cleaned output
SELECT
  s.person_id,
  
  -- Dates with parse error flags
  bd.birthdate_parsed,
  CASE WHEN bd.birthdate_parsed IS NULL AND s.birthdate_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS birthdate_parse_error,
  
  sd.insurance_sign_up_date_parsed,
  CASE WHEN sd.insurance_sign_up_date_parsed IS NULL AND s.insurance_sign_up_date_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_sign_up_date_parse_error,
  
  -- Address components
  ap.address_raw,
  ap.address_clean,
  ap.postal_code,
  ap.city,
  ap.street_and_number,
  
  -- Standardized gender
  CASE
    WHEN UPPER(TRIM(s.gender_raw)) IN ('M', 'MALE') THEN 'male'
    WHEN UPPER(TRIM(s.gender_raw)) IN ('F', 'FEMALE') THEN 'female'
    ELSE 'unknown'
  END AS gender_std,
  
  -- Standardized family status
  CASE
    WHEN UPPER(TRIM(s.family_status_raw)) = 'SINGLE' THEN 'single'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'MARRIED' THEN 'married'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'DIVORCED' THEN 'divorced'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'WIDOWED' THEN 'widowed'
    ELSE 'unknown'
  END AS family_status_std,
  
  -- Standardized insurance status
  CASE
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'ACTIVE' THEN 'active'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'INACTIVE' THEN 'inactive'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'PENDING' THEN 'pending'
    ELSE 'unknown'
  END AS insurance_status_std,
  
  -- Cleaned occupational category
  CASE 
    WHEN TRIM(s.occupational_category_raw) = '' THEN NULL
    ELSE TRIM(s.occupational_category_raw)
  END AS occupational_category_clean,
  
  -- Standardized wealth bracket
  CASE
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('LOW', 'LOWER') THEN 'low'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) = 'MEDIUM' THEN 'medium'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('UPPER_MIDDLE', 'UPPER MIDDLE', 'UPPERMIDDLE') THEN 'upper_middle'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('HIGH', 'UPPER') THEN 'high'
    ELSE 'unknown'
  END AS wealth_bracket_std

FROM source s
LEFT JOIN birthdate_parsed bd USING (person_id)
LEFT JOIN signup_date_parsed sd USING (person_id)
LEFT JOIN address_parsed ap USING (person_id)
), deduped AS (
  SELECT * FROM __dbt__cte__int_person_deduped
)

SELECT
  person_id,
  
  -- Demographic attributes
  birthdate_parsed AS birthdate,
  CASE 
    WHEN birthdate_parsed IS NOT NULL 
    THEN DATE_DIFF(CURRENT_DATE(), birthdate_parsed, YEAR)
    ELSE NULL 
  END AS age_years,
  gender_std AS gender,
  family_status_std AS family_status,
  
  -- Insurance attributes
  insurance_status_std AS insurance_status,
  insurance_sign_up_date_parsed AS insurance_sign_up_date,
  EXTRACT(YEAR FROM insurance_sign_up_date_parsed) AS signup_year,
  FORMAT_DATE('%Y-%m', insurance_sign_up_date_parsed) AS signup_month,
  
  -- Economic attributes
  occupational_category_clean AS occupational_category,
  wealth_bracket_std AS wealth_bracket,
  
  -- Address attributes
  address_clean AS address,
  street_and_number,
  postal_code,
  city,
  
  -- Data quality flags
  birthdate_parse_error,
  insurance_sign_up_date_parse_error,
  CURRENT_TIMESTAMP() AS dim_updated_at

FROM deduped
    );
  
[0m15:34:01.713965 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:8b15c227-2302-4370-a61c-b65f7795f9bd&page=queryresults
[0m15:34:03.663223 [debug] [Thread-2 (]: SQL status: OK in 1.948 seconds
[0m15:34:03.842319 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x17f1cb930>]}
[0m15:34:03.843731 [info ] [Thread-2 (]: 3 of 9 OK created sql table model health_insurance_dev_core.dim_person ......... [[32mCREATE TABLE (166.0 rows, 12.4 KiB processed)[0m in 3.50s]
[0m15:34:03.844605 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.dim_person
[0m15:34:03.845772 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:34:03.846399 [info ] [Thread-1 (]: 4 of 9 START sql incremental model health_insurance_dev_core.fact_insurance_yearly  [RUN]
[0m15:34:03.846976 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.fact_insurance_yearly)
[0m15:34:03.847447 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.fact_insurance_yearly
[0m15:34:03.861503 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:34:03.863572 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.fact_insurance_yearly
[0m15:34:03.900124 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:34:04.335049 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:34:04.336600 [debug] [Thread-1 (]: On model.health_insurance_dbt.fact_insurance_yearly: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.fact_insurance_yearly"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Insurance facts by person and year
-- Grain: One row per person_id + year
-- Incremental strategy: Merge on (person_id, year)

WITH facts_raw AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
),

person_dim AS (
  SELECT person_id FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  f.person_id,
  f.year,
  
  -- Metrics
  f.insurance_cost_year,
  f.annual_doctor_visits,
  f.annual_cost_to_insurance,
  
  -- Data quality flags
  f.insurance_cost_year_parse_error,
  f.annual_doctor_visits_parse_error,
  f.annual_cost_to_insurance_parse_error,
  f.year_parse_error,
  
  -- Referential integrity check
  CASE WHEN p.person_id IS NULL THEN TRUE ELSE FALSE END AS orphan_record,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS fact_updated_at

FROM facts_raw f
LEFT JOIN person_dim p USING (person_id)

WHERE f.year IS NOT NULL
  AND f.person_id IS NOT NULL


    );
  
[0m15:34:05.262651 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:012b0ca9-d4db-45fc-a26b-7d6da94b7160&page=queryresults
[0m15:34:07.113011 [debug] [Thread-1 (]: SQL status: OK in 1.849 seconds
[0m15:34:07.339612 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x17f19c650>]}
[0m15:34:07.340355 [info ] [Thread-1 (]: 4 of 9 OK created sql incremental model health_insurance_dev_core.fact_insurance_yearly  [[32mCREATE TABLE (500.0 rows, 12.7 KiB processed)[0m in 3.49s]
[0m15:34:07.340687 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:34:07.341284 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:34:07.341518 [info ] [Thread-2 (]: 7 of 9 START sql table model health_insurance_dev_marts.mart_yearly_kpis ....... [RUN]
[0m15:34:07.341734 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:34:07.341965 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.negative_costs
[0m15:34:07.342129 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m15:34:07.342357 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.dim_person, now model.health_insurance_dbt.mart_yearly_kpis)
[0m15:34:07.342634 [info ] [Thread-4 (]: 5 of 9 START sql table model health_insurance_dev_marts.mart_city_year_kpis .... [RUN]
[0m15:34:07.342923 [info ] [Thread-1 (]: 8 of 9 START sql view model health_insurance_dev.negative_costs ................ [RUN]
[0m15:34:07.343269 [info ] [Thread-3 (]: 6 of 9 START sql table model health_insurance_dev_marts.mart_person_kpis ....... [RUN]
[0m15:34:07.343491 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.mart_yearly_kpis
[0m15:34:07.343713 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_deduped, now model.health_insurance_dbt.mart_city_year_kpis)
[0m15:34:07.343905 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.fact_insurance_yearly, now model.health_insurance_dbt.negative_costs)
[0m15:34:07.344080 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_cleaned, now model.health_insurance_dbt.mart_person_kpis)
[0m15:34:07.347882 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:34:07.348201 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.mart_city_year_kpis
[0m15:34:07.348369 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.negative_costs
[0m15:34:07.348525 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.mart_person_kpis
[0m15:34:07.350596 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:34:07.355303 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.negative_costs"
[0m15:34:07.357580 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:34:07.357858 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.mart_yearly_kpis
[0m15:34:07.359529 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:34:07.359926 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.mart_person_kpis
[0m15:34:07.360114 [debug] [Thread-4 (]: Began executing node model.health_insurance_dbt.mart_city_year_kpis
[0m15:34:07.569078 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.negative_costs
[0m15:34:07.570838 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:34:07.572351 [debug] [Thread-4 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:34:07.573586 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.negative_costs"
[0m15:34:07.573912 [debug] [Thread-2 (]: On model.health_insurance_dbt.mart_yearly_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_yearly_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_yearly_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  MAX(CASE WHEN f.year = MAX(f.year)
  OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS latest_year_cost,
  MIN(CASE WHEN f.year = MIN(f.year) OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS earliest_year_cost,
-- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:34:07.574401 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:34:07.575043 [debug] [Thread-4 (]: On model.health_insurance_dbt.mart_city_year_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_city_year_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_city_year_kpis`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by city

    
    OPTIONS()
    as (
      

-- City-level yearly aggregations for geographic analysis
-- Grain: One row per city + year
-- BI Use: Regional performance, geographic segmentation, market analysis

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  COALESCE(p.city, 'Unknown') AS city,
  p.postal_code,
  f.year,
  
  -- Volume metrics
  COUNT(DISTINCT f.person_id) AS persons_in_city,
  
  -- Cost aggregates
  SUM(f.insurance_cost_year) AS total_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS total_cost_to_insurance,
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_person,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_person,
  
  -- Visit aggregates
  SUM(f.annual_doctor_visits) AS total_doctor_visits,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_person,
  
  -- Demographics
  AVG(p.age_years) AS avg_age,
  COUNTIF(p.gender = 'male') AS male_count,
  COUNTIF(p.gender = 'female') AS female_count,
  
  -- Wealth distribution
  COUNTIF(p.wealth_bracket = 'low') AS low_wealth_count,
  COUNTIF(p.wealth_bracket = 'medium') AS medium_wealth_count,
  COUNTIF(p.wealth_bracket = 'upper_middle') AS upper_middle_wealth_count,
  COUNTIF(p.wealth_bracket = 'high') AS high_wealth_count,
  
  -- Insurance status
  COUNTIF(p.insurance_status = 'active') AS active_count,
  COUNTIF(p.insurance_status = 'inactive') AS inactive_count,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at

FROM person_dim p
INNER JOIN facts f USING (person_id)
WHERE p.city IS NOT NULL
GROUP BY
  p.city,
  p.postal_code,
  f.year
ORDER BY
  persons_in_city DESC
    );
  
[0m15:34:07.575361 [debug] [Thread-3 (]: On model.health_insurance_dbt.mart_person_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_person_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_person_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year DESC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS latest_year_cost,
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year ASC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS earliest_year_cost,
-- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:34:07.575895 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:34:07.576371 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:34:07.576801 [debug] [Thread-1 (]: On model.health_insurance_dbt.negative_costs: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.negative_costs"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`negative_costs`
  OPTIONS()
  as -- Test: No negative costs in fact table
-- This test fails if any negative values exist in cost columns

SELECT
  person_id,
  year,
  insurance_cost_year,
  annual_cost_to_insurance
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  (insurance_cost_year < 0 AND insurance_cost_year IS NOT NULL)
  OR (annual_cost_to_insurance < 0 AND annual_cost_to_insurance IS NOT NULL);


[0m15:34:07.577144 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:34:08.223772 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:09e3f39d-c002-4f10-b2aa-e574b7c050cb&page=queryresults
[0m15:34:08.224816 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:e733c66b-9960-4c8e-a181-fc0f2e4a02ca&page=queryresults
[0m15:34:08.225891 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:3ee95d46-d9a5-4d99-b3b2-b3f26c376f3b&page=queryresults
[0m15:34:08.377741 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:3ee95d46-d9a5-4d99-b3b2-b3f26c376f3b&page=queryresults
[0m15:34:08.396168 [debug] [Thread-2 (]: Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:34:08.396980 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16d466200>]}
[0m15:34:08.397777 [error] [Thread-2 (]: 7 of 9 ERROR creating sql table model health_insurance_dev_marts.mart_yearly_kpis  [[31mERROR[0m in 1.05s]
[0m15:34:08.398442 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:34:08.398896 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m15:34:08.399480 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.mart_yearly_kpis' to be skipped because of status 'error'.  Reason: Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql.
[0m15:34:08.400070 [info ] [Thread-2 (]: 9 of 9 START sql view model health_insurance_dev.visits_reasonable ............. [RUN]
[0m15:34:08.401633 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.mart_yearly_kpis, now model.health_insurance_dbt.visits_reasonable)
[0m15:34:08.402084 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.visits_reasonable
[0m15:34:08.406111 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.visits_reasonable"
[0m15:34:08.407326 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.visits_reasonable
[0m15:34:08.410670 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.visits_reasonable"
[0m15:34:08.411696 [debug] [Thread-2 (]: On model.health_insurance_dbt.visits_reasonable: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.visits_reasonable"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`visits_reasonable`
  OPTIONS()
  as -- Test: Doctor visits should be between 0 and 365 per year
-- This test fails if values are outside reasonable bounds

SELECT
  person_id,
  year,
  annual_doctor_visits
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  annual_doctor_visits IS NOT NULL
  AND (annual_doctor_visits < 0 OR annual_doctor_visits > 365)
```

### 5.3 tests/parse_error_rate.sql
```sql
-- Test: Parse error rate should be below threshold (5%)
-- This test fails if too many records have parse errors

WITH error_counts AS (
  SELECT
    COUNT(*) AS total_records,
    SUM(CASE WHEN birthdate_parse_error THEN 1 ELSE 0 END) AS birthdate_errors,
    SUM(CASE WHEN insurance_sign_up_date_parse_error THEN 1 ELSE 0 END) AS signup_date_errors
  FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
),

error_rates AS (
  SELECT
    total_records,
    birthdate_errors,
    signup_date_errors,
    ROUND(100.0 * birthdate_errors / NULLIF(total_records, 0), 2) AS birthdate_error_pct,
    ROUND(100.0 * signup_date_errors / NULLIF(total_records, 0), 2) AS signup_date_error_pct
  FROM error_counts
)

-- Fail if error rate exceeds 5%
SELECT
  'birthdate' AS field,
  birthdate_errors AS error_count,
  total_records,
  birthdate_error_pct AS error_rate_pct
FROM error_rates
WHERE birthdate_error_pct > 5

UNION ALL

SELECT
  'insurance_sign_up_date' AS field,
  signup_date_errors AS error_count,
  total_records,
  signup_date_error_pct AS error_rate_pct
FROM error_rates
WHERE signup_date_error_pct > 5
```

### 5.4 tests/orphan_records.sql
```sql
-- Test: Flag orphan records in fact table (for monitoring)
-- This test warns if orphan records exist (not a hard failure)

SELECT
  person_id,
  year,
  'Fact record has no matching person in dim_person' AS issue
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE orphan_record = TRUE;


[0m15:34:08.412258 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:34:08.470691 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:f0f99b8e-7465-448d-bb41-14c99b344589&page=queryresults
[0m15:34:08.614097 [debug] [Thread-1 (]: SQL status: OK in 0.387 seconds
[0m15:34:08.618571 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x173ac5790>]}
[0m15:34:08.619547 [info ] [Thread-1 (]: 8 of 9 OK created sql view model health_insurance_dev.negative_costs ........... [[32mCREATE VIEW (0 processed)[0m in 1.27s]
[0m15:34:08.620353 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m15:34:08.641833 [error] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:f0f99b8e-7465-448d-bb41-14c99b344589&page=queryresults
[0m15:34:08.647373 [debug] [Thread-4 (]: Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:34:08.648078 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x17f292f30>]}
[0m15:34:08.648825 [error] [Thread-4 (]: 5 of 9 ERROR creating sql table model health_insurance_dev_marts.mart_city_year_kpis  [[31mERROR[0m in 1.30s]
[0m15:34:08.649376 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:34:08.649815 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.mart_city_year_kpis' to be skipped because of status 'error'.  Reason: Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql.
[0m15:34:08.839943 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:583c042b-61d3-4c57-849e-5869de2e8756&page=queryresults
[0m15:34:08.840281 [error] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:583c042b-61d3-4c57-849e-5869de2e8756&page=queryresults
[0m15:34:08.842858 [debug] [Thread-2 (]: Database Error in model visits_reasonable (models/tests/visits_reasonable.sql)
  Syntax error: Expected end of input but got identifier `` at [17:1]
  compiled code at target/run/health_insurance_dbt/models/tests/visits_reasonable.sql
[0m15:34:08.843094 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x173ac46b0>]}
[0m15:34:08.843414 [error] [Thread-2 (]: 9 of 9 ERROR creating sql view model health_insurance_dev.visits_reasonable .... [[31mERROR[0m in 0.44s]
[0m15:34:08.843745 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m15:34:08.844000 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.visits_reasonable' to be skipped because of status 'error'.  Reason: Database Error in model visits_reasonable (models/tests/visits_reasonable.sql)
  Syntax error: Expected end of input but got identifier `` at [17:1]
  compiled code at target/run/health_insurance_dbt/models/tests/visits_reasonable.sql.
[0m15:34:20.933819 [debug] [Thread-3 (]: SQL status: OK in 12.706 seconds
[0m15:34:21.374539 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f967f65-ce6c-4f88-8834-44cdf9474ac7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1716a8410>]}
[0m15:34:21.375565 [info ] [Thread-3 (]: 6 of 9 OK created sql table model health_insurance_dev_marts.mart_person_kpis .. [[32mCREATE TABLE (122.0 rows, 34.8 KiB processed)[0m in 14.03s]
[0m15:34:21.375986 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m15:34:21.377977 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:34:21.378567 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:34:21.378717 [debug] [MainThread]: Connection 'model.health_insurance_dbt.negative_costs' was properly closed.
[0m15:34:21.378842 [debug] [MainThread]: Connection 'model.health_insurance_dbt.visits_reasonable' was properly closed.
[0m15:34:21.378958 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_person_kpis' was properly closed.
[0m15:34:21.379066 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_city_year_kpis' was properly closed.
[0m15:34:21.379392 [info ] [MainThread]: 
[0m15:34:21.379579 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 4 view models in 0 hours 0 minutes and 25.21 seconds (25.21s).
[0m15:34:21.380840 [debug] [MainThread]: Command end result
[0m15:34:21.402240 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:34:21.405323 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:34:21.410411 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m15:34:21.410662 [info ] [MainThread]: 
[0m15:34:21.410891 [info ] [MainThread]: [31mCompleted with 3 errors, 0 partial successes, and 0 warnings:[0m
[0m15:34:21.411060 [info ] [MainThread]: 
[0m15:34:21.411262 [error] [MainThread]: [31mFailure in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)[0m
[0m15:34:21.411442 [error] [MainThread]:   Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:34:21.411566 [info ] [MainThread]: 
[0m15:34:21.411715 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:34:21.411840 [info ] [MainThread]: 
[0m15:34:21.411988 [error] [MainThread]: [31mFailure in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)[0m
[0m15:34:21.412141 [error] [MainThread]:   Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:34:21.412259 [info ] [MainThread]: 
[0m15:34:21.412400 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:34:21.412518 [info ] [MainThread]: 
[0m15:34:21.412666 [error] [MainThread]: [31mFailure in model visits_reasonable (models/tests/visits_reasonable.sql)[0m
[0m15:34:21.412816 [error] [MainThread]:   Database Error in model visits_reasonable (models/tests/visits_reasonable.sql)
  Syntax error: Expected end of input but got identifier `` at [17:1]
  compiled code at target/run/health_insurance_dbt/models/tests/visits_reasonable.sql
[0m15:34:21.412929 [info ] [MainThread]: 
[0m15:34:21.413069 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/tests/visits_reasonable.sql
[0m15:34:21.413214 [info ] [MainThread]: 
[0m15:34:21.413386 [info ] [MainThread]: Done. PASS=6 WARN=0 ERROR=3 SKIP=0 NO-OP=0 TOTAL=9
[0m15:34:21.413957 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 39.690445, "process_in_blocks": "0", "process_kernel_time": 6.104741, "process_mem_max_rss": "440696832", "process_out_blocks": "0", "process_user_time": 10.402925}
[0m15:34:21.414332 [debug] [MainThread]: Command `dbt run` failed at 15:34:21.414273 after 39.69 seconds
[0m15:34:21.414726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106ab94f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x17021c590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1728edbb0>]}
[0m15:34:21.414939 [debug] [MainThread]: Flushing usage events
[0m15:34:22.427260 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:35:26.079454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079eae40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11a393890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11a393b10>]}


============================== 15:35:26.085702 | 33d767a5-bb43-4ebf-b524-2976cbd03c99 ==============================
[0m15:35:26.085702 [info ] [MainThread]: Running with dbt=1.11.2
[0m15:35:26.086031 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'version_check': 'True', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'printer_width': '80', 'quiet': 'False', 'write_json': 'True', 'no_print': 'None', 'introspect': 'True', 'debug': 'False', 'invocation_command': 'dbt run --full-refresh', 'static_parser': 'True', 'cache_selected_only': 'False', 'empty': 'False', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'fail_fast': 'False', 'indirect_selection': 'eager', 'target_path': 'None', 'use_colors': 'True', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])'}
[0m15:35:43.100808 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1192ee8b0>]}
[0m15:35:43.144181 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107841370>]}
[0m15:35:43.144771 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m15:35:43.288373 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m15:35:43.409375 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 3 files changed.
[0m15:35:43.409801 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/tests/visits_reasonable.sql
[0m15:35:43.409988 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/tests/parse_error_rate.sql
[0m15:35:43.410156 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/tests/orphan_records.sql
[0m15:35:43.587410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168328f50>]}
[0m15:35:43.632791 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:35:43.634079 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:35:43.650868 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x155c99e50>]}
[0m15:35:43.651149 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m15:35:43.651325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16851d7f0>]}
[0m15:35:43.652774 [info ] [MainThread]: 
[0m15:35:43.652962 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:35:43.653092 [info ] [MainThread]: 
[0m15:35:43.653338 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:35:43.655480 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:35:43.655717 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:35:43.655941 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:35:43.656279 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:35:43.656453 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:35:43.656684 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:35:43.656847 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:35:43.657131 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:35:45.765261 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m15:35:45.766607 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m15:35:45.767325 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:35:45.767869 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m15:35:45.768569 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m15:35:45.769109 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:35:45.770810 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:35:45.771493 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:35:46.240545 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1686a0120>]}
[0m15:35:46.241721 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:35:46.248085 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:35:46.248821 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:35:46.249684 [info ] [Thread-1 (]: 1 of 11 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m15:35:46.250481 [info ] [Thread-2 (]: 2 of 11 START sql view model health_insurance_dev_staging.stg_person_dim_raw ... [RUN]
[0m15:35:46.251217 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m15:35:46.251731 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now model.health_insurance_dbt.stg_person_dim_raw)
[0m15:35:46.252235 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:35:46.252682 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m15:35:46.265317 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:35:46.277750 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:35:46.278946 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:35:46.317002 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m15:35:46.341014 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:35:46.341410 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:35:46.342285 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m15:35:46.342593 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m15:35:46.342849 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:35:46.343025 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:35:47.034234 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:5eada187-94af-4dac-b351-c889e45ece7b&page=queryresults
[0m15:35:47.043267 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:03bf4e35-13d9-4435-86ac-3ad9e93a3165&page=queryresults
[0m15:35:47.396153 [debug] [Thread-1 (]: SQL status: OK in 0.352 seconds
[0m15:35:47.406297 [debug] [Thread-2 (]: SQL status: OK in 0.371 seconds
[0m15:35:47.494761 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1684d7950>]}
[0m15:35:47.495003 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x16865f330>]}
[0m15:35:47.495410 [info ] [Thread-2 (]: 2 of 11 OK created sql view model health_insurance_dev_staging.stg_person_dim_raw  [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m15:35:47.495858 [info ] [Thread-1 (]: 1 of 11 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 1.24s]
[0m15:35:47.496203 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:35:47.496463 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:35:47.497029 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m15:35:47.497245 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.int_person_cleaned)
[0m15:35:47.497413 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m15:35:47.497586 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m15:35:47.499950 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m15:35:47.500348 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.int_person_deduped)
[0m15:35:47.500593 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m15:35:47.506148 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m15:35:47.506826 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:35:47.507303 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m15:35:47.507639 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:35:47.508012 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m15:35:47.508507 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.dim_person
[0m15:35:47.508786 [info ] [Thread-2 (]: 3 of 11 START sql table model health_insurance_dev_core.dim_person ............. [RUN]
[0m15:35:47.509042 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_person_dim_raw, now model.health_insurance_dbt.dim_person)
[0m15:35:47.509213 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m15:35:47.515274 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m15:35:47.516337 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.dim_person
[0m15:35:47.523295 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:35:47.967766 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.dim_person"
[0m15:35:47.970252 [debug] [Thread-2 (]: On model.health_insurance_dbt.dim_person: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.dim_person"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Conformed person dimension (SCD Type 1)
-- Grain: One row per person_id
-- Business key: person_id

WITH  __dbt__cte__int_person_deduped as (


-- Parse dates, standardize categories, extract address components
-- Each raw row is cleaned but duplicates remain

WITH source AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
),

-- Date parsing logic for birthdate
birthdate_parsed AS (
  SELECT
    person_id,
    birthdate_raw,
    
    -- Try multiple date formats
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', birthdate_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', birthdate_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', birthdate_raw),
      
      -- Slash format with heuristic (birthdate defaults to MM/DD/...)
      CASE
        -- Check if it's a slash-delimited date
        WHEN REGEXP_CONTAINS(birthdate_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            -- Extract parts
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to MM/DD/... for birthdate
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS birthdate_parsed
  FROM source
),

-- Date parsing logic for insurance_sign_up_date
signup_date_parsed AS (
  SELECT
    person_id,
    insurance_sign_up_date_raw,
    
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', insurance_sign_up_date_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', insurance_sign_up_date_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', insurance_sign_up_date_raw),
      
      -- Slash format with heuristic (signup defaults to DD/MM/...)
      CASE
        WHEN REGEXP_CONTAINS(insurance_sign_up_date_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to DD/MM/... for signup date
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS insurance_sign_up_date_parsed
  FROM source
),

-- Address parsing
address_parsed AS (
  SELECT
    person_id,
    address_raw,
    REGEXP_REPLACE(TRIM(address_raw), r'\s+', ' ') AS address_clean,
    REGEXP_EXTRACT(address_raw, r'\b(\d{5})\b') AS postal_code,
    INITCAP(TRIM(REGEXP_EXTRACT(address_raw, r'\d{5}\s+(.+)$'))) AS city,
    TRIM(SPLIT(address_raw, ',')[SAFE_OFFSET(0)]) AS street_and_number
  FROM source
)

-- Final cleaned output
SELECT
  s.person_id,
  
  -- Dates with parse error flags
  bd.birthdate_parsed,
  CASE WHEN bd.birthdate_parsed IS NULL AND s.birthdate_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS birthdate_parse_error,
  
  sd.insurance_sign_up_date_parsed,
  CASE WHEN sd.insurance_sign_up_date_parsed IS NULL AND s.insurance_sign_up_date_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_sign_up_date_parse_error,
  
  -- Address components
  ap.address_raw,
  ap.address_clean,
  ap.postal_code,
  ap.city,
  ap.street_and_number,
  
  -- Standardized gender
  CASE
    WHEN UPPER(TRIM(s.gender_raw)) IN ('M', 'MALE') THEN 'male'
    WHEN UPPER(TRIM(s.gender_raw)) IN ('F', 'FEMALE') THEN 'female'
    ELSE 'unknown'
  END AS gender_std,
  
  -- Standardized family status
  CASE
    WHEN UPPER(TRIM(s.family_status_raw)) = 'SINGLE' THEN 'single'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'MARRIED' THEN 'married'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'DIVORCED' THEN 'divorced'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'WIDOWED' THEN 'widowed'
    ELSE 'unknown'
  END AS family_status_std,
  
  -- Standardized insurance status
  CASE
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'ACTIVE' THEN 'active'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'INACTIVE' THEN 'inactive'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'PENDING' THEN 'pending'
    ELSE 'unknown'
  END AS insurance_status_std,
  
  -- Cleaned occupational category
  CASE 
    WHEN TRIM(s.occupational_category_raw) = '' THEN NULL
    ELSE TRIM(s.occupational_category_raw)
  END AS occupational_category_clean,
  
  -- Standardized wealth bracket
  CASE
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('LOW', 'LOWER') THEN 'low'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) = 'MEDIUM' THEN 'medium'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('UPPER_MIDDLE', 'UPPER MIDDLE', 'UPPERMIDDLE') THEN 'upper_middle'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('HIGH', 'UPPER') THEN 'high'
    ELSE 'unknown'
  END AS wealth_bracket_std

FROM source s
LEFT JOIN birthdate_parsed bd USING (person_id)
LEFT JOIN signup_date_parsed sd USING (person_id)
LEFT JOIN address_parsed ap USING (person_id)
), deduped AS (
  SELECT * FROM __dbt__cte__int_person_deduped
)

SELECT
  person_id,
  
  -- Demographic attributes
  birthdate_parsed AS birthdate,
  CASE 
    WHEN birthdate_parsed IS NOT NULL 
    THEN DATE_DIFF(CURRENT_DATE(), birthdate_parsed, YEAR)
    ELSE NULL 
  END AS age_years,
  gender_std AS gender,
  family_status_std AS family_status,
  
  -- Insurance attributes
  insurance_status_std AS insurance_status,
  insurance_sign_up_date_parsed AS insurance_sign_up_date,
  EXTRACT(YEAR FROM insurance_sign_up_date_parsed) AS signup_year,
  FORMAT_DATE('%Y-%m', insurance_sign_up_date_parsed) AS signup_month,
  
  -- Economic attributes
  occupational_category_clean AS occupational_category,
  wealth_bracket_std AS wealth_bracket,
  
  -- Address attributes
  address_clean AS address,
  street_and_number,
  postal_code,
  city,
  
  -- Data quality flags
  birthdate_parse_error,
  insurance_sign_up_date_parse_error,
  CURRENT_TIMESTAMP() AS dim_updated_at

FROM deduped
    );
  
[0m15:35:48.847872 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:42a3afd6-f1b4-435b-a779-1c83930a0213&page=queryresults
[0m15:35:50.454284 [debug] [Thread-2 (]: SQL status: OK in 1.605 seconds
[0m15:35:50.692011 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1686e1c70>]}
[0m15:35:50.693405 [info ] [Thread-2 (]: 3 of 11 OK created sql table model health_insurance_dev_core.dim_person ........ [[32mCREATE TABLE (166.0 rows, 12.4 KiB processed)[0m in 3.18s]
[0m15:35:50.694082 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.dim_person
[0m15:35:50.695153 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.parse_error_rate
[0m15:35:50.695605 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:35:50.696091 [info ] [Thread-3 (]: 5 of 11 START sql view model health_insurance_dev.parse_error_rate ............. [RUN]
[0m15:35:50.696605 [info ] [Thread-1 (]: 4 of 11 START sql incremental model health_insurance_dev_core.fact_insurance_yearly  [RUN]
[0m15:35:50.697169 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_cleaned, now model.health_insurance_dbt.parse_error_rate)
[0m15:35:50.697560 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.fact_insurance_yearly)
[0m15:35:50.697914 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.parse_error_rate
[0m15:35:50.698284 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.fact_insurance_yearly
[0m15:35:50.702748 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.parse_error_rate"
[0m15:35:50.715901 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:35:50.717178 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.parse_error_rate
[0m15:35:50.717564 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.fact_insurance_yearly
[0m15:35:50.720654 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.parse_error_rate"
[0m15:35:50.757416 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:35:50.758399 [debug] [Thread-3 (]: On model.health_insurance_dbt.parse_error_rate: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.parse_error_rate"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`parse_error_rate`
  OPTIONS()
  as -- Test: Parse error rate should be below threshold (5%)
-- This test fails if too many records have parse errors

WITH error_counts AS (
  SELECT
    COUNT(*) AS total_records,
    SUM(CASE WHEN birthdate_parse_error THEN 1 ELSE 0 END) AS birthdate_errors,
    SUM(CASE WHEN insurance_sign_up_date_parse_error THEN 1 ELSE 0 END) AS signup_date_errors
  FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
),

error_rates AS (
  SELECT
    total_records,
    birthdate_errors,
    signup_date_errors,
    ROUND(100.0 * birthdate_errors / NULLIF(total_records, 0), 2) AS birthdate_error_pct,
    ROUND(100.0 * signup_date_errors / NULLIF(total_records, 0), 2) AS signup_date_error_pct
  FROM error_counts
)

-- Fail if error rate exceeds 5%
SELECT
  'birthdate' AS field,
  birthdate_errors AS error_count,
  total_records,
  birthdate_error_pct AS error_rate_pct
FROM error_rates
WHERE birthdate_error_pct > 5

UNION ALL

SELECT
  'insurance_sign_up_date' AS field,
  signup_date_errors AS error_count,
  total_records,
  signup_date_error_pct AS error_rate_pct
FROM error_rates
WHERE signup_date_error_pct > 5;


[0m15:35:50.758799 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:35:51.191132 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:35:51.192137 [debug] [Thread-1 (]: On model.health_insurance_dbt.fact_insurance_yearly: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.fact_insurance_yearly"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Insurance facts by person and year
-- Grain: One row per person_id + year
-- Incremental strategy: Merge on (person_id, year)

WITH facts_raw AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
),

person_dim AS (
  SELECT person_id FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  f.person_id,
  f.year,
  
  -- Metrics
  f.insurance_cost_year,
  f.annual_doctor_visits,
  f.annual_cost_to_insurance,
  
  -- Data quality flags
  f.insurance_cost_year_parse_error,
  f.annual_doctor_visits_parse_error,
  f.annual_cost_to_insurance_parse_error,
  f.year_parse_error,
  
  -- Referential integrity check
  CASE WHEN p.person_id IS NULL THEN TRUE ELSE FALSE END AS orphan_record,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS fact_updated_at

FROM facts_raw f
LEFT JOIN person_dim p USING (person_id)

WHERE f.year IS NOT NULL
  AND f.person_id IS NOT NULL


    );
  
[0m15:35:51.365523 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:49e83bc0-3526-4640-ba3b-b3d46b29f872&page=queryresults
[0m15:35:51.702625 [debug] [Thread-3 (]: SQL status: OK in 0.336 seconds
[0m15:35:51.707324 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1681ee6d0>]}
[0m15:35:51.708616 [info ] [Thread-3 (]: 5 of 11 OK created sql view model health_insurance_dev.parse_error_rate ........ [[32mCREATE VIEW (0 processed)[0m in 1.01s]
[0m15:35:51.709625 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.parse_error_rate
[0m15:35:51.767810 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:990e4575-790c-4301-ae3e-582cc70f9e2e&page=queryresults
[0m15:35:53.968912 [debug] [Thread-1 (]: SQL status: OK in 2.200 seconds
[0m15:35:54.222061 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168b410f0>]}
[0m15:35:54.222625 [info ] [Thread-1 (]: 4 of 11 OK created sql incremental model health_insurance_dev_core.fact_insurance_yearly  [[32mCREATE TABLE (500.0 rows, 12.7 KiB processed)[0m in 3.52s]
[0m15:35:54.223022 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:35:54.223872 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:35:54.224187 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m15:35:54.224437 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:35:54.224681 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.negative_costs
[0m15:35:54.224941 [info ] [Thread-4 (]: 6 of 11 START sql table model health_insurance_dev_marts.mart_city_year_kpis ... [RUN]
[0m15:35:54.225294 [info ] [Thread-2 (]: 7 of 11 START sql table model health_insurance_dev_marts.mart_person_kpis ...... [RUN]
[0m15:35:54.225642 [info ] [Thread-3 (]: 8 of 11 START sql table model health_insurance_dev_marts.mart_yearly_kpis ...... [RUN]
[0m15:35:54.225935 [info ] [Thread-1 (]: 9 of 11 START sql view model health_insurance_dev.negative_costs ............... [RUN]
[0m15:35:54.226240 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_deduped, now model.health_insurance_dbt.mart_city_year_kpis)
[0m15:35:54.226503 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.dim_person, now model.health_insurance_dbt.mart_person_kpis)
[0m15:35:54.226721 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.parse_error_rate, now model.health_insurance_dbt.mart_yearly_kpis)
[0m15:35:54.226931 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.fact_insurance_yearly, now model.health_insurance_dbt.negative_costs)
[0m15:35:54.227138 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.mart_city_year_kpis
[0m15:35:54.227336 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.mart_person_kpis
[0m15:35:54.227525 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.mart_yearly_kpis
[0m15:35:54.227706 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.negative_costs
[0m15:35:54.231311 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:35:54.233458 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:35:54.235977 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:35:54.238038 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.negative_costs"
[0m15:35:54.239015 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.mart_person_kpis
[0m15:35:54.239246 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.mart_yearly_kpis
[0m15:35:54.239442 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.negative_costs
[0m15:35:54.239614 [debug] [Thread-4 (]: Began executing node model.health_insurance_dbt.mart_city_year_kpis
[0m15:35:54.240699 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:35:54.241961 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:35:54.243439 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.negative_costs"
[0m15:35:54.244699 [debug] [Thread-4 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:35:54.245894 [debug] [Thread-1 (]: On model.health_insurance_dbt.negative_costs: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.negative_costs"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`negative_costs`
  OPTIONS()
  as -- Test: No negative costs in fact table
-- This test fails if any negative values exist in cost columns

SELECT
  person_id,
  year,
  insurance_cost_year,
  annual_cost_to_insurance
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  (insurance_cost_year < 0 AND insurance_cost_year IS NOT NULL)
  OR (annual_cost_to_insurance < 0 AND annual_cost_to_insurance IS NOT NULL);


[0m15:35:54.246198 [debug] [Thread-3 (]: On model.health_insurance_dbt.mart_yearly_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_yearly_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_yearly_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  MAX(CASE WHEN f.year = MAX(f.year)
  OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS latest_year_cost,
  MIN(CASE WHEN f.year = MIN(f.year) OVER (PARTITION BY p.person_id)
  THEN f.annual_cost_to_insurance END) AS earliest_year_cost,
-- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:35:54.246499 [debug] [Thread-4 (]: On model.health_insurance_dbt.mart_city_year_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_city_year_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_city_year_kpis`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by city

    
    OPTIONS()
    as (
      

-- City-level yearly aggregations for geographic analysis
-- Grain: One row per city + year
-- BI Use: Regional performance, geographic segmentation, market analysis

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  COALESCE(p.city, 'Unknown') AS city,
  p.postal_code,
  f.year,
  
  -- Volume metrics
  COUNT(DISTINCT f.person_id) AS persons_in_city,
  
  -- Cost aggregates
  SUM(f.insurance_cost_year) AS total_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS total_cost_to_insurance,
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_person,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_person,
  
  -- Visit aggregates
  SUM(f.annual_doctor_visits) AS total_doctor_visits,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_person,
  
  -- Demographics
  AVG(p.age_years) AS avg_age,
  COUNTIF(p.gender = 'male') AS male_count,
  COUNTIF(p.gender = 'female') AS female_count,
  
  -- Wealth distribution
  COUNTIF(p.wealth_bracket = 'low') AS low_wealth_count,
  COUNTIF(p.wealth_bracket = 'medium') AS medium_wealth_count,
  COUNTIF(p.wealth_bracket = 'upper_middle') AS upper_middle_wealth_count,
  COUNTIF(p.wealth_bracket = 'high') AS high_wealth_count,
  
  -- Insurance status
  COUNTIF(p.insurance_status = 'active') AS active_count,
  COUNTIF(p.insurance_status = 'inactive') AS inactive_count,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at

FROM person_dim p
INNER JOIN facts f USING (person_id)
WHERE p.city IS NOT NULL
GROUP BY
  p.city,
  p.postal_code,
  f.year
ORDER BY
  persons_in_city DESC
    );
  
[0m15:35:54.246754 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:35:54.247161 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:35:54.247387 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:35:54.641830 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:35:54.643595 [debug] [Thread-2 (]: On model.health_insurance_dbt.mart_person_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_person_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_person_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year DESC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS latest_year_cost,
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year ASC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS earliest_year_cost,
-- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:35:54.811543 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:6631a3bb-4bcf-4f82-a1e3-8e800f089987&page=queryresults
[0m15:35:54.824431 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:89f18286-c0d4-4b4d-87bc-cfe8f0d2bb55&page=queryresults
[0m15:35:54.919327 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:9a0bdcd5-b407-424c-b94a-0dcf5e84b996&page=queryresults
[0m15:35:54.974207 [error] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:89f18286-c0d4-4b4d-87bc-cfe8f0d2bb55&page=queryresults
[0m15:35:54.984740 [error] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:6631a3bb-4bcf-4f82-a1e3-8e800f089987&page=queryresults
[0m15:35:54.988934 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:77a86de9-82c9-48c7-9af6-e8024492e6fb&page=queryresults
[0m15:35:55.000037 [debug] [Thread-4 (]: Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:35:55.000763 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168d4bd70>]}
[0m15:35:55.004913 [debug] [Thread-3 (]: Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:35:55.004088 [error] [Thread-4 (]: 6 of 11 ERROR creating sql table model health_insurance_dev_marts.mart_city_year_kpis  [[31mERROR[0m in 0.77s]
[0m15:35:55.005474 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168ccfef0>]}
[0m15:35:55.006012 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:35:55.006560 [error] [Thread-3 (]: 8 of 11 ERROR creating sql table model health_insurance_dev_marts.mart_yearly_kpis  [[31mERROR[0m in 0.78s]
[0m15:35:55.007040 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.orphan_records
[0m15:35:55.007617 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.mart_city_year_kpis' to be skipped because of status 'error'.  Reason: Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql.
[0m15:35:55.008136 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:35:55.008639 [info ] [Thread-4 (]: 10 of 11 START sql view model health_insurance_dev.orphan_records .............. [RUN]
[0m15:35:55.010784 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m15:35:55.011332 [debug] [Thread-7 (]: Marking all children of 'model.health_insurance_dbt.mart_yearly_kpis' to be skipped because of status 'error'.  Reason: Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql.
[0m15:35:55.011763 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.mart_city_year_kpis, now model.health_insurance_dbt.orphan_records)
[0m15:35:55.012341 [info ] [Thread-3 (]: 11 of 11 START sql view model health_insurance_dev.visits_reasonable ........... [RUN]
[0m15:35:55.012904 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.orphan_records
[0m15:35:55.013308 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.mart_yearly_kpis, now model.health_insurance_dbt.visits_reasonable)
[0m15:35:55.015713 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.orphan_records"
[0m15:35:55.016026 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.visits_reasonable
[0m15:35:55.018769 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.visits_reasonable"
[0m15:35:55.019418 [debug] [Thread-4 (]: Began executing node model.health_insurance_dbt.orphan_records
[0m15:35:55.021500 [debug] [Thread-4 (]: Writing runtime sql for node "model.health_insurance_dbt.orphan_records"
[0m15:35:55.021826 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.visits_reasonable
[0m15:35:55.024116 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.visits_reasonable"
[0m15:35:55.024620 [debug] [Thread-4 (]: On model.health_insurance_dbt.orphan_records: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.orphan_records"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`orphan_records`
  OPTIONS()
  as -- Test: Flag orphan records in fact table (for monitoring)
-- This test warns if orphan records exist (not a hard failure)

SELECT
  person_id,
  year,
  'Fact record has no matching person in dim_person' AS issue
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE orphan_record = TRUE;


[0m15:35:55.024977 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:35:55.025258 [debug] [Thread-3 (]: On model.health_insurance_dbt.visits_reasonable: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.visits_reasonable"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`visits_reasonable`
  OPTIONS()
  as -- Test: Doctor visits should be between 0 and 365 per year
-- This test fails if values are outside reasonable bounds

SELECT
  person_id,
  year,
  annual_doctor_visits
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  annual_doctor_visits IS NOT NULL
  AND (annual_doctor_visits < 0 OR annual_doctor_visits > 365);


[0m15:35:55.026502 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:35:55.300611 [debug] [Thread-1 (]: SQL status: OK in 0.380 seconds
[0m15:35:55.305017 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168827f50>]}
[0m15:35:55.306179 [info ] [Thread-1 (]: 9 of 11 OK created sql view model health_insurance_dev.negative_costs .......... [[32mCREATE VIEW (0 processed)[0m in 1.08s]
[0m15:35:55.307312 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m15:35:55.456854 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:678f215c-36e9-4bcd-99d8-0d2be5fd3416&page=queryresults
[0m15:35:55.559631 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:5eff7001-397c-4df9-a095-30d16d882077&page=queryresults
[0m15:35:55.822613 [debug] [Thread-4 (]: SQL status: OK in 0.364 seconds
[0m15:35:55.826990 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1688269f0>]}
[0m15:35:55.828158 [info ] [Thread-4 (]: 10 of 11 OK created sql view model health_insurance_dev.orphan_records ......... [[32mCREATE VIEW (0 processed)[0m in 0.82s]
[0m15:35:55.829160 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.orphan_records
[0m15:35:55.891461 [debug] [Thread-3 (]: SQL status: OK in 0.331 seconds
[0m15:35:55.895499 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168cdcbf0>]}
[0m15:35:55.896790 [info ] [Thread-3 (]: 11 of 11 OK created sql view model health_insurance_dev.visits_reasonable ...... [[32mCREATE VIEW (0 processed)[0m in 0.88s]
[0m15:35:55.897687 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m15:35:56.837157 [debug] [Thread-2 (]: SQL status: OK in 1.848 seconds
[0m15:35:57.005639 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '33d767a5-bb43-4ebf-b524-2976cbd03c99', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1688276b0>]}
[0m15:35:57.006716 [info ] [Thread-2 (]: 7 of 11 OK created sql table model health_insurance_dev_marts.mart_person_kpis . [[32mCREATE TABLE (122.0 rows, 34.8 KiB processed)[0m in 2.78s]
[0m15:35:57.007501 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m15:35:57.009726 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:35:57.010706 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:35:57.011046 [debug] [MainThread]: Connection 'model.health_insurance_dbt.negative_costs' was properly closed.
[0m15:35:57.011304 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_person_kpis' was properly closed.
[0m15:35:57.011536 [debug] [MainThread]: Connection 'model.health_insurance_dbt.visits_reasonable' was properly closed.
[0m15:35:57.011766 [debug] [MainThread]: Connection 'model.health_insurance_dbt.orphan_records' was properly closed.
[0m15:35:57.012159 [info ] [MainThread]: 
[0m15:35:57.012493 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 6 view models in 0 hours 0 minutes and 13.36 seconds (13.36s).
[0m15:35:57.014714 [debug] [MainThread]: Command end result
[0m15:35:57.057562 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:35:57.087337 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:35:57.099472 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m15:35:57.099776 [info ] [MainThread]: 
[0m15:35:57.100034 [info ] [MainThread]: [31mCompleted with 2 errors, 0 partial successes, and 0 warnings:[0m
[0m15:35:57.100248 [info ] [MainThread]: 
[0m15:35:57.100507 [error] [MainThread]: [31mFailure in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)[0m
[0m15:35:57.100747 [error] [MainThread]:   Database Error in model mart_city_year_kpis (models/marts/mart_city_year_kpis.sql)
  Result of ORDER BY queries cannot be partitioned by field 'year'
  compiled code at target/run/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:35:57.101109 [info ] [MainThread]: 
[0m15:35:57.101880 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/marts/mart_city_year_kpis.sql
[0m15:35:57.102039 [info ] [MainThread]: 
[0m15:35:57.102261 [error] [MainThread]: [31mFailure in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)[0m
[0m15:35:57.102469 [error] [MainThread]:   Database Error in model mart_yearly_kpis (models/marts/mart_yearly_kpis.sql)
  Analytic functions cannot be arguments to aggregate functions at [60:3]
  compiled code at target/run/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:35:57.102612 [info ] [MainThread]: 
[0m15:35:57.102766 [info ] [MainThread]:   compiled code at target/compiled/health_insurance_dbt/models/marts/mart_yearly_kpis.sql
[0m15:35:57.102908 [info ] [MainThread]: 
[0m15:35:57.103081 [info ] [MainThread]: Done. PASS=9 WARN=0 ERROR=2 SKIP=0 NO-OP=0 TOTAL=11
[0m15:35:57.104114 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": false, "command_wall_clock_time": 31.072983, "process_in_blocks": "0", "process_kernel_time": 6.936012, "process_mem_max_rss": "418054144", "process_out_blocks": "0", "process_user_time": 10.65913}
[0m15:35:57.104457 [debug] [MainThread]: Command `dbt run` failed at 15:35:57.104402 after 31.07 seconds
[0m15:35:57.104797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x119c61d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1063940b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x168d63c50>]}
[0m15:35:57.104983 [debug] [MainThread]: Flushing usage events
[0m15:35:58.109216 [debug] [MainThread]: An error was encountered while trying to flush usage events
[0m15:37:28.678956 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10403ae40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055b3890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055b3b10>]}


============================== 15:37:28.684007 | 07c8fa2e-901f-4093-afef-e4efa1d0a867 ==============================
[0m15:37:28.684007 [info ] [MainThread]: Running with dbt=1.11.2
[0m15:37:28.684345 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'version_check': 'True', 'cache_selected_only': 'False', 'introspect': 'True', 'indirect_selection': 'eager', 'no_print': 'None', 'warn_error': 'None', 'log_path': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/logs', 'quiet': 'False', 'printer_width': '80', 'debug': 'False', 'target_path': 'None', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptionsV2(error=[], warn=[], silence=[])', 'invocation_command': 'dbt run --full-refresh', 'use_colors': 'True', 'partial_parse': 'True', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'fail_fast': 'False', 'profiles_dir': '/Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt', 'empty': 'False', 'static_parser': 'True'}
[0m15:37:42.226245 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10490e8b0>]}
[0m15:37:42.264273 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103e91370>]}
[0m15:37:42.264635 [info ] [MainThread]: Registered adapter: bigquery=1.11.0
[0m15:37:42.400730 [debug] [MainThread]: checksum: 3d40d8bbe1bef07db1c24822f2dbfff8bc07f2a48ed4fe2658a40653aec0b54b, vars: {}, profile: , target: , version: 1.11.2
[0m15:37:42.514801 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 2 files changed.
[0m15:37:42.515254 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/marts/mart_city_year_kpis.sql
[0m15:37:42.515469 [debug] [MainThread]: Partial parsing: updated file: health_insurance_dbt://models/marts/mart_yearly_kpis.sql
[0m15:37:42.780238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1292a4050>]}
[0m15:37:42.823693 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:37:42.825190 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:37:42.843122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x129413d40>]}
[0m15:37:42.843425 [info ] [MainThread]: Found 13 models, 32 data tests, 2 sources, 537 macros
[0m15:37:42.843606 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c31f4d0>]}
[0m15:37:42.844933 [info ] [MainThread]: 
[0m15:37:42.845135 [info ] [MainThread]: Concurrency: 4 threads (target='dev')
[0m15:37:42.845267 [info ] [MainThread]: 
[0m15:37:42.845530 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m15:37:42.847695 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:37:42.847954 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:37:42.848201 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:37:42.848559 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:37:42.848785 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:37:42.848967 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_dw-health-insurance-bipm'
[0m15:37:42.849155 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:37:42.849477 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m15:37:44.545129 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_staging)
[0m15:37:44.546828 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:37:44.547738 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev)
[0m15:37:44.549504 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_marts)
[0m15:37:44.550266 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:37:44.550828 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm, now list_dw-health-insurance-bipm_health_insurance_dev_core)
[0m15:37:44.551751 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:37:44.552921 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m15:37:44.997179 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c373860>]}
[0m15:37:44.998509 [debug] [MainThread]: Opening a new connection, currently in state init
[0m15:37:45.005001 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:37:45.005657 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:37:45.006481 [info ] [Thread-1 (]: 1 of 11 START sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [RUN]
[0m15:37:45.007298 [info ] [Thread-2 (]: 2 of 11 START sql view model health_insurance_dev_staging.stg_person_dim_raw ... [RUN]
[0m15:37:45.008014 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_staging, now model.health_insurance_dbt.stg_insurance_facts_raw)
[0m15:37:45.008527 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev, now model.health_insurance_dbt.stg_person_dim_raw)
[0m15:37:45.009024 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:37:45.009478 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.stg_person_dim_raw
[0m15:37:45.020963 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:37:45.025824 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:37:45.026991 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.stg_person_dim_raw
[0m15:37:45.039166 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:37:45.055375 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_person_dim_raw"
[0m15:37:45.057332 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.stg_insurance_facts_raw"
[0m15:37:45.058328 [debug] [Thread-2 (]: On model.health_insurance_dbt.stg_person_dim_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_person_dim_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
  OPTIONS()
  as 

-- Light cleaning and selection of raw person dimension data
-- No deduplication at this stage

SELECT
  TRIM(Person_id) AS person_id,
  TRIM(birthdate) AS birthdate_raw,
  TRIM(address) AS address_raw,
  TRIM(gender) AS gender_raw,
  TRIM(family_status) AS family_status_raw,
  TRIM(insurance_status) AS insurance_status_raw,
  TRIM(insurance_sign_up_date) AS insurance_sign_up_date_raw,
  TRIM(occupational_category) AS occupational_category_raw,
  TRIM(wealth_bracket) AS wealth_bracket_raw
FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_person_dim_raw`
WHERE Person_id IS NOT NULL;


[0m15:37:45.058755 [debug] [Thread-1 (]: On model.health_insurance_dbt.stg_insurance_facts_raw: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.stg_insurance_facts_raw"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
  OPTIONS()
  as 

-- Light cleaning and safe type casting of raw insurance facts
-- Preserve all records with parse error flags

WITH source AS (
  SELECT
    TRIM(Person_id) AS person_id,
    insurance_cost_year,
    annual_doctor_visits,
    annual_cost_to_insurance,
    year
  FROM `dw-health-insurance-bipm`.`health_insurance_raw`.`health_insurance_insurance_facts_raw`
  WHERE Person_id IS NOT NULL
)

SELECT
  person_id,
  
  -- Safe numeric conversions with error flags
  SAFE_CAST(insurance_cost_year AS NUMERIC) AS insurance_cost_year,
  CASE WHEN SAFE_CAST(insurance_cost_year AS NUMERIC) IS NULL 
       AND insurance_cost_year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_cost_year_parse_error,
  
  SAFE_CAST(annual_doctor_visits AS INT64) AS annual_doctor_visits,
  CASE WHEN SAFE_CAST(annual_doctor_visits AS INT64) IS NULL 
       AND annual_doctor_visits IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_doctor_visits_parse_error,
  
  SAFE_CAST(annual_cost_to_insurance AS NUMERIC) AS annual_cost_to_insurance,
  CASE WHEN SAFE_CAST(annual_cost_to_insurance AS NUMERIC) IS NULL 
       AND annual_cost_to_insurance IS NOT NULL 
       THEN TRUE ELSE FALSE END AS annual_cost_to_insurance_parse_error,
  
  SAFE_CAST(year AS INT64) AS year,
  CASE WHEN SAFE_CAST(year AS INT64) IS NULL 
       AND year IS NOT NULL 
       THEN TRUE ELSE FALSE END AS year_parse_error

FROM source;


[0m15:37:45.059224 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:37:45.059528 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:37:46.196905 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:5f17a1df-5ba0-43d6-a619-5bb0a27c8d01&page=queryresults
[0m15:37:46.198328 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:ab31fc78-c6d7-4109-9415-9adc11e4e8f6&page=queryresults
[0m15:37:46.522810 [debug] [Thread-2 (]: SQL status: OK in 0.324 seconds
[0m15:37:46.539241 [debug] [Thread-1 (]: SQL status: OK in 0.339 seconds
[0m15:37:46.620363 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c37ebd0>]}
[0m15:37:46.620586 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c8dc100>]}
[0m15:37:46.620934 [info ] [Thread-2 (]: 2 of 11 OK created sql view model health_insurance_dev_staging.stg_person_dim_raw  [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m15:37:46.621542 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.stg_person_dim_raw
[0m15:37:46.621224 [info ] [Thread-1 (]: 1 of 11 OK created sql view model health_insurance_dev_staging.stg_insurance_facts_raw  [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m15:37:46.621913 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.stg_insurance_facts_raw
[0m15:37:46.622155 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.int_person_cleaned
[0m15:37:46.622337 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.int_person_deduped
[0m15:37:46.622520 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_marts, now model.health_insurance_dbt.int_person_cleaned)
[0m15:37:46.622714 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly list_dw-health-insurance-bipm_health_insurance_dev_core, now model.health_insurance_dbt.int_person_deduped)
[0m15:37:46.622881 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.int_person_cleaned
[0m15:37:46.623033 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.int_person_deduped
[0m15:37:46.625035 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_cleaned"
[0m15:37:46.627174 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.int_person_deduped"
[0m15:37:46.628148 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:37:46.628349 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:37:46.628781 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.int_person_cleaned
[0m15:37:46.629185 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.int_person_deduped
[0m15:37:46.629632 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.dim_person
[0m15:37:46.629925 [info ] [Thread-2 (]: 3 of 11 START sql table model health_insurance_dev_core.dim_person ............. [RUN]
[0m15:37:46.630183 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_person_dim_raw, now model.health_insurance_dbt.dim_person)
[0m15:37:46.630357 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.dim_person
[0m15:37:46.635460 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.dim_person"
[0m15:37:46.636594 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.dim_person
[0m15:37:46.643523 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:37:47.104778 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.dim_person"
[0m15:37:47.106072 [debug] [Thread-2 (]: On model.health_insurance_dbt.dim_person: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.dim_person"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Conformed person dimension (SCD Type 1)
-- Grain: One row per person_id
-- Business key: person_id

WITH  __dbt__cte__int_person_deduped as (


-- Parse dates, standardize categories, extract address components
-- Each raw row is cleaned but duplicates remain

WITH source AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_person_dim_raw`
),

-- Date parsing logic for birthdate
birthdate_parsed AS (
  SELECT
    person_id,
    birthdate_raw,
    
    -- Try multiple date formats
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', birthdate_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', birthdate_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', birthdate_raw),
      
      -- Slash format with heuristic (birthdate defaults to MM/DD/...)
      CASE
        -- Check if it's a slash-delimited date
        WHEN REGEXP_CONTAINS(birthdate_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            -- Extract parts
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to MM/DD/... for birthdate
              CASE
                WHEN LENGTH(SPLIT(birthdate_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', birthdate_raw)
                ELSE
                  -- 2-digit year
                  CASE
                    WHEN SAFE_CAST(SPLIT(birthdate_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/20' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(birthdate_raw, '/' || SPLIT(birthdate_raw, '/')[OFFSET(2)], '/19' || SPLIT(birthdate_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS birthdate_parsed
  FROM source
),

-- Date parsing logic for insurance_sign_up_date
signup_date_parsed AS (
  SELECT
    person_id,
    insurance_sign_up_date_raw,
    
    COALESCE(
      -- ISO format: YYYY-MM-DD
      SAFE.PARSE_DATE('%Y-%m-%d', insurance_sign_up_date_raw),
      
      -- Dot format: DD.MM.YYYY
      SAFE.PARSE_DATE('%d.%m.%Y', insurance_sign_up_date_raw),
      
      -- Dash format: DD-MM-YYYY
      SAFE.PARSE_DATE('%d-%m-%Y', insurance_sign_up_date_raw),
      
      -- Slash format with heuristic (signup defaults to DD/MM/...)
      CASE
        WHEN REGEXP_CONTAINS(insurance_sign_up_date_raw, r'^\d{1,2}/\d{1,2}/\d{2,4}$') THEN
          CASE
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(1)] AS INT64) > 12 THEN
              -- Second part > 12, must be MM/DD/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%m/%d/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%m/%d/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(0)] AS INT64) > 12 THEN
              -- First part > 12, must be DD/MM/...
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
            
            ELSE
              -- Ambiguous: default to DD/MM/... for signup date
              CASE
                WHEN LENGTH(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]) = 4 THEN
                  SAFE.PARSE_DATE('%d/%m/%Y', insurance_sign_up_date_raw)
                ELSE
                  CASE
                    WHEN SAFE_CAST(SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)] AS INT64) BETWEEN 0 AND 29 THEN
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/20' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                    ELSE
                      SAFE.PARSE_DATE('%d/%m/%y', REPLACE(insurance_sign_up_date_raw, '/' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)], '/19' || SPLIT(insurance_sign_up_date_raw, '/')[OFFSET(2)]))
                  END
              END
          END
      END
    ) AS insurance_sign_up_date_parsed
  FROM source
),

-- Address parsing
address_parsed AS (
  SELECT
    person_id,
    address_raw,
    REGEXP_REPLACE(TRIM(address_raw), r'\s+', ' ') AS address_clean,
    REGEXP_EXTRACT(address_raw, r'\b(\d{5})\b') AS postal_code,
    INITCAP(TRIM(REGEXP_EXTRACT(address_raw, r'\d{5}\s+(.+)$'))) AS city,
    TRIM(SPLIT(address_raw, ',')[SAFE_OFFSET(0)]) AS street_and_number
  FROM source
)

-- Final cleaned output
SELECT
  s.person_id,
  
  -- Dates with parse error flags
  bd.birthdate_parsed,
  CASE WHEN bd.birthdate_parsed IS NULL AND s.birthdate_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS birthdate_parse_error,
  
  sd.insurance_sign_up_date_parsed,
  CASE WHEN sd.insurance_sign_up_date_parsed IS NULL AND s.insurance_sign_up_date_raw IS NOT NULL 
       THEN TRUE ELSE FALSE END AS insurance_sign_up_date_parse_error,
  
  -- Address components
  ap.address_raw,
  ap.address_clean,
  ap.postal_code,
  ap.city,
  ap.street_and_number,
  
  -- Standardized gender
  CASE
    WHEN UPPER(TRIM(s.gender_raw)) IN ('M', 'MALE') THEN 'male'
    WHEN UPPER(TRIM(s.gender_raw)) IN ('F', 'FEMALE') THEN 'female'
    ELSE 'unknown'
  END AS gender_std,
  
  -- Standardized family status
  CASE
    WHEN UPPER(TRIM(s.family_status_raw)) = 'SINGLE' THEN 'single'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'MARRIED' THEN 'married'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'DIVORCED' THEN 'divorced'
    WHEN UPPER(TRIM(s.family_status_raw)) = 'WIDOWED' THEN 'widowed'
    ELSE 'unknown'
  END AS family_status_std,
  
  -- Standardized insurance status
  CASE
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'ACTIVE' THEN 'active'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'INACTIVE' THEN 'inactive'
    WHEN UPPER(TRIM(s.insurance_status_raw)) = 'PENDING' THEN 'pending'
    ELSE 'unknown'
  END AS insurance_status_std,
  
  -- Cleaned occupational category
  CASE 
    WHEN TRIM(s.occupational_category_raw) = '' THEN NULL
    ELSE TRIM(s.occupational_category_raw)
  END AS occupational_category_clean,
  
  -- Standardized wealth bracket
  CASE
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('LOW', 'LOWER') THEN 'low'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) = 'MEDIUM' THEN 'medium'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('UPPER_MIDDLE', 'UPPER MIDDLE', 'UPPERMIDDLE') THEN 'upper_middle'
    WHEN UPPER(TRIM(s.wealth_bracket_raw)) IN ('HIGH', 'UPPER') THEN 'high'
    ELSE 'unknown'
  END AS wealth_bracket_std

FROM source s
LEFT JOIN birthdate_parsed bd USING (person_id)
LEFT JOIN signup_date_parsed sd USING (person_id)
LEFT JOIN address_parsed ap USING (person_id)
), deduped AS (
  SELECT * FROM __dbt__cte__int_person_deduped
)

SELECT
  person_id,
  
  -- Demographic attributes
  birthdate_parsed AS birthdate,
  CASE 
    WHEN birthdate_parsed IS NOT NULL 
    THEN DATE_DIFF(CURRENT_DATE(), birthdate_parsed, YEAR)
    ELSE NULL 
  END AS age_years,
  gender_std AS gender,
  family_status_std AS family_status,
  
  -- Insurance attributes
  insurance_status_std AS insurance_status,
  insurance_sign_up_date_parsed AS insurance_sign_up_date,
  EXTRACT(YEAR FROM insurance_sign_up_date_parsed) AS signup_year,
  FORMAT_DATE('%Y-%m', insurance_sign_up_date_parsed) AS signup_month,
  
  -- Economic attributes
  occupational_category_clean AS occupational_category,
  wealth_bracket_std AS wealth_bracket,
  
  -- Address attributes
  address_clean AS address,
  street_and_number,
  postal_code,
  city,
  
  -- Data quality flags
  birthdate_parse_error,
  insurance_sign_up_date_parse_error,
  CURRENT_TIMESTAMP() AS dim_updated_at

FROM deduped
    );
  
[0m15:37:47.920896 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:3068facd-1f3a-45ee-93f9-9ecd1bed9251&page=queryresults
[0m15:37:50.185341 [debug] [Thread-2 (]: SQL status: OK in 2.263 seconds
[0m15:37:50.413271 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c984a50>]}
[0m15:37:50.414904 [info ] [Thread-2 (]: 3 of 11 OK created sql table model health_insurance_dev_core.dim_person ........ [[32mCREATE TABLE (166.0 rows, 12.4 KiB processed)[0m in 3.78s]
[0m15:37:50.416045 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.dim_person
[0m15:37:50.417344 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:37:50.417891 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.parse_error_rate
[0m15:37:50.418637 [info ] [Thread-1 (]: 4 of 11 START sql incremental model health_insurance_dev_core.fact_insurance_yearly  [RUN]
[0m15:37:50.419385 [info ] [Thread-3 (]: 5 of 11 START sql view model health_insurance_dev.parse_error_rate ............. [RUN]
[0m15:37:50.420041 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.stg_insurance_facts_raw, now model.health_insurance_dbt.fact_insurance_yearly)
[0m15:37:50.420566 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_cleaned, now model.health_insurance_dbt.parse_error_rate)
[0m15:37:50.421097 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.fact_insurance_yearly
[0m15:37:50.421677 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.parse_error_rate
[0m15:37:50.437335 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.parse_error_rate"
[0m15:37:50.438908 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:37:50.440857 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.fact_insurance_yearly
[0m15:37:50.441272 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.parse_error_rate
[0m15:37:50.456397 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.parse_error_rate"
[0m15:37:50.468458 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:37:50.469315 [debug] [Thread-3 (]: On model.health_insurance_dbt.parse_error_rate: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.parse_error_rate"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`parse_error_rate`
  OPTIONS()
  as -- Test: Parse error rate should be below threshold (5%)
-- This test fails if too many records have parse errors

WITH error_counts AS (
  SELECT
    COUNT(*) AS total_records,
    SUM(CASE WHEN birthdate_parse_error THEN 1 ELSE 0 END) AS birthdate_errors,
    SUM(CASE WHEN insurance_sign_up_date_parse_error THEN 1 ELSE 0 END) AS signup_date_errors
  FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
),

error_rates AS (
  SELECT
    total_records,
    birthdate_errors,
    signup_date_errors,
    ROUND(100.0 * birthdate_errors / NULLIF(total_records, 0), 2) AS birthdate_error_pct,
    ROUND(100.0 * signup_date_errors / NULLIF(total_records, 0), 2) AS signup_date_error_pct
  FROM error_counts
)

-- Fail if error rate exceeds 5%
SELECT
  'birthdate' AS field,
  birthdate_errors AS error_count,
  total_records,
  birthdate_error_pct AS error_rate_pct
FROM error_rates
WHERE birthdate_error_pct > 5

UNION ALL

SELECT
  'insurance_sign_up_date' AS field,
  signup_date_errors AS error_count,
  total_records,
  signup_date_error_pct AS error_rate_pct
FROM error_rates
WHERE signup_date_error_pct > 5;


[0m15:37:50.469674 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:37:50.911084 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.fact_insurance_yearly"
[0m15:37:50.912719 [debug] [Thread-1 (]: On model.health_insurance_dbt.fact_insurance_yearly: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.fact_insurance_yearly"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Insurance facts by person and year
-- Grain: One row per person_id + year
-- Incremental strategy: Merge on (person_id, year)

WITH facts_raw AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_staging`.`stg_insurance_facts_raw`
),

person_dim AS (
  SELECT person_id FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  f.person_id,
  f.year,
  
  -- Metrics
  f.insurance_cost_year,
  f.annual_doctor_visits,
  f.annual_cost_to_insurance,
  
  -- Data quality flags
  f.insurance_cost_year_parse_error,
  f.annual_doctor_visits_parse_error,
  f.annual_cost_to_insurance_parse_error,
  f.year_parse_error,
  
  -- Referential integrity check
  CASE WHEN p.person_id IS NULL THEN TRUE ELSE FALSE END AS orphan_record,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS fact_updated_at

FROM facts_raw f
LEFT JOIN person_dim p USING (person_id)

WHERE f.year IS NOT NULL
  AND f.person_id IS NOT NULL


    );
  
[0m15:37:51.146680 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:7b95cc25-0f6b-4254-b44a-5cba506c1b6d&page=queryresults
[0m15:37:51.526573 [debug] [Thread-3 (]: SQL status: OK in 0.379 seconds
[0m15:37:51.531850 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c801150>]}
[0m15:37:51.533361 [info ] [Thread-3 (]: 5 of 11 OK created sql view model health_insurance_dev.parse_error_rate ........ [[32mCREATE VIEW (0 processed)[0m in 1.11s]
[0m15:37:51.534387 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.parse_error_rate
[0m15:37:51.671055 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:479a2628-c4e2-428b-9610-ff68a270de4d&page=queryresults
[0m15:37:53.614370 [debug] [Thread-1 (]: SQL status: OK in 1.942 seconds
[0m15:37:53.825941 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c5d2c10>]}
[0m15:37:53.827792 [info ] [Thread-1 (]: 4 of 11 OK created sql incremental model health_insurance_dev_core.fact_insurance_yearly  [[32mCREATE TABLE (500.0 rows, 12.7 KiB processed)[0m in 3.41s]
[0m15:37:53.828989 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.fact_insurance_yearly
[0m15:37:53.830610 [debug] [Thread-2 (]: Began running node model.health_insurance_dbt.mart_person_kpis
[0m15:37:53.831239 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.negative_costs
[0m15:37:53.831777 [debug] [Thread-3 (]: Began running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:37:53.832199 [debug] [Thread-4 (]: Began running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:37:53.832773 [info ] [Thread-2 (]: 7 of 11 START sql table model health_insurance_dev_marts.mart_person_kpis ...... [RUN]
[0m15:37:53.833627 [info ] [Thread-1 (]: 9 of 11 START sql view model health_insurance_dev.negative_costs ............... [RUN]
[0m15:37:53.834488 [info ] [Thread-3 (]: 8 of 11 START sql table model health_insurance_dev_marts.mart_yearly_kpis ...... [RUN]
[0m15:37:53.835512 [info ] [Thread-4 (]: 6 of 11 START sql table model health_insurance_dev_marts.mart_city_year_kpis ... [RUN]
[0m15:37:53.836292 [debug] [Thread-2 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.dim_person, now model.health_insurance_dbt.mart_person_kpis)
[0m15:37:53.836833 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.fact_insurance_yearly, now model.health_insurance_dbt.negative_costs)
[0m15:37:53.837304 [debug] [Thread-3 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.parse_error_rate, now model.health_insurance_dbt.mart_yearly_kpis)
[0m15:37:53.837774 [debug] [Thread-4 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.int_person_deduped, now model.health_insurance_dbt.mart_city_year_kpis)
[0m15:37:53.838266 [debug] [Thread-2 (]: Began compiling node model.health_insurance_dbt.mart_person_kpis
[0m15:37:53.838734 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.negative_costs
[0m15:37:53.839152 [debug] [Thread-3 (]: Began compiling node model.health_insurance_dbt.mart_yearly_kpis
[0m15:37:53.839595 [debug] [Thread-4 (]: Began compiling node model.health_insurance_dbt.mart_city_year_kpis
[0m15:37:53.846054 [debug] [Thread-2 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:37:53.849096 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.negative_costs"
[0m15:37:53.852345 [debug] [Thread-3 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:37:53.863188 [debug] [Thread-4 (]: Writing injected SQL for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:37:53.864488 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.negative_costs
[0m15:37:53.864812 [debug] [Thread-4 (]: Began executing node model.health_insurance_dbt.mart_city_year_kpis
[0m15:37:53.865128 [debug] [Thread-2 (]: Began executing node model.health_insurance_dbt.mart_person_kpis
[0m15:37:53.865406 [debug] [Thread-3 (]: Began executing node model.health_insurance_dbt.mart_yearly_kpis
[0m15:37:53.867438 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.negative_costs"
[0m15:37:54.094101 [debug] [Thread-4 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_city_year_kpis"
[0m15:37:54.095133 [debug] [Thread-2 (]: Opening a new connection, currently in state closed
[0m15:37:54.096307 [debug] [Thread-3 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_yearly_kpis"
[0m15:37:54.097202 [debug] [Thread-1 (]: On model.health_insurance_dbt.negative_costs: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.negative_costs"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`negative_costs`
  OPTIONS()
  as -- Test: No negative costs in fact table
-- This test fails if any negative values exist in cost columns

SELECT
  person_id,
  year,
  insurance_cost_year,
  annual_cost_to_insurance
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  (insurance_cost_year < 0 AND insurance_cost_year IS NOT NULL)
  OR (annual_cost_to_insurance < 0 AND annual_cost_to_insurance IS NOT NULL);


[0m15:37:54.097507 [debug] [Thread-4 (]: On model.health_insurance_dbt.mart_city_year_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_city_year_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_city_year_kpis`
      
    partition by range_bucket(
            year,
            generate_array(2020, 2030, 1)
        )
    cluster by city

    
    OPTIONS()
    as (
      

-- City-level yearly aggregations for geographic analysis
-- Grain: One row per city + year
-- BI Use: Regional performance, geographic segmentation, market analysis

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  COALESCE(p.city, 'Unknown') AS city,
  p.postal_code,
  f.year,
  
  -- Volume metrics
  COUNT(DISTINCT f.person_id) AS persons_in_city,
  
  -- Cost aggregates
  SUM(f.insurance_cost_year) AS total_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS total_cost_to_insurance,
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_person,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_person,
  
  -- Visit aggregates
  SUM(f.annual_doctor_visits) AS total_doctor_visits,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_person,
  
  -- Demographics
  AVG(p.age_years) AS avg_age,
  COUNTIF(p.gender = 'male') AS male_count,
  COUNTIF(p.gender = 'female') AS female_count,
  
  -- Wealth distribution
  COUNTIF(p.wealth_bracket = 'low') AS low_wealth_count,
  COUNTIF(p.wealth_bracket = 'medium') AS medium_wealth_count,
  COUNTIF(p.wealth_bracket = 'upper_middle') AS upper_middle_wealth_count,
  COUNTIF(p.wealth_bracket = 'high') AS high_wealth_count,
  
  -- Insurance status
  COUNTIF(p.insurance_status = 'active') AS active_count,
  COUNTIF(p.insurance_status = 'inactive') AS inactive_count,
  
  -- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at

FROM person_dim p
INNER JOIN facts f USING (person_id)
WHERE p.city IS NOT NULL
GROUP BY
  p.city,
  p.postal_code,
  f.year
    );
  
[0m15:37:54.098001 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:37:54.098271 [debug] [Thread-3 (]: On model.health_insurance_dbt.mart_yearly_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_yearly_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_yearly_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year DESC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS latest_year_cost,
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year ASC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS earliest_year_cost,
  -- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:37:54.098528 [debug] [Thread-4 (]: Opening a new connection, currently in state closed
[0m15:37:54.099067 [debug] [Thread-3 (]: Opening a new connection, currently in state closed
[0m15:37:54.467206 [debug] [Thread-2 (]: Writing runtime sql for node "model.health_insurance_dbt.mart_person_kpis"
[0m15:37:54.470256 [debug] [Thread-2 (]: On model.health_insurance_dbt.mart_person_kpis: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.mart_person_kpis"} */

  
    

    create or replace table `dw-health-insurance-bipm`.`health_insurance_dev_marts`.`mart_person_kpis`
      
    
    cluster by person_id

    
    OPTIONS()
    as (
      

-- Person-level KPIs aggregated across all years
-- Grain: One row per person_id
-- BI Use: Customer 360 view, lifetime value analysis, customer segmentation

WITH facts AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
  WHERE NOT orphan_record  -- Exclude orphan records
),

person_dim AS (
  SELECT * FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`dim_person`
)

SELECT
  p.person_id,
  
  -- Demographic context
  p.gender,
  p.age_years,
  p.family_status,
  p.wealth_bracket,
  p.city,
  p.insurance_status,
  
  -- Temporal coverage
  MIN(f.year) AS first_data_year,
  MAX(f.year) AS last_data_year,
  COUNT(DISTINCT f.year) AS years_with_data,
  
  -- Lifetime aggregates
  SUM(f.insurance_cost_year) AS lifetime_insurance_cost,
  SUM(f.annual_cost_to_insurance) AS lifetime_cost_to_insurance,
  SUM(f.annual_doctor_visits) AS lifetime_doctor_visits,
  
  -- Averages
  AVG(f.insurance_cost_year) AS avg_insurance_cost_per_year,
  AVG(f.annual_cost_to_insurance) AS avg_cost_to_insurance_per_year,
  AVG(f.annual_doctor_visits) AS avg_doctor_visits_per_year,
  
  -- Volatility (stddev)
  STDDEV(f.annual_cost_to_insurance) AS stddev_cost_to_insurance,
  STDDEV(f.annual_doctor_visits) AS stddev_doctor_visits,
  
  -- Trends (most recent vs earliest year)
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year DESC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS latest_year_cost,
  ARRAY_AGG(
    f.annual_cost_to_insurance IGNORE NULLS
    ORDER BY f.year ASC
    LIMIT 1
  )[SAFE_OFFSET(0)] AS earliest_year_cost,
-- Metadata
  CURRENT_TIMESTAMP() AS mart_updated_at
FROM person_dim p
LEFT JOIN facts f USING (person_id)
GROUP BY
p.person_id,
p.gender,
p.age_years,
p.family_status,
p.wealth_bracket,
p.city,
p.insurance_status
    );
  
[0m15:37:54.702225 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:658f4947-1f8b-4073-97ee-31585396a9ca&page=queryresults
[0m15:37:54.760174 [debug] [Thread-4 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:92abe79d-46e7-47e2-8129-fb521fd3aff7&page=queryresults
[0m15:37:54.789084 [debug] [Thread-3 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:11690b35-77d6-43d4-a82b-8a45d2bed1e8&page=queryresults
[0m15:37:55.043626 [debug] [Thread-1 (]: SQL status: OK in 0.339 seconds
[0m15:37:55.048835 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c897d70>]}
[0m15:37:55.049891 [info ] [Thread-1 (]: 9 of 11 OK created sql view model health_insurance_dev.negative_costs .......... [[32mCREATE VIEW (0 processed)[0m in 1.21s]
[0m15:37:55.050761 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.negative_costs
[0m15:37:55.051283 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.orphan_records
[0m15:37:55.051915 [info ] [Thread-1 (]: 10 of 11 START sql view model health_insurance_dev.orphan_records .............. [RUN]
[0m15:37:55.052826 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.negative_costs, now model.health_insurance_dbt.orphan_records)
[0m15:37:55.053842 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.orphan_records
[0m15:37:55.058534 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.orphan_records"
[0m15:37:55.060001 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.orphan_records
[0m15:37:55.064308 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.orphan_records"
[0m15:37:55.065489 [debug] [Thread-1 (]: On model.health_insurance_dbt.orphan_records: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.orphan_records"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`orphan_records`
  OPTIONS()
  as -- Test: Flag orphan records in fact table (for monitoring)
-- This test warns if orphan records exist (not a hard failure)

SELECT
  person_id,
  year,
  'Fact record has no matching person in dim_person' AS issue
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE orphan_record = TRUE;


[0m15:37:55.065765 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:37:55.077194 [debug] [Thread-2 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:971a542b-260d-4c64-aef1-e6930b8549fc&page=queryresults
[0m15:37:55.714160 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:77c13e0e-9a90-4b12-8b70-f203cab59cdd&page=queryresults
[0m15:37:56.083839 [debug] [Thread-1 (]: SQL status: OK in 0.368 seconds
[0m15:37:56.087978 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c284a70>]}
[0m15:37:56.089134 [info ] [Thread-1 (]: 10 of 11 OK created sql view model health_insurance_dev.orphan_records ......... [[32mCREATE VIEW (0 processed)[0m in 1.04s]
[0m15:37:56.090130 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.orphan_records
[0m15:37:56.090716 [debug] [Thread-1 (]: Began running node model.health_insurance_dbt.visits_reasonable
[0m15:37:56.091962 [info ] [Thread-1 (]: 11 of 11 START sql view model health_insurance_dev.visits_reasonable ........... [RUN]
[0m15:37:56.092797 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.health_insurance_dbt.orphan_records, now model.health_insurance_dbt.visits_reasonable)
[0m15:37:56.093318 [debug] [Thread-1 (]: Began compiling node model.health_insurance_dbt.visits_reasonable
[0m15:37:56.098000 [debug] [Thread-1 (]: Writing injected SQL for node "model.health_insurance_dbt.visits_reasonable"
[0m15:37:56.099385 [debug] [Thread-1 (]: Began executing node model.health_insurance_dbt.visits_reasonable
[0m15:37:56.102653 [debug] [Thread-1 (]: Writing runtime sql for node "model.health_insurance_dbt.visits_reasonable"
[0m15:37:56.103571 [debug] [Thread-1 (]: On model.health_insurance_dbt.visits_reasonable: /* {"app": "dbt", "dbt_version": "1.11.2", "profile_name": "health_insurance", "target_name": "dev", "node_id": "model.health_insurance_dbt.visits_reasonable"} */


  create or replace view `dw-health-insurance-bipm`.`health_insurance_dev`.`visits_reasonable`
  OPTIONS()
  as -- Test: Doctor visits should be between 0 and 365 per year
-- This test fails if values are outside reasonable bounds

SELECT
  person_id,
  year,
  annual_doctor_visits
FROM `dw-health-insurance-bipm`.`health_insurance_dev_core`.`fact_insurance_yearly`
WHERE
  annual_doctor_visits IS NOT NULL
  AND (annual_doctor_visits < 0 OR annual_doctor_visits > 365);


[0m15:37:56.104056 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m15:37:56.658669 [debug] [Thread-4 (]: SQL status: OK in 1.896 seconds
[0m15:37:56.686115 [debug] [Thread-1 (]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=dw-health-insurance-bipm&j=bq:EU:a1431f8c-a572-4c15-9045-68c4ab70ce35&page=queryresults
[0m15:37:56.830373 [debug] [Thread-4 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1291c49b0>]}
[0m15:37:56.831734 [info ] [Thread-4 (]: 6 of 11 OK created sql table model health_insurance_dev_marts.mart_city_year_kpis  [[32mCREATE TABLE (159.0 rows, 34.5 KiB processed)[0m in 2.99s]
[0m15:37:56.833236 [debug] [Thread-4 (]: Finished running node model.health_insurance_dbt.mart_city_year_kpis
[0m15:37:57.001648 [debug] [Thread-1 (]: SQL status: OK in 0.314 seconds
[0m15:37:57.006276 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x128e27590>]}
[0m15:37:57.007614 [info ] [Thread-1 (]: 11 of 11 OK created sql view model health_insurance_dev.visits_reasonable ...... [[32mCREATE VIEW (0 processed)[0m in 0.91s]
[0m15:37:57.009111 [debug] [Thread-1 (]: Finished running node model.health_insurance_dbt.visits_reasonable
[0m15:37:57.171439 [debug] [Thread-2 (]: SQL status: OK in 2.093 seconds
[0m15:37:57.218957 [debug] [Thread-3 (]: SQL status: OK in 2.429 seconds
[0m15:37:57.384693 [debug] [Thread-2 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c897ef0>]}
[0m15:37:57.386027 [info ] [Thread-2 (]: 7 of 11 OK created sql table model health_insurance_dev_marts.mart_person_kpis . [[32mCREATE TABLE (122.0 rows, 34.8 KiB processed)[0m in 3.55s]
[0m15:37:57.386980 [debug] [Thread-2 (]: Finished running node model.health_insurance_dbt.mart_person_kpis
[0m15:37:57.422465 [debug] [Thread-3 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '07c8fa2e-901f-4093-afef-e4efa1d0a867', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c897ef0>]}
[0m15:37:57.422994 [info ] [Thread-3 (]: 8 of 11 OK created sql table model health_insurance_dev_marts.mart_yearly_kpis . [[32mCREATE TABLE (122.0 rows, 34.8 KiB processed)[0m in 3.59s]
[0m15:37:57.423324 [debug] [Thread-3 (]: Finished running node model.health_insurance_dbt.mart_yearly_kpis
[0m15:37:57.424177 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m15:37:57.424503 [debug] [MainThread]: Connection 'master' was properly closed.
[0m15:37:57.424646 [debug] [MainThread]: Connection 'model.health_insurance_dbt.visits_reasonable' was properly closed.
[0m15:37:57.424768 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_person_kpis' was properly closed.
[0m15:37:57.424880 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_yearly_kpis' was properly closed.
[0m15:37:57.424988 [debug] [MainThread]: Connection 'model.health_insurance_dbt.mart_city_year_kpis' was properly closed.
[0m15:37:57.425164 [info ] [MainThread]: 
[0m15:37:57.425312 [info ] [MainThread]: Finished running 1 incremental model, 4 table models, 6 view models in 0 hours 0 minutes and 14.58 seconds (14.58s).
[0m15:37:57.426478 [debug] [MainThread]: Command end result
[0m15:37:57.460306 [debug] [MainThread]: Wrote artifact WritableManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/manifest.json
[0m15:37:57.462214 [debug] [MainThread]: Wrote artifact SemanticManifest to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/semantic_manifest.json
[0m15:37:57.466614 [debug] [MainThread]: Wrote artifact RunExecutionResult to /Users/nikolasjackaltran/Desktop/HWR/DWH/health_insurance_dbt/target/run_results.json
[0m15:37:57.466944 [info ] [MainThread]: 
[0m15:37:57.467325 [info ] [MainThread]: [32mCompleted successfully[0m
[0m15:37:57.467574 [info ] [MainThread]: 
[0m15:37:57.467839 [info ] [MainThread]: Done. PASS=11 WARN=0 ERROR=0 SKIP=0 NO-OP=0 TOTAL=11
[0m15:37:57.468221 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 28.83833, "process_in_blocks": "0", "process_kernel_time": 5.801126, "process_mem_max_rss": "428638208", "process_out_blocks": "0", "process_user_time": 10.457782}
[0m15:37:57.468439 [debug] [MainThread]: Command `dbt run` succeeded at 15:37:57.468397 after 28.84 seconds
[0m15:37:57.468621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103f89e50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c967830>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x13c967d70>]}
[0m15:37:57.468803 [debug] [MainThread]: Flushing usage events
[0m15:37:58.539642 [debug] [MainThread]: An error was encountered while trying to flush usage events
